<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramenta de Cálculo de Importação v30.3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.0.0-rc.7/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --bg-color: #1a1a1a;
            --text-color: #ecf0f1;
            --card-bg-color: #2c3e50;
            --border-color: #34495e;
            --input-bg-color: #34495e;
            --header-bg-color: #1f2a38;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        h1, h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
        }

        h1 .logo {
            height: 40px;
            margin-right: 15px;
        }

        .card {
            background-color: var(--card-bg-color);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        input, select {
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            font-size: 1em;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-weight: bold;
        }
        button:hover { background-color: #2980b9; }
        button.add-item { background-color: var(--secondary-color); }
        button.add-item:hover { background-color: #27ae60; }
        button.calculate { font-size: 1.2em; padding: 15px; grid-column: 1 / -1; }
        button.calculate:hover { background-color: #2980b9; }
        button.delete-item { background-color: var(--danger-color); }
        button.delete-item:hover { background-color: #c0392b; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
        }
        thead { background-color: var(--header-bg-color); }
        th { font-weight: bold; }
        tbody tr:nth-child(even) { background-color: #34495e; }
        tbody tr:hover { background-color: #4a627a; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .dashboard-item {
            background-color: #34495e;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .dashboard-item h3 { margin-top: 0; color: var(--secondary-color); }
        .dashboard-item p { font-size: 1.8em; margin: 10px 0 0 0; font-weight: bold; }
        .chart-container {
            position: relative;
            height: 350px;
            grid-column: 1 / -1;
            padding: 20px;
            background-color: #34495e;
            border-radius: 8px;
        }
        
        #toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            border-radius: 8px;
        }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        #toast.success { background-color: var(--secondary-color); }
        #toast.error { background-color: var(--danger-color); }
        #toast.info { background-color: var(--primary-color); }

        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* Estilos para o Modal de Compartilhamento */
        .share-modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.8);
        }
        .share-modal-content {
            background-color: #2c3e50;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 700px;
            border-radius: 8px;
            text-align: center;
        }
        .share-modal .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .share-modal .close:hover,
        .share-modal .close:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }
        #sharedImage {
            max-width: 100%;
            border-radius: 5px;
            margin-top: 15px;
        }
        .share-modal p {
            margin-top: 15px;
            font-size: 1.1em;
            color: var(--text-color);
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>
            <img src="https://placehold.co/200x50/3498db/ffffff?text=VEXOS" alt="Logo VEXOS" class="logo">
            Ferramenta de Cálculo de Importação v30.3
        </h1>

        <!-- Card de Configurações Globais -->
        <div class="card">
            <h2><i class="fas fa-globe" style="margin-right: 10px;"></i>Configurações Globais</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="referenciaInterna">Referência Interna / PI</label>
                    <input type="text" id="referenciaInterna" placeholder="Ex: PI-2024-001">
                </div>
                <div class="form-group">
                    <label for="fornecedor">Fornecedor</label>
                    <input type="text" id="fornecedor" placeholder="Nome do Fornecedor">
                </div>
                <div class="form-group">
                    <label for="moeda">Moeda</label>
                    <select id="moeda">
                        <option value="USD">Dólar (USD)</option>
                        <option value="EUR">Euro (EUR)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taxaCambio">Taxa de Câmbio</label>
                    <input type="number" id="taxaCambio" step="0.0001" placeholder="Ex: 5.2500">
                </div>
                <div class="form-group">
                    <button onclick="fetchExchangeRate()" style="margin-top: 25px;">Buscar Câmbio Atual</button>
                </div>
                <div class="form-group">
                    <label for="freteInternacional">Frete Internacional (na moeda)</label>
                    <input type="number" id="freteInternacional" value="0">
                </div>
                <div class="form-group">
                    <label for="seguroInternacional">Seguro Internacional (na moeda)</label>
                    <input type="number" id="seguroInternacional" value="0">
                </div>
                <div class="form-group">
                    <label for="despesasAduaneiras">Despesas Aduaneiras (R$)</label>
                    <input type="number" id="despesasAduaneiras" value="0">
                </div>
            </div>
        </div>

        <!-- Card de Itens da Importação -->
        <div class="card">
            <h2><i class="fas fa-box-open" style="margin-right: 10px;"></i>Itens da Importação</h2>
            <div class="form-grid" id="item-form">
                <div class="form-group">
                    <label>Descrição do Produto</label>
                    <input type="text" id="item-descricao" placeholder="Nome do Produto">
                </div>
                <div class="form-group">
                    <label>Código Interno (SKU)</label>
                    <input type="text" id="item-sku" placeholder="SKU do produto">
                </div>
                <div class="form-group">
                    <label>NCM</label>
                    <input type="text" id="item-ncm" placeholder="8 dígitos">
                </div>
                <div class="form-group">
                    <label>Qtd.</label>
                    <input type="number" id="item-qtd" value="1">
                </div>
                <div class="form-group">
                    <label>Valor Unit. (Moeda)</label>
                    <input type="number" id="item-valor" step="0.01">
                </div>
                <div class="form-group">
                    <label>Peso Unit. (KG)</label>
                    <input type="number" id="item-peso" step="0.001">
                </div>
                 <div class="form-group">
                    <label>Preço Venda (R$)</label>
                    <input type="number" id="item-preco-venda" step="0.01">
                </div>
            </div>
            <h3>Alíquotas do Item (%)</h3>
             <div class="form-grid">
                <div class="form-group">
                    <label>II</label>
                    <input type="number" id="item-ii" value="0">
                </div>
                 <div class="form-group">
                    <label>IPI</label>
                    <input type="number" id="item-ipi" value="0">
                </div>
                 <div class="form-group">
                    <label>PIS</label>
                    <input type="number" id="item-pis" value="2.1">
                </div>
                 <div class="form-group">
                    <label>COFINS</label>
                    <input type="number" id="item-cofins" value="9.65">
                </div>
                 <div class="form-group">
                    <label>ICMS</label>
                    <input type="number" id="item-icms" value="18">
                </div>
            </div>
            <button onclick="addItem()" class="add-item"><i class="fas fa-plus"></i> Adicionar Item</button>
            <table id="itemsTable">
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th>SKU</th>
                        <th>NCM</th>
                        <th>Qtd.</th>
                        <th>Valor Unit.</th>
                        <th>Valor Total</th>
                        <th>Peso Unit.</th>
                        <th>Peso Total</th>
                        <th>Preço Venda</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Linhas de itens serão adicionadas aqui -->
                </tbody>
            </table>
        </div>

        <!-- Botão de Calcular -->
        <button onclick="calcularCustos()" class="calculate"><i class="fas fa-calculator"></i> Calcular Custos da Importação</button>

        <!-- Card de Resultados -->
        <div class="card" id="results-card" style="display:none;">
            <h2><i class="fas fa-chart-line" style="margin-right: 10px;"></i>Dashboard de Resultados</h2>
            <div class="dashboard-grid">
                <div class="dashboard-item">
                    <h3>Custo Final Total</h3>
                    <p id="totalCustoFinal">R$ 0,00</p>
                </div>
                <div class="dashboard-item">
                    <h3>Lucro Bruto Total</h3>
                    <p id="lucroBrutoTotal">R$ 0,00</p>
                </div>
                 <div class="dashboard-item">
                    <h3>Margem de Lucro Bruta</h3>
                    <p id="margemLucroBruta">0.00%</p>
                </div>
                 <div class="dashboard-item">
                    <h3>Mark-Up Global</h3>
                    <p id="markupGlobal">0.00x</p>
                </div>
                 <div class="dashboard-item">
                    <h3>Peso Total (KG)</h3>
                    <p id="pesoTotalDashboard">0.00</p>
                </div>
                 <div class="dashboard-item">
                    <h3>Custo Médio por KG</h3>
                    <p id="custoMedioKg">R$ 0,00</p>
                </div>
            </div>
            <div class="chart-container">
                 <canvas id="costsChart"></canvas>
            </div>
            
            <h3>Tabela de Resultados Detalhados</h3>
            <div style="overflow-x:auto;">
                <table id="resultsTable">
                    <!-- Conteúdo gerado via JS -->
                </table>
            </div>

            <div class="form-grid" style="margin-top: 20px;">
                <button onclick="exportTableToCSV()"><i class="fas fa-file-csv"></i> Exportar para CSV</button>
                <button onclick="gerarPDF()"><i class="fas fa-file-pdf"></i> Gerar Relatório PDF</button>
                <button onclick="shareDashboardViaWhatsApp()"><i class="fab fa-whatsapp"></i> Compartilhar Dashboard</button>
            </div>
        </div>

    </div>

    <!-- Modal para Compartilhamento -->
    <div id="shareImageModal" class="share-modal">
        <div class="share-modal-content">
            <span class="close">&times;</span>
            <h3>Compartilhar Imagem do Dashboard</h3>
            <p>Clique com o botão direito na imagem abaixo, selecione "Copiar Imagem" e cole no WhatsApp ou em outro aplicativo.</p>
            <img id="sharedImage" src="" alt="Imagem do Dashboard">
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast"></div>

    <script>
        let items = [];
        let costsChart;

        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            updateItemsTable();
        });

        function showToast(message, type = 'info') {
            const toast = document.getElementById("toast");
            toast.className = "show " + type;
            toast.textContent = message;
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

        async function fetchExchangeRate() {
            const moeda = document.getElementById('moeda').value;
            showToast(`Buscando cotação do ${moeda}...`, 'info');
            try {
                const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${moeda}`);
                if (!response.ok) throw new Error('Falha na rede');
                const data = await response.json();
                const rate = data.rates.BRL;
                if (rate) {
                    document.getElementById('taxaCambio').value = rate.toFixed(4);
                    showToast(`Cotação do ${moeda} atualizada para R$ ${rate.toFixed(4)}!`, 'success');
                } else {
                    throw new Error('Taxa BRL não encontrada');
                }
            } catch (error) {
                console.error("Erro ao buscar câmbio:", error);
                showToast('Não foi possível buscar a cotação. Verifique a conexão.', 'error');
            }
        }

        function addItem() {
            const newItem = {
                id: Date.now(),
                descricao: document.getElementById('item-descricao').value,
                sku: document.getElementById('item-sku').value,
                ncm: document.getElementById('item-ncm').value,
                qtd: parseFloat(document.getElementById('item-qtd').value) || 0,
                valor: parseFloat(document.getElementById('item-valor').value) || 0,
                peso: parseFloat(document.getElementById('item-peso').value) || 0,
                precoVenda: parseFloat(document.getElementById('item-preco-venda').value) || 0,
                ii: parseFloat(document.getElementById('item-ii').value) || 0,
                ipi: parseFloat(document.getElementById('item-ipi').value) || 0,
                pis: parseFloat(document.getElementById('item-pis').value) || 0,
                cofins: parseFloat(document.getElementById('item-cofins').value) || 0,
                icms: parseFloat(document.getElementById('item-icms').value) || 0,
            };

            if (!newItem.descricao || newItem.qtd <= 0 || newItem.valor <= 0) {
                showToast('Preencha Descrição, Quantidade e Valor do item.', 'error');
                return;
            }

            items.push(newItem);
            updateItemsTable();
            saveToLocalStorage();
            document.getElementById('item-form').reset();
            document.getElementById('item-descricao').focus();
        }

        function deleteItem(id) {
            items = items.filter(item => item.id !== id);
            updateItemsTable();
            saveToLocalStorage();
        }

        function updateItemsTable() {
            const tableBody = document.querySelector("#itemsTable tbody");
            tableBody.innerHTML = '';
            items.forEach(item => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${item.descricao}</td>
                    <td>${item.sku}</td>
                    <td>${item.ncm}</td>
                    <td>${item.qtd}</td>
                    <td>${formatCurrency(item.valor, document.getElementById('moeda').value)}</td>
                    <td>${formatCurrency(item.valor * item.qtd, document.getElementById('moeda').value)}</td>
                    <td>${item.peso.toFixed(3)} KG</td>
                    <td>${(item.peso * item.qtd).toFixed(3)} KG</td>
                    <td>${formatCurrency(item.precoVenda, 'BRL')}</td>
                    <td><button class="delete-item" onclick="deleteItem(${item.id})"><i class="fas fa-trash-alt"></i></button></td>
                `;
            });
        }

        function calcularCustos() {
            if (items.length === 0) {
                showToast('Adicione pelo menos um item para calcular.', 'error');
                return;
            }

            const taxaCambio = parseFloat(document.getElementById('taxaCambio').value) || 0;
            if (taxaCambio <= 0) {
                showToast('A taxa de câmbio deve ser maior que zero.', 'error');
                return;
            }
            
            const freteInternacional = parseFloat(document.getElementById('freteInternacional').value) || 0;
            const seguroInternacional = parseFloat(document.getElementById('seguroInternacional').value) || 0;
            const despesasAduaneiras = parseFloat(document.getElementById('despesasAduaneiras').value) || 0;

            let valorTotalProdutosMoeda = items.reduce((acc, item) => acc + (item.qtd * item.valor), 0);
            let pesoTotal = items.reduce((acc, item) => acc + (item.qtd * item.peso), 0);
            
            const valorAduaneiroMoeda = valorTotalProdutosMoeda + freteInternacional + seguroInternacional;
            const valorAduaneiroBRL = valorAduaneiroMoeda * taxaCambio;

            const resultsTable = document.getElementById('resultsTable');
            resultsTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Custo Unit. (R$)</th>
                        <th>Custo Total (R$)</th>
                        <th>Impostos (R$)</th>
                        <th>Custo Final Unit.</th>
                        <th>Custo Final Total</th>
                        <th>Preço Venda Unit.</th>
                        <th>Receita Total</th>
                        <th>Lucro Bruto Unit.</th>
                        <th>Lucro Bruto Total</th>
                        <th>Margem Bruta</th>
                        <th>Mark-Up</th>
                    </tr>
                </thead>
                <tbody></tbody>`;
            const resultsBody = resultsTable.querySelector('tbody');

            let custoFinalTotalImportacao = 0;
            let receitaTotalImportacao = 0;

            items.forEach(item => {
                const participacaoItem = (item.qtd * item.valor) / valorTotalProdutosMoeda;
                const freteRateado = (freteInternacional * participacaoItem) * taxaCambio;
                const seguroRateado = (seguroInternacional * participacaoItem) * taxaCambio;

                const valorProdutoBRL = (item.qtd * item.valor) * taxaCambio;
                
                const valorAduaneiroItem = valorProdutoBRL + freteRateado + seguroRateado;
                
                const I_I = valorAduaneiroItem * (item.ii / 100);
                
                const baseIPI = valorAduaneiroItem + I_I;
                const IPI = baseIPI * (item.ipi / 100);

                const basePIS_COFINS = valorAduaneiroItem;
                const PIS = basePIS_COFINS * (item.pis / 100);
                const COFINS = basePIS_COFINS * (item.cofins / 100);
                
                const baseICMS = (valorAduaneiroItem + I_I + IPI + PIS + COFINS + despesasAduaneiras * participacaoItem) / (1 - (item.icms / 100));
                const ICMS = baseICMS * (item.icms / 100);

                const totalImpostosItem = I_I + IPI + PIS + COFINS + ICMS;
                const despesasRateadasItem = despesasAduaneiras * participacaoItem;
                
                const custoFinalTotalItem = valorProdutoBRL + totalImpostosItem + freteRateado + seguroRateado + despesasRateadasItem;
                const custoFinalUnitario = custoFinalTotalItem / item.qtd;

                const receitaTotalItem = item.precoVenda * item.qtd;
                const lucroBrutoTotalItem = receitaTotalItem - custoFinalTotalItem;
                const lucroBrutoUnitario = lucroBrutoTotalItem / item.qtd;
                const margemBrutaItem = receitaTotalItem > 0 ? (lucroBrutoTotalItem / receitaTotalItem) * 100 : 0;
                const markupItem = custoFinalUnitario > 0 ? item.precoVenda / custoFinalUnitario : 0;
                
                custoFinalTotalImportacao += custoFinalTotalItem;
                receitaTotalImportacao += receitaTotalItem;

                const row = resultsBody.insertRow();
                row.innerHTML = `
                    <td>${item.descricao}</td>
                    <td>${formatCurrency(custoFinalUnitario)}</td>
                    <td>${formatCurrency(custoFinalTotalItem)}</td>
                    <td>${formatCurrency(totalImpostosItem)}</td>
                    <td>${formatCurrency(custoFinalUnitario)}</td>
                    <td>${formatCurrency(custoFinalTotalItem)}</td>
                    <td>${formatCurrency(item.precoVenda)}</td>
                    <td>${formatCurrency(receitaTotalItem)}</td>
                    <td>${formatCurrency(lucroBrutoUnitario)}</td>
                    <td>${formatCurrency(lucroBrutoTotalItem)}</td>
                    <td>${margemBrutaItem.toFixed(2)}%</td>
                    <td>${markupItem.toFixed(2)}x</td>
                `;
            });
            
            const lucroBrutoTotalGeral = receitaTotalImportacao - custoFinalTotalImportacao;
            const margemBrutaGeral = receitaTotalImportacao > 0 ? (lucroBrutoTotalGeral / receitaTotalImportacao) * 100 : 0;
            const markupGeral = custoFinalTotalImportacao > 0 ? receitaTotalImportacao / custoFinalTotalImportacao : 0;

            document.getElementById('totalCustoFinal').innerText = formatCurrency(custoFinalTotalImportacao);
            document.getElementById('lucroBrutoTotal').innerText = formatCurrency(lucroBrutoTotalGeral);
            document.getElementById('margemLucroBruta').innerText = `${margemBrutaGeral.toFixed(2)}%`;
            document.getElementById('markupGlobal').innerText = `${markupGeral.toFixed(2)}x`;
            document.getElementById('pesoTotalDashboard').innerText = `${pesoTotal.toFixed(2)} KG`;
            document.getElementById('custoMedioKg').innerText = pesoTotal > 0 ? formatCurrency(custoFinalTotalImportacao / pesoTotal) : 'R$ 0,00';
            
            document.getElementById('results-card').style.display = 'block';

            updateChart(valorAduaneiroBRL, custoFinalTotalImportacao - valorAduaneiroBRL);
            saveToLocalStorage();
        }

        function updateChart(custoProdutos, custoImpostosDespesas) {
            const ctx = document.getElementById('costsChart').getContext('2d');
            if (costsChart) {
                costsChart.destroy();
            }
            costsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Custo dos Produtos (CIF em R$)', 'Impostos e Despesas (R$)'],
                    datasets: [{
                        data: [custoProdutos, custoImpostosDespesas],
                        backgroundColor: ['#3498db', '#e74c3c'],
                        borderColor: '#2c3e50',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#ecf0f1',
                                font: { size: 14 }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Composição do Custo Final da Importação',
                            color: '#ecf0f1',
                            font: { size: 18 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function formatCurrency(value, currency = 'BRL') {
            const options = { style: 'currency', currency: currency };
            return new Intl.NumberFormat('pt-BR', options).format(value);
        }

        function saveToLocalStorage() {
            const dataToSave = {
                items: items,
                globals: {
                    referenciaInterna: document.getElementById('referenciaInterna').value,
                    fornecedor: document.getElementById('fornecedor').value,
                    moeda: document.getElementById('moeda').value,
                    taxaCambio: document.getElementById('taxaCambio').value,
                    freteInternacional: document.getElementById('freteInternacional').value,
                    seguroInternacional: document.getElementById('seguroInternacional').value,
                    despesasAduaneiras: document.getElementById('despesasAduaneiras').value
                }
            };
            localStorage.setItem('importToolData', JSON.stringify(dataToSave));
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('importToolData');
            if (savedData) {
                const data = JSON.parse(savedData);
                items = data.items || [];
                if (data.globals) {
                    document.getElementById('referenciaInterna').value = data.globals.referenciaInterna || '';
                    document.getElementById('fornecedor').value = data.globals.fornecedor || '';
                    document.getElementById('moeda').value = data.globals.moeda || 'USD';
                    document.getElementById('taxaCambio').value = data.globals.taxaCambio || '';
                    document.getElementById('freteInternacional').value = data.globals.freteInternacional || 0;
                    document.getElementById('seguroInternacional').value = data.globals.seguroInternacional || 0;
                    document.getElementById('despesasAduaneiras').value = data.globals.despesasAduaneiras || 0;
                }
            }
        }
        
        /**
         * Exporta a tabela de resultados para um arquivo CSV.
         * Lida com vírgulas e aspas duplas dentro das células para garantir a compatibilidade com o Excel.
         */
        function exportTableToCSV() {
            console.log("Iniciando exportação para CSV...");
            const table = document.getElementById("resultsTable");
            if (!table) {
                showToast('Tabela de resultados não encontrada!', 'error');
                return;
            }

            let csv = [];
            const rows = table.querySelectorAll("tr");

            for (const row of rows) {
                const rowData = [];
                const cols = row.querySelectorAll("td, th");
                for (const col of cols) {
                    let data = col.innerText.replace(/"/g, '""'); // Escapa aspas duplas
                    if (data.includes(',')) {
                        data = `"${data}"`; // Envolve em aspas se contiver vírgula
                    }
                    rowData.push(data);
                }
                csv.push(rowData.join(","));
            }

            const csvContent = csv.join("\n");
            const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' }); // \uFEFF é o BOM para o Excel entender UTF-8

            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                const ref = document.getElementById('referenciaInterna').value || 'calculo';
                const fileName = `Relatorio_Importacao_${ref.replace(/[^a-z0-9]/gi, '_')}.csv`;
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('Arquivo CSV gerado com sucesso!', 'success');
            } else {
                showToast('Seu navegador não suporta a funcionalidade de download.', 'error');
            }
        }
        
        /**
         * Gera um relatório em PDF com os KPIs do dashboard e a tabela de resultados.
         * Utiliza jsPDF e jsPDF-AutoTable.
         */
        function gerarPDF() {
            console.log("Iniciando geração do PDF...");
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                showToast('Biblioteca jsPDF não carregada.', 'error');
                return;
            }

            const doc = new jsPDF({
                orientation: 'landscape', // Paisagem para caber mais colunas
                unit: 'pt',
                format: 'a3' // Papel maior para tabelas largas
            });

            const referencia = document.getElementById('referenciaInterna').value || "Não informada";
            const fornecedor = document.getElementById('fornecedor').value || "Não informado";

            // Cabeçalho do Documento
            doc.setFontSize(18);
            doc.text("Relatório de Cálculo de Importação", 40, 40);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Referência Interna: ${referencia}`, 40, 60);
            doc.text(`Fornecedor: ${fornecedor}`, 40, 75);

            // Resumo (KPIs do Dashboard)
            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text("Resumo e Indicadores Principais", 40, 110);
            doc.setFontSize(10);
            doc.text(`Custo Final Total da Importação: ${document.getElementById('totalCustoFinal').innerText}`, 45, 130);
            doc.text(`Lucro Bruto Total Estimado: ${document.getElementById('lucroBrutoTotal').innerText}`, 45, 145);
            doc.text(`Margem de Lucro Bruta: ${document.getElementById('margemLucroBruta').innerText}`, 45, 160);
            doc.text(`Mark-Up Global sobre o Custo: ${document.getElementById('markupGlobal').innerText}`, 45, 175);
            doc.text(`Peso Total dos Produtos (KG): ${document.getElementById('pesoTotalDashboard').innerText}`, 45, 190);
            doc.text(`Custo Médio por KG: ${document.getElementById('custoMedioKg').innerText}`, 45, 205);


            // Tabela de Resultados Detalhados
            doc.autoTable({
                html: '#resultsTable',
                startY: 230,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185], textColor: 255, fontStyle: 'bold' },
                styles: { fontSize: 7, cellPadding: 2 },
                columnStyles: { // Ajusta a largura de colunas específicas se necessário
                    0: { cellWidth: 100 },
                },
                didDrawPage: function(data) {
                    // Adiciona o rodapé com número da página
                    let str = "Página " + doc.internal.getNumberOfPages();
                    doc.setFontSize(8);
                    doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });

            const fileName = `Relatorio_Importacao_${referencia.replace(/[^a-z0-9]/gi, '_')}.pdf`;
            doc.save(fileName);
            showToast('Relatório PDF gerado com sucesso!', 'success');
        }

        /**
         * Captura uma imagem da área do dashboard e a exibe em um modal para compartilhamento.
         * Utiliza html2canvas.
         */
        function shareDashboardViaWhatsApp() {
            console.log("Iniciando captura do dashboard...");
            const dashboardElement = document.querySelector('.dashboard-grid');
            if (!dashboardElement) {
                showToast('Área do dashboard não encontrada.', 'error');
                return;
            }

            const shareModal = document.getElementById('shareImageModal');
            const sharedImage = document.getElementById('sharedImage');
            const closeBtn = document.querySelector('.share-modal .close');

            showToast('Preparando imagem para compartilhar...', 'info');

            html2canvas(dashboardElement, {
                scale: 2, // Aumenta a resolução da imagem para melhor qualidade
                useCORS: true,
                backgroundColor: '#1a1a1a' // Fundo escuro para combinar com o tema
            }).then(canvas => {
                sharedImage.src = canvas.toDataURL('image/png');
                shareModal.style.display = 'block';

                closeBtn.onclick = function() {
                    shareModal.style.display = "none";
                }
                window.onclick = function(event) {
                    if (event.target == shareModal) {
                        shareModal.style.display = "none";
                    }
                }
                showToast('Imagem pronta! Copie e cole no WhatsApp.', 'success');

            }).catch(err => {
                console.error("Erro ao gerar imagem com html2canvas:", err);
                showToast('Erro ao gerar a imagem do dashboard.', 'error');
            });
        }
    </script>
</body>
</html>
