<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ferramenta de Cálculo de Importação (Tema Escuro)</title>

  <!-- Tailwind CSS (com dark mode) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#1f2937',       // cinza-800
            secondary: '#374151',     // cinza-700
            accentBlue: '#3b82f6',    // azul-500
            accentOrange: '#f97316',  // laranja-500
            accentGreen: '#10b981',   // verde-500
            accentRed: '#ef4444',     // vermelho-500
            background: '#111827',    // cinza-900
            surface: '#1f2937',       // cinza-800
            border: '#374151',        // cinza-700
          }
        }
      }
    }
  </script>

  <!-- FontAwesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-pgr2TehDUe6tyMZi7e2P+59cp5URmftfqNkc4h+PBRUOkKRoQjWRVzo70h4uF+eKyi3f5DkIszMe3BuAufz0gA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- jQuery (necessário para DataTables) -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <!-- DataTables CSS e JS -->
  <link
    rel="stylesheet"
    href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
  />
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* Ajustes adicionais para compatibilidade com tema escuro */
    body {
      background-color: theme('colors.background');
      color: theme('colors.white');
    }
    .table thead {
      background-color: theme('colors.surface');
    }
    .table tbody tr {
      background-color: theme('colors.primary');
    }
    .table td,
    .table th {
      border-color: theme('colors.border');
    }
    .form-input,
    .form-select {
      background-color: theme('colors.surface');
      color: theme('colors.white');
      border: 1px solid theme('colors.border');
    }
    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: theme('colors.accentBlue');
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
    }
    .btn-primary {
      background-color: theme('colors.accentBlue');
      border-color: theme('colors.accentBlue');
    }
    .btn-primary:hover {
      background-color: theme('colors.accentBlue');
      opacity: 0.9;
    }
    .btn-secondary {
      background-color: theme('colors.secondary');
      border-color: theme('colors.secondary');
    }
    .btn-secondary:hover {
      background-color: theme('colors.secondary');
      opacity: 0.9;
    }
    .nav-tabs .nav-link {
      color: theme('colors.white');
      background-color: theme('colors.primary');
      border-color: theme('colors.border');
    }
    .nav-tabs .nav-link.active {
      background-color: theme('colors.surface');
      color: theme('colors.white');
    }
    .tab-content {
      background-color: theme('colors.surface');
      border: 1px solid theme('colors.border');
      border-top: none;
      padding: 1rem;
      border-radius: 0 0 0.5rem 0.5rem;
    }
    .card {
      background-color: theme('colors.surface');
      border: 1px solid theme('colors.border');
      border-radius: 0.5rem;
    }
    .card-header {
      background-color: theme('colors.secondary');
      color: theme('colors.white');
      font-weight: 600;
      border-bottom: 1px solid theme('colors.border');
      padding: 0.75rem 1rem;
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
    }
    .card-body {
      padding: 1rem;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Navbar -->
  <nav class="flex items-center justify-between px-6 py-4 bg-secondary">
    <div class="flex items-center space-x-3">
      <i class="fas fa-industry text-accentBlue text-xl"></i>
      <span class="text-lg font-semibold">JD Automação - Import</span>
    </div>
    <button id="toggleTheme" class="text-white text-xl">
      <i class="fas fa-adjust"></i>
    </button>
  </nav>

  <div class="container mx-auto flex-1 py-6 px-4">
    <!-- Abas -->
    <ul
      class="nav nav-tabs mb-4"
      id="mainTabs"
      role="tablist"
    >
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="entrada-tab"
          data-bs-toggle="tab"
          data-bs-target="#entrada"
          type="button"
          role="tab"
          aria-controls="entrada"
          aria-selected="true"
        >
          Entrada
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="resultados-tab"
          data-bs-toggle="tab"
          data-bs-target="#resultados"
          type="button"
          role="tab"
          aria-controls="resultados"
          aria-selected="false"
        >
          Resultados
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="dashboard-tab"
          data-bs-toggle="tab"
          data-bs-target="#dashboard"
          type="button"
          role="tab"
          aria-controls="dashboard"
          aria-selected="false"
        >
          Dashboard
        </button>
      </li>
    </ul>

    <div class="tab-content">
      <!-- Aba: Entrada -->
      <div
        class="tab-pane fade show active"
        id="entrada"
        role="tabpanel"
        aria-labelledby="entrada-tab"
      >
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Dados Globais -->
          <div class="card">
            <div class="card-header">Dados Globais do Embarque</div>
            <div class="card-body space-y-4">
              <div>
                <label class="block mb-1">Nome do Responsável</label>
                <input
                  type="text"
                  id="inputNome"
                  class="form-input w-full"
                  value="Diego Karloh"
                />
              </div>
              <div>
                <label class="block mb-1">Fornecedor</label>
                <input
                  type="text"
                  id="inputFornecedor"
                  class="form-input w-full"
                  value="Hy Tech"
                />
              </div>
              <div>
                <label class="block mb-1">Número PI (Proforma)</label>
                <input
                  type="text"
                  id="inputPI"
                  class="form-input w-full"
                  value="PO1256897"
                />
              </div>
              <div>
                <label class="block mb-1">Número DI / Processo</label>
                <input
                  type="text"
                  id="inputDI"
                  class="form-input w-full"
                  value="1111"
                />
              </div>
              <div>
                <label class="block mb-1">Data do Embarque</label>
                <input
                  type="date"
                  id="inputData"
                  class="form-input w-full"
                />
              </div>
              <hr class="border-border" />
              <div>
                <label class="block mb-1">Moeda Estrangeira</label>
                <div class="flex space-x-2">
                  <input
                    type="text"
                    id="inputMoeda"
                    class="form-input flex-1"
                    value="USD"
                    maxlength="3"
                  />
                  <button
                    class="btn-primary px-3"
                    onclick="fetchCotacao('USD')"
                  >
                    USD-BRL
                  </button>
                  <button
                    class="btn-primary px-3"
                    onclick="fetchCotacao('EUR')"
                  >
                    EUR-BRL
                  </button>
                  <button
                    class="btn-primary px-3"
                    onclick="fetchCotacao('CNY')"
                  >
                    CNY-BRL
                  </button>
                </div>
                <small id="infoCotacao" class="text-green-400"></small>
              </div>
              <div>
                <label class="block mb-1">
                  Taxa de Câmbio (BRL por 1 unidade)
                </label>
                <input
                  type="number"
                  id="inputCambio"
                  class="form-input w-full"
                  step="0.0001"
                  value="5.71"
                />
              </div>
              <div>
                <label class="block mb-1">Incoterm</label>
                <select id="selectIncoterm" class="form-select w-full">
                  <option>EXW</option>
                  <option>FCA</option>
                  <option>FOB</option>
                  <option>CIF</option>
                  <option selected>CPT</option>
                </select>
              </div>
              <div>
                <label class="block mb-1">Modalidade de Transporte</label>
                <select id="selectTransporte" class="form-select w-full">
                  <option>Marítimo</option>
                  <option selected>Aéreo</option>
                  <option>Rodoviário</option>
                  <option>Outro</option>
                </select>
              </div>
              <hr class="border-border" />
              <div>
                <label class="block mb-1">Regime Tributário Federal</label>
                <select
                  id="selectRegime"
                  class="form-select w-full"
                  onchange="ajustarCreditos()"
                >
                  <option selected>Lucro Real</option>
                  <option>Lucro Presumido</option>
                  <option>Simples Nacional</option>
                </select>
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1">% Crédito PIS</label>
                  <input
                    type="number"
                    id="inputPISCred"
                    class="form-input w-full"
                    value="100"
                    step="0.01"
                  />
                </div>
                <div>
                  <label class="block mb-1">% Crédito COFINS</label>
                  <input
                    type="number"
                    id="inputCOFINSCred"
                    class="form-input w-full"
                    value="100"
                    step="0.01"
                  />
                </div>
                <div>
                  <label class="block mb-1">% Crédito IPI</label>
                  <input
                    type="number"
                    id="inputIPICred"
                    class="form-input w-full"
                    value="100"
                    step="0.01"
                  />
                </div>
                <div>
                  <label class="block mb-1">% Crédito ICMS</label>
                  <input
                    type="number"
                    id="inputICMSCred"
                    class="form-input w-full"
                    value="100"
                    step="0.01"
                  />
                </div>
              </div>
              <hr class="border-border" />
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block mb-1">Frete Internacional TOTAL ($)</label>
                  <input
                    type="number"
                    id="inputFreteME"
                    class="form-input w-full"
                    value="1657"
                    step="0.01"
                  />
                </div>
                <div>
                  <label class="block mb-1">
                    Taxa Siscomex TOTAL (R$)
                  </label>
                  <input
                    type="number"
                    id="inputSiscomexBRL"
                    class="form-input w-full"
                    value="416.46"
                    step="0.01"
                  />
                </div>
                <div>
                  <label class="block mb-1">
                    Seguro Internacional TOTAL ($)
                  </label>
                  <input
                    type="number"
                    id="inputSeguroME"
                    class="form-input w-full"
                    value="0"
                    step="0.01"
                  />
                </div>
                <div>
                  <label class="block mb-1">
                    Despesas Aduaneiras TOTAL (R$)
                  </label>
                  <input
                    type="number"
                    id="inputDespAduBRL"
                    class="form-input w-full"
                    value="0"
                    step="0.01"
                  />
                </div>
                <div>
                  <label class="block mb-1">
                    Outras Despesas Origem TOTAL ($)
                  </label>
                  <input
                    type="number"
                    id="inputOutrasME"
                    class="form-input w-full"
                    value="0"
                    step="0.01"
                  />
                </div>
                <div>
                  <label class="block mb-1">Frete Nacional TOTAL (R$)</label>
                  <input
                    type="number"
                    id="inputFreteBRL"
                    class="form-input w-full"
                    value="0"
                    step="0.01"
                  />
                </div>
                <div>
                  <label class="block mb-1">Alíquota AFRMM (%)</label>
                  <input
                    type="number"
                    id="inputAFRMM"
                    class="form-input w-full"
                    value="0"
                    step="0.01"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Itens do Embarque -->
          <div class="card">
            <div class="card-header">Itens do Embarque</div>
            <div class="card-body">
              <div class="w-full overflow-auto">
                <table
                  id="tabelaItens"
                  class="table table-striped table-hover w-full"
                >
                  <thead class="bg-secondary">
                    <tr>
                      <th class="px-2 py-1">#</th>
                      <th class="px-2 py-1">Descrição</th>
                      <th class="px-2 py-1">Cód. Int.</th>
                      <th class="px-2 py-1">NCM</th>
                      <th class="px-2 py-1">Qtd</th>
                      <th class="px-2 py-1">Custo Unit. ($)</th>
                      <th class="px-2 py-1">Peso Unit. (KG)</th>
                      <th class="px-2 py-1">II (%)</th>
                      <th class="px-2 py-1">IPI (%)</th>
                      <th class="px-2 py-1">PIS (%)</th>
                      <th class="px-2 py-1">COFINS (%)</th>
                      <th class="px-2 py-1">ICMS (%)</th>
                      <th class="px-2 py-1">Venda Unit. (R$)</th>
                      <th class="px-2 py-1">
                        <button
                          class="btn-primary text-sm px-2 py-1"
                          onclick="adicionarLinha()"
                        >
                          <i class="fas fa-plus"></i>
                        </button>
                      </th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
              <small class="text-gray-400 block mt-2">
                Preencha os campos e clique no + para adicionar novas linhas.
              </small>
            </div>
          </div>
        </div>

        <div class="flex justify-center mt-6 space-x-4">
          <button
            class="btn-primary px-6 py-2"
            onclick="calcularTudo()"
          >
            <i class="fas fa-calculator mr-2"></i>Calcular
          </button>
          <button
            class="btn-secondary px-6 py-2"
            onclick="limparTudo()"
          >
            <i class="fas fa-broom mr-2"></i>Limpar Tudo
          </button>
        </div>
      </div>

      <!-- Aba: Resultados -->
      <div
        class="tab-pane fade"
        id="resultados"
        role="tabpanel"
        aria-labelledby="resultados-tab"
      >
        <div class="card">
          <div class="card-header">Resultados Detalhados por Item</div>
          <div class="card-body w-full overflow-auto">
            <table
              id="tabelaResultados"
              class="table table-hover table-bordered w-full"
            >
              <thead class="bg-secondary">
                <tr>
                  <th class="px-2 py-1">#</th>
                  <th class="px-2 py-1">Cód. Int.</th>
                  <th class="px-2 py-1">Descrição</th>
                  <th class="px-2 py-1">NCM</th>
                  <th class="px-2 py-1">Qtd</th>
                  <th class="px-2 py-1">Peso Tot. (KG)</th>
                  <th class="px-2 py-1">% Rateio Peso</th>
                  <th class="px-2 py-1">Frete Unit. (R$)</th>
                  <th class="px-2 py-1">FOB Unit. (R$)</th>
                  <th class="px-2 py-1">FOB Tot. (R$)</th>
                  <th class="px-2 py-1">II (R$)</th>
                  <th class="px-2 py-1">Valor NF Unit. (R$)</th>
                  <th class="px-2 py-1">IPI Pago (R$)</th>
                  <th class="px-2 py-1">IPI Custo (R$)</th>
                  <th class="px-2 py-1">PIS Pago (R$)</th>
                  <th class="px-2 py-1">PIS Custo (R$)</th>
                  <th class="px-2 py-1">COFINS Pago (R$)</th>
                  <th class="px-2 py-1">COFINS Custo (R$)</th>
                  <th class="px-2 py-1">ICMS Base (R$)</th>
                  <th class="px-2 py-1">ICMS Pago (R$)</th>
                  <th class="px-2 py-1">ICMS Custo (R$)</th>
                  <th class="px-2 py-1">AFRMM (R$)</th>
                  <th class="px-2 py-1">Frete Nac. (R$)</th>
                  <th class="px-2 py-1">Desp Adua. (R$)</th>
                  <th class="px-2 py-1">Custo Total (R$)</th>
                  <th class="px-2 py-1">Lucro Unit. (R$)</th>
                  <th class="px-2 py-1">Margem (%)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Aba: Dashboard -->
      <div
        class="tab-pane fade"
        id="dashboard"
        role="tabpanel"
        aria-labelledby="dashboard-tab"
      >
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="card text-center">
            <div class="card-header">Valor Pedido (ME)</div>
            <div class="card-body">
              <h3 id="kpiValorPedido" class="text-2xl font-bold">0</h3>
            </div>
          </div>
          <div class="card text-center">
            <div class="card-header">Custo Total Embarque (R$)</div>
            <div class="card-body">
              <h3 id="kpiCustoTotal" class="text-2xl font-bold">0</h3>
            </div>
          </div>
          <div class="card text-center">
            <div class="card-header">Receita Total Brasil (R$)</div>
            <div class="card-body">
              <h3 id="kpiReceitaTotal" class="text-2xl font-bold">0</h3>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
          <div class="card text-center">
            <div class="card-header">Lucro Total (R$)</div>
            <div class="card-body">
              <h4 id="kpiLucroTotal" class="text-xl font-bold">0</h4>
            </div>
          </div>
          <div class="card text-center">
            <div class="card-header">Margem Total (%)</div>
            <div class="card-body">
              <h4 id="kpiMargemTotal" class="text-xl font-bold">0%</h4>
            </div>
          </div>
          <div class="card text-center">
            <div class="card-header">Peso Total (KG)</div>
            <div class="card-body">
              <h4 id="kpiPesoTotal" class="text-xl font-bold">0</h4>
            </div>
          </div>
          <div class="card text-center">
            <div class="card-header">Total Itens</div>
            <div class="card-body">
              <h4 id="kpiTotalItens" class="text-xl font-bold">0</h4>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="card">
            <div class="card-header">Distribuição de Custo (%)</div>
            <div class="card-body">
              <canvas id="chartDistCusto"></canvas>
            </div>
          </div>
          <div class="card">
            <div class="card-header">Margens por Item (%)</div>
            <div class="card-body">
              <canvas id="chartMargens"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle (inclui Popper) para abas -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-qQ2ohlwM5mPq0VTqY6ctEnz2WSveNH0MB3FlYbN67lIKDK9tvepxJxXorkotF0E1"
    crossorigin="anonymous"
  ></script>

  <script>
    // Inicializar DataTables após a tabela existir
    let dtItens, dtResultados;
    document.addEventListener('DOMContentLoaded', () => {
      dtItens = $('#tabelaItens').DataTable({
        paging: false,
        searching: false,
        info: false,
        ordering: false,
        columns: [
          { data: 'index', width: '3%' },
          { data: 'descricao' },
          { data: 'codInterno', width: '8%' },
          { data: 'ncm', width: '6%' },
          { data: 'qtd', width: '5%' },
          { data: 'precoCustoUnitME', width: '6%' },
          { data: 'pesoUnit', width: '6%' },
          { data: 'iiPerc', width: '5%' },
          { data: 'ipiPerc', width: '5%' },
          { data: 'pisPerc', width: '5%' },
          { data: 'cofinsPerc', width: '5%' },
          { data: 'icmsPerc', width: '5%' },
          { data: 'precoVendaBR', width: '7%' },
          { data: 'acoes', orderable: false, width: '5%' }
        ],
        columnDefs: [
          {
            targets: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
            className: 'px-2 py-1'
          },
          {
            targets: 0,
            className: 'text-center px-2 py-1'
          },
          {
            targets: 13,
            className: 'text-center px-2 py-1'
          }
        ]
      });

      dtResultados = $('#tabelaResultados').DataTable({
        paging: false,
        searching: false,
        info: false,
        ordering: false,
        columns: [
          { data: 'index', width: '3%' },
          { data: 'codInterno', width: '8%' },
          { data: 'descricao' },
          { data: 'ncm', width: '6%' },
          { data: 'qtd', width: '5%' },
          { data: 'pesoTotal', width: '6%' },
          { data: 'percRateioPeso', width: '6%' },
          { data: 'freteUnitBR', width: '6%' },
          { data: 'fobUnitBR', width: '6%' },
          { data: 'fobTotalBR', width: '6%' },
          { data: 'iiR', width: '6%' },
          { data: 'valorNFUnit', width: '6%' },
          { data: 'ipiPago', width: '6%' },
          { data: 'ipiCusto', width: '6%' },
          { data: 'pisPago', width: '6%' },
          { data: 'pisCusto', width: '6%' },
          { data: 'cofinsPago', width: '6%' },
          { data: 'cofinsCusto', width: '6%' },
          { data: 'icmsBase', width: '6%' },
          { data: 'icmsPago', width: '6%' },
          { data: 'icmsCusto', width: '6%' },
          { data: 'afrmm', width: '6%' },
          { data: 'freteNacBR', width: '6%' },
          { data: 'despAduBR', width: '6%' },
          { data: 'custoTotalBR', width: '7%' },
          { data: 'lucroUnitBR', width: '6%' },
          { data: 'margemPerc', width: '6%' }
        ],
        columnDefs: [
          {
            targets: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26],
            className: 'px-2 py-1'
          },
          {
            targets: 0,
            className: 'text-center px-2 py-1'
          }
        ]
      });

      // Inicializar gráficos vazios
      const ctxDist = document.getElementById('chartDistCusto').getContext('2d');
      window.chartDistCusto = new Chart(ctxDist, {
        type: 'pie',
        data: {
          labels: ['Produto', 'Impostos', 'Outras Despesas', 'Frete'],
          datasets: [
            {
              data: [0, 0, 0, 0],
              backgroundColor: [
                theme('colors.accentBlue'),
                theme('colors.accentRed'),
                theme('colors.accentOrange'),
                theme('colors.accentGreen')
              ]
            }
          ]
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#ffffff'
              }
            }
          },
          responsive: true
        }
      });

      const ctxMarg = document.getElementById('chartMargens').getContext('2d');
      window.chartMargens = new Chart(ctxMarg, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [
            {
              label: 'Margem (%)',
              data: [],
              backgroundColor: theme('colors.accentBlue')
            }
          ]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: '#ffffff'
              },
              grid: {
                color: theme('colors.border')
              }
            },
            x: {
              ticks: {
                color: '#ffffff'
              },
              grid: {
                color: theme('colors.border')
              }
            }
          },
          plugins: {
            legend: { display: false }
          },
          responsive: true
        }
      });
    });

    // Alternar tema escuro/claro
    document.getElementById('toggleTheme').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
    });

    function theme(key) {
      // Função auxiliar para obter cor do Tailwind via CSS custom property fallback
      const el = document.createElement('div');
      el.className = `bg-[${key}]`;
      document.body.appendChild(el);
      const computed = getComputedStyle(el).backgroundColor;
      document.body.removeChild(el);
      return computed;
    }

    function ajustarCreditos() {
      const regime = document.getElementById('selectRegime').value;
      const campos = ['inputPISCred', 'inputCOFINSCred', 'inputIPICred', 'inputICMSCred'];
      if (regime !== 'Lucro Real') {
        campos.forEach(id => {
          const el = document.getElementById(id);
          el.value = 0;
          el.setAttribute('disabled', 'true');
        });
      } else {
        campos.forEach(id => {
          const el = document.getElementById(id);
          el.removeAttribute('disabled');
          el.value = 100;
        });
      }
    }

    async function fetchCotacao(moeda) {
      try {
        const res = await fetch(`https://economia.awesomeapi.com.br/json/last/${moeda}-BRL`);
        const data = await res.json();
        const key = moeda + 'BRL';
        const valor = parseFloat(data[key].bid).toFixed(4);
        document.getElementById('inputCambio').value = valor;
        const infoEl = document.getElementById('infoCotacao');
        infoEl.textContent = `1 ${moeda} = ${valor} BRL`;
        setTimeout(() => { infoEl.textContent = ''; }, 3000);
      } catch {
        document.getElementById('infoCotacao').textContent = 'Erro ao obter cotação';
      }
    }

    function obterFloat(valor) {
      const v = parseFloat(String(valor).replace(',', '.'));
      return isNaN(v) ? 0 : v;
    }

    function adicionarLinha() {
      const novoIndex = dtItens.rows().count() + 1;
      dtItens.row.add({
        index: novoIndex,
        descricao: '<input type="text" class="form-input w-full text-sm" />',
        codInterno: '<input type="text" class="form-input w-full text-sm" />',
        ncm: '<input type="text" class="form-input w-full text-sm" />',
        qtd: '<input type="number" class="form-input w-full text-sm" value="1" min="0" step="0.01" />',
        precoCustoUnitME: '<input type="number" class="form-input w-full text-sm" value="0" step="0.01" />',
        pesoUnit: '<input type="number" class="form-input w-full text-sm" value="0" step="0.01" />',
        iiPerc: '<input type="number" class="form-input w-full text-sm" value="0" step="0.01" />',
        ipiPerc: '<input type="number" class="form-input w-full text-sm" value="0" step="0.01" />',
        pisPerc: '<input type="number" class="form-input w-full text-sm" value="0" step="0.01" />',
        cofinsPerc: '<input type="number" class="form-input w-full text-sm" value="0" step="0.01" />',
        icmsPerc: '<input type="number" class="form-input w-full text-sm" value="0" step="0.01" />',
        precoVendaBR: '<input type="number" class="form-input w-full text-sm" value="0" step="0.01" />',
        acoes: '<button class="btn-secondary text-sm px-2 py-1 btn-remover"><i class="fas fa-trash"></i></button>'
      }).draw(false);
    }

    // Remover linha ao clicar no ícone de lixeira
    $(document).on('click', '.btn-remover', function () {
      dtItens.row($(this).parents('tr')).remove().draw();
    });

    function limparTudo() {
      // Zerar campos de entrada
      [
        'inputNome','inputFornecedor','inputPI','inputDI','inputData',
        'inputMoeda','inputCambio','selectIncoterm','selectTransporte','selectRegime',
        'inputPISCred','inputCOFINSCred','inputIPICred','inputICMSCred',
        'inputFreteME','inputSiscomexBRL','inputSeguroME','inputDespAduBRL',
        'inputOutrasME','inputFreteBRL','inputAFRMM'
      ].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === 'SELECT') el.selectedIndex = 0;
        else if (el.type === 'date') el.value = '';
        else {
          el.value = '';
        }
      });

      // Limpar tabelas
      dtItens.clear().draw();
      dtResultados.clear().draw();

      // Limpar KPIs
      [
        'kpiValorPedido','kpiCustoTotal','kpiReceitaTotal',
        'kpiLucroTotal','kpiMargemTotal','kpiPesoTotal','kpiTotalItens'
      ].forEach(id => {
        document.getElementById(id).innerText = id.includes('Margem') ? '0%' : '0';
      });

      // Reset gráficos
      chartDistCusto.data.datasets[0].data = [0, 0, 0, 0];
      chartDistCusto.update();
      chartMargens.data.labels = [];
      chartMargens.data.datasets[0].data = [];
      chartMargens.update();
    }

    function calcularTudo() {
      // Obter valores globais
      const cambio = obterFloat(document.getElementById('inputCambio').value);
      if (cambio <= 0) {
        alert('Informe uma taxa de câmbio válida.');
        return;
      }
      const totalFreteME = obterFloat(document.getElementById('inputFreteME').value);
      const totalSeguroME = obterFloat(document.getElementById('inputSeguroME').value);
      const totalOutrasME = obterFloat(document.getElementById('inputOutrasME').value);
      const siscomexBRL = obterFloat(document.getElementById('inputSiscomexBRL').value);
      const despAduBRL = obterFloat(document.getElementById('inputDespAduBRL').value);
      const freteNacBRL = obterFloat(document.getElementById('inputFreteBRL').value);
      const afrmmPerc = obterFloat(document.getElementById('inputAFRMM').value) / 100;

      // Créditos
      const pisCred = obterFloat(document.getElementById('inputPISCred').value) / 100;
      const cofinsCred = obterFloat(document.getElementById('inputCOFINSCred').value) / 100;
      const ipiCred = obterFloat(document.getElementById('inputIPICred').value) / 100;
      const icmsCred = obterFloat(document.getElementById('inputICMSCred').value) / 100;

      // Converter custos globais para BRL
      const freteBRL = totalFreteME * cambio;
      const seguroBRL = totalSeguroME * cambio;
      const outrasBRL = totalOutrasME * cambio;
      const valorAFRMM = freteBRL * afrmmPerc;
      const custoGlobalBRL = freteBRL + seguroBRL + outrasBRL + siscomexBRL + despAduBRL + freteNacBRL + valorAFRMM;

      // Limpar resultados anteriores
      dtResultados.clear();

      // Somatórios
      let somaPesoTotal = 0;
      let somaPrecoCustoTotalME = 0;
      let somaFOBTotalBR = 0;
      let somaSegurosRateado = 0;
      let somaOutrasRateado = 0;
      let somaCIFTotalBR = 0;
      let somaIIR = 0;
      let somaValorTotalNF = 0;
      let somaImpostosBruto = 0;
      let somaImpostosCred = 0;
      let somaICMSPago = 0;
      let somaICMSCred = 0;
      let somaICMSCusto = 0;
      let somaAFRMM = 0;
      let somaDespAduRateado = 0;
      let somaFreteNacRateado = 0;
      let somaCustoComImpostos = 0;
      let somaLucroBruto = 0;

      // Primeiro ciclo: calcular soma de peso total
      dtItens.rows().every(function () {
        const row = this.node();
        const inputs = $('input', row);
        const pesoUnit = obterFloat($(inputs[6]).val());
        const qtd = obterFloat($(inputs[4]).val());
        somaPesoTotal += pesoUnit * qtd;
      });

      // Segundo ciclo: cálculos item a item
      dtItens.rows().every(function () {
        const row = this.node();
        const inputs = $('input', row);
        const descricao = $(inputs[0]).val() || '';
        const codInterno = $(inputs[1]).val() || '';
        const ncm = $(inputs[2]).val() || '';
        const qtd = obterFloat($(inputs[4]).val());
        const precoCustoUnitME = obterFloat($(inputs[5]).val());
        const pesoUnit = obterFloat($(inputs[6]).val());
        const iiPerc = obterFloat($(inputs[7]).val()) / 100;
        const ipiPerc = obterFloat($(inputs[8]).val()) / 100;
        const pisPerc = obterFloat($(inputs[9]).val()) / 100;
        const cofinsPerc = obterFloat($(inputs[10]).val()) / 100;
        const icmsPerc = obterFloat($(inputs[11]).val()) / 100;
        const precoVendaBR = obterFloat($(inputs[12]).val());

        const pesoTotal = pesoUnit * qtd;
        const percRateioPeso = somaPesoTotal ? pesoTotal / somaPesoTotal : 0;
        const freteRateado = freteBRL * percRateioPeso;
        const seguroRateado = seguroBRL * percRateioPeso;
        const outrasRateado = outrasBRL * percRateioPeso;
        const africado = freteRateado * afrmmPerc;

        const precoCustoTotalME = precoCustoUnitME * qtd;
        const fobUnitBR = precoCustoUnitME * cambio;
        const fobTotalBR = fobUnitBR * qtd;
        const iiR = precoCustoTotalME * iiPerc * cambio;

        const baseImpostos = fobTotalBR + iiR;
        const ipiPago = baseImpostos * ipiPerc;
        const ipiCusto = ipiPago * (1 - ipiCred);
        const pisPago = baseImpostos * pisPerc;
        const pisCusto = pisPago * (1 - pisCred);
        const cofinsPago = baseImpostos * cofinsPerc;
        const cofinsCusto = cofinsPago * (1 - cofinsCred);

        const baseICMS = baseImpostos + ipiCusto + pisCusto + cofinsCusto;
        const icmsPago = baseICMS * icmsPerc;
        const icmsCusto = icmsPago * (1 - icmsCred);

        const despAduRateado = despAduBRL * percRateioPeso;
        const freteNacRateado = freteNacBRL * percRateioPeso;

        const custoTotalBR = fobTotalBR
          + freteRateado
          + seguroRateado
          + outrasRateado
          + iiR
          + ipiCusto
          + pisCusto
          + cofinsCusto
          + icmsCusto
          + africado
          + despAduRateado
          + freteNacRateado;

        const lucroUnit = precoVendaBR
          - ((precoCustoUnitME + precoCustoUnitME * iiPerc)
          * cambio
          * (1 + ipiPerc + pisPerc + cofinsPerc + icmsPerc));
        const lucroTotal = lucroUnit * qtd;
        const margemPerc = precoVendaBR ? ((lucroUnit / precoVendaBR) * 100) : 0;

        // Acumuladores
        somaPrecoCustoTotalME += precoCustoTotalME;
        somaFOBTotalBR += fobTotalBR;
        somaSegurosRateado += seguroRateado;
        somaOutrasRateado += outrasRateado;
        somaCIFTotalBR += fobTotalBR + freteRateado + seguroRateado + outrasRateado;
        somaIIR += iiR;
        somaValorTotalNF += baseImpostos + ipiPago + pisPago + cofinsPago;
        somaImpostosBruto += ipiPago + pisPago + cofinsPago + icmsPago;
        somaImpostosCred += (ipiPago * ipiCred) + (pisPago * pisCred) + (cofinsPago * cofinsCred) + (icmsPago * icmsCred);
        somaICMSPago += icmsPago;
        somaICMSCred += icmsPago * icmsCred;
        somaICMSCusto += icmsCusto;
        somaAFRMM += africado;
        somaDespAduRateado += despAduRateado;
        somaFreteNacRateado += freteNacRateado;
        somaCustoComImpostos += custoTotalBR;
        somaLucroBruto += lucroTotal;

        // Adicionar linha de resultado
        dtResultados.row.add({
          index: dtResultados.rows().count() + 1,
          codInterno: codInterno,
          descricao: descricao,
          ncm: ncm,
          qtd: qtd.toLocaleString('pt-BR'),
          pesoTotal: pesoTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          percRateioPeso: (percRateioPeso * 100).toFixed(2) + '%',
          freteUnitBR: freteRateado.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          fobUnitBR: fobUnitBR.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          fobTotalBR: fobTotalBR.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          iiR: iiR.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          valorNFUnit: ((baseImpostos + ipiPago + pisPago + cofinsPago) / qtd).toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          ipiPago: ipiPago.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          ipiCusto: ipiCusto.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          pisPago: pisPago.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          pisCusto: pisCusto.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          cofinsPago: cofinsPago.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          cofinsCusto: cofinsCusto.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          icmsBase: baseICMS.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          icmsPago: icmsPago.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          icmsCusto: icmsCusto.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          afrmm: africado.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          freteNacBR: freteNacRateado.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          despAduBR: despAduRateado.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          custoTotalBR: custoTotalBR.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          lucroUnitBR: lucroUnit.toLocaleString('pt-BR', { minimumFractionDigits: 2 }),
          margemPerc: margemPerc.toFixed(2) + '%'
        }).draw(false);
      });

      // Indicadores Agregados
      const valorPedidoME = somaPrecoCustoTotalME.toFixed(2);
      const custoTotal = somaCustoComImpostos.toFixed(2);
      const receitaTotal = dtItens
        .rows()
        .nodes()
        .toArray()
        .reduce((acc, row) => {
          const precoVenda = obterFloat($('input', row).eq(12).val());
          const qtd = obterFloat($('input', row).eq(4).val());
          return acc + precoVenda * qtd;
        }, 0)
        .toFixed(2);

      const lucroTotal = (receitaTotal - custoTotal).toFixed(2);
      const margemTotalPerc = receitaTotal
        ? ((lucroTotal / receitaTotal) * 100).toFixed(2) + '%'
        : '0%';
      const pesoTotalGeral = somaPesoTotal.toFixed(2);
      const totalItens = dtItens.rows().count();

      // Atualizar KPIs
      document.getElementById('kpiValorPedido').innerText = valorPedidoME.replace('.', ',');
      document.getElementById('kpiCustoTotal').innerText = custoTotal.replace('.', ',');
      document.getElementById('kpiReceitaTotal').innerText = receitaTotal.replace('.', ',');
      document.getElementById('kpiLucroTotal').innerText = lucroTotal.replace('.', ',');
      document.getElementById('kpiMargemTotal').innerText = margemTotalPerc.replace('.', ',');
      document.getElementById('kpiPesoTotal').innerText = pesoTotalGeral.replace('.', ',');
      document.getElementById('kpiTotalItens').innerText = totalItens;

      // Dados para Gráfico de Distribuição de Custo
      const valorProd = somaFOBTotalBR.toFixed(2);
      const valorImpostosEfetivos = (somaImpostosBruto - somaImpostosCred).toFixed(2);
      const valorOutros = (somaSegurosRateado + somaOutrasRateado).toFixed(2);
      const valorFrete = freteBRL.toFixed(2);

      const totalVisu =
        parseFloat(valorProd) +
        parseFloat(valorImpostosEfetivos) +
        parseFloat(valorOutros) +
        parseFloat(valorFrete);
      const percProd = totalVisu ? (valorProd / totalVisu) * 100 : 0;
      const percImpostos = totalVisu ? (valorImpostosEfetivos / totalVisu) * 100 : 0;
      const percOutros = totalVisu ? (valorOutros / totalVisu) * 100 : 0;
      const percFrete = totalVisu ? (valorFrete / totalVisu) * 100 : 0;

      chartDistCusto.data.datasets[0].data = [
        percProd.toFixed(2),
        percImpostos.toFixed(2),
        percOutros.toFixed(2),
        percFrete.toFixed(2)
      ];
      chartDistCusto.update();

      // Dados para Gráfico de Margens
      const labelsMargens = [];
      const dadosMargens = [];
      dtResultados.rows().every(function () {
        const data = this.data();
        labelsMargens.push(data.codInterno || data.descricao);
        dadosMargens.push(
          parseFloat(data.margemPerc.replace('%', '').replace(',', '.')) || 0
        );
      });
      chartMargens.data.labels = labelsMargens;
      chartMargens.data.datasets[0].data = dadosMargens;
      chartMargens.update();

      // Mudar para aba Dashboard
      const tabDashboard = new bootstrap.Tab(
        document.getElementById('dashboard-tab')
      );
      tabDashboard.show();
    }
  </script>
</body>
</html>
