<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Ferramenta de Calculo de Importação v30.5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* Cores do Tema Claro (Padrão) */
            --theme-bg-primary: #f0f2f5;
            --theme-bg-secondary: #ffffff;
            --theme-surface-primary: rgba(250, 250, 250, 0.8);
            --theme-surface-hover: rgba(240, 240, 245, 0.95);
            --theme-text-primary: #212529;
            --theme-text-secondary: #495057;
            --theme-border-primary: #dee2e6;
            --theme-border-secondary: #e9ecef;
            --theme-shadow-color: rgba(0, 0, 0, 0.1);
            
            --theme-separator-bg-color: #e9ecef;
            --theme-separator-text-color: var(--theme-text-secondary);

            --theme-accent-blue: #007bff;
            --theme-accent-blue-darker: #0056b3;
            --theme-accent-orange: #fd7e14;
            --theme-accent-orange-darker: #d9660b;
            --theme-accent-green: #20c997; /* Verde para lucro alto */
            --theme-accent-yellow: #ffc107; /* Amarelo para lucro médio */
            --theme-accent-light-orange: #fd7e14; /* Laranja para lucro baixo */
            --theme-accent-red: #dc3545; /* Vermelho para prejuízo */

            --theme-glow-blue: 0 0 8px rgba(0, 123, 255, 0.25);
            --theme-glow-orange: 0 0 8px rgba(253, 126, 20, 0.25);
            --theme-glow-green: 0 0 8px rgba(32, 201, 151, 0.25);
            --theme-glow-red: 0 0 8px rgba(220, 53, 69, 0.25);

            --theme-card-border-radius: 10px;
            --theme-element-padding: 18px;

            --table-header-bg: #e9ecef;
            --table-header-text: #495057;
            --table-row-hover-bg: #f8f9fa;
            --input-bg: #ffffff;
            --input-border: #ced4da;
            --input-focus-bg: #ffffff;
            --input-focus-border: #80bdff;
            --input-text: #495057;

            --theme-accent-green-rgb: 32, 201, 151;
            --theme-accent-yellow-rgb: 255, 193, 7;
            --theme-accent-light-orange-rgb: 253, 126, 20;
            --theme-accent-red-rgb: 220, 53, 69;
        }

        body.theme-dark {
            --theme-bg-primary: #0f0f0f;
            --theme-bg-secondary: #1c1c1c;
            --theme-surface-primary: rgba(42, 42, 42, 0.75);
            --theme-surface-hover: rgba(55, 55, 55, 0.85);
            --theme-text-primary: #e8e8f0;
            --theme-text-secondary: #a8a8c0;
            --theme-border-primary: rgba(80, 80, 80, 0.6);
            --theme-border-secondary: rgba(65, 65, 65, 0.6);
            --theme-shadow-color: rgba(0, 0, 0, 0.7);
            
            --theme-separator-bg-color: #18181b;
            --theme-separator-text-color: #9ca3af;

            --theme-accent-blue: #00aaff;
            --theme-accent-blue-darker: #0077cc;
            --theme-accent-orange: #ff8c00;
            --theme-accent-orange-darker: #e67e22;
            --theme-accent-green: #2ecc71;
            --theme-accent-yellow: #f1c40f;
            --theme-accent-light-orange: #e67e22;
            --theme-accent-red: #e74c3c;

            --theme-glow-blue: 0 0 12px rgba(0, 170, 255, 0.4), 0 0 4px rgba(0, 170, 255, 0.6);
            --theme-glow-orange: 0 0 12px rgba(255, 140, 0, 0.4), 0 0 4px rgba(255, 140, 0, 0.6);
            --theme-glow-green: 0 0 12px rgba(46, 204, 113, 0.4), 0 0 4px rgba(46, 204, 113, 0.6);
            --theme-glow-red: 0 0 12px rgba(231, 76, 60, 0.4), 0 0 4px rgba(231, 76, 60, 0.6);

            --table-header-bg: rgba(40, 40, 40, 0.9);
            --table-header-text: var(--theme-accent-blue);
            --table-row-hover-bg: var(--theme-surface-hover);
            --input-bg: rgba(20, 20, 20, 0.7);
            --input-border: var(--theme-border-secondary);
            --input-focus-bg: rgba(10,10,10,0.6);
            --input-focus-border: var(--theme-accent-blue);
            --input-text: var(--theme-text-primary);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 20px;
            background-color: var(--theme-bg-primary);
            color: var(--theme-text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-top: 5px;
            max-width: 1700px;
            margin-left: auto;
            margin-right: auto;
        }
        .app-header .logo-container {
            display: flex;
            align-items: center;
        }
        .app-header .logo-container img {
            height: 35px;
            width: auto;
            margin-right: 15px;
        }
        main.container {
            background-color: var(--theme-bg-secondary);
            padding: 20px; border-radius: 8px;
            box-shadow: 0 4px 12px var(--theme-shadow-color);
            width: 100%; max-width: 1700px;
            margin: auto;
            border: 1px solid var(--theme-border-secondary);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        #themeToggleBtn, #settingsBtn {
            padding: 8px 12px; font-size: 1.5em;
            border: 1px solid var(--theme-border-primary);
            background-color: var(--theme-surface-primary);
            color: var(--theme-text-primary);
            border-radius: 50%; cursor: pointer;
            transition: background-color 0.3s, color 0.3s, box-shadow 0.3s, transform 0.3s;
            z-index: 1000; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            margin-left: 10px;
        }
        #themeToggleBtn:hover, #settingsBtn:hover { box-shadow: var(--theme-glow-blue); transform: scale(1.1); }
        .header-buttons { display: flex; }

        h1 {
            color: var(--theme-accent-blue); text-align: center; margin-top: 0; margin-bottom: 0;
            font-size: 24px;
            font-weight: 600;
            text-shadow: 0 0 8px var(--theme-glow-blue);
            flex-grow: 1;
            text-align: left;
        }
        h1 #appVersion { font-size: 0.5em; color: var(--theme-text-secondary); display: block; margin-top: 2px;}
        #saveStatus {
            font-size: 0.6em;
            font-weight: 500;
            color: var(--theme-accent-green);
            margin-left: 15px;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        h2 {
            color: var(--theme-text-primary); font-size: 22px; margin-top: 30px; margin-bottom: 15px;
            border-bottom: 1px solid var(--theme-border-secondary); padding-bottom: 10px;
        }
        h3 { color: var(--theme-text-secondary); font-size: 18px; margin-top: 20px; margin-bottom: 12px; }
        
        nav[role="tablist"] {
            margin-bottom: 25px; border-bottom: 1px solid var(--theme-border-secondary); padding-bottom: 0;
            display: flex; gap: 5px;
        }
        nav[role="tablist"] button[role="tab"] {
            background-color: transparent; border: 1px solid transparent; border-bottom: none;
            padding: 10px 15px;
            cursor: pointer; font-size: 14px;
            font-weight: 500;
            color: var(--theme-text-secondary); border-radius: 8px 8px 0 0; outline: none;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            position: relative; bottom: -1px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        nav[role="tablist"] button[role="tab"] i {
            font-size: 1.1em;
        }
        nav[role="tablist"] button[role="tab"]:hover { color: var(--theme-accent-blue); background-color: var(--theme-surface-hover); }
        nav[role="tablist"] button[role="tab"][aria-selected="true"] {
            background-color: var(--theme-bg-secondary); border-color: var(--theme-border-secondary);
            border-bottom-color: var(--theme-bg-secondary); color: var(--theme-accent-blue); font-weight: 700;
        }

        section[role="tabpanel"] {
            display: none;
            animation: fadeInScreen 0.4s ease-out;
        }
        section[role="tabpanel"]:not([hidden]) {
            display: block;
        }
        @keyframes fadeInScreen { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .data-section,
        .results-summary-section,
        .dashboard-section,
        .top-items-section,
        .cost-components-section {
            margin-bottom: 25px; padding: var(--theme-element-padding);
            border-radius: var(--theme-card-border-radius); background-color: var(--theme-bg-secondary);
            border: 1px solid var(--theme-border-primary); box-shadow: 0 4px 15px var(--theme-shadow-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .grid-item label {
            display: inline-flex; 
            align-items: center;
            gap: 6px;
            margin-bottom: 8px; font-weight: 500; font-size: 14px;
            color: var(--theme-text-secondary);
        }
        .grid-item input[type="text"], .grid-item input[type="number"], .grid-item input[type="date"], .grid-item select, .grid-item textarea {
            width: 100%; padding: 10px 12px; font-size: 14px; box-sizing: border-box;
            background-color: var(--input-bg); color: var(--input-text);
            border: 1px solid var(--input-border); border-radius: 6px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }
        .grid-item input[type="text"]:focus, .grid-item input[type="number"]:focus, .grid-item input[type="date"]:focus, .grid-item select:focus, .grid-item textarea:focus {
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 3px rgba(var(--input-focus-border), .25), 0 0 8px var(--theme-glow-blue);
            outline: none; background-color: var(--input-focus-bg);
        }
        .grid-item textarea { min-height: 80px; resize: vertical; }
        .field-description { display: block; font-size: 11px; color: var(--theme-text-secondary); opacity: 0.8; margin-top: 5px; line-height: 1.3; }
        
        .grid-item .error-message {
            display: none;
            font-size: 11px;
            color: var(--theme-accent-red);
            margin-top: 4px;
        }
        .invalid-field {
            border-color: var(--theme-accent-red) !important;
            box-shadow: 0 0 0 3px rgba(var(--theme-accent-red-rgb), .25), 0 0 8px var(--theme-glow-red) !important;
        }

        .currency-buttons-group { margin-top: 10px; }
        .currency-buttons-group button {
            padding: 6px 12px; font-size: 12px; margin-right: 8px; margin-bottom: 8px;
            background-color: var(--theme-accent-blue-darker); color: white;
            border: 1px solid var(--theme-accent-blue); border-radius: 6px; cursor:pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            position: relative;
            min-width: 70px;
            min-height: 28px;
        }
        .currency-buttons-group button:hover { background-color: var(--theme-accent-blue); transform: translateY(-2px); }
        #cotacaoInfo { font-size: 12px; margin-top: 8px; display: block; transition: color 0.3s ease; }
        body.theme-dark #cotacaoInfo:not(.error) { color: var(--theme-accent-green); }
        body:not(.theme-dark) #cotacaoInfo:not(.error) { color: #28a745; }
        #cotacaoInfo.error { color: var(--theme-accent-red) !important; }

        .spinner {
            display: none;
            width: 1em;
            height: 1em;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin: auto;
            position: absolute;
            top: 0; bottom: 0; left: 0; right: 0;
        }
        .button-loading .spinner { display: block; }
        .button-loading .button-text { visibility: hidden; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background-color: var(--theme-surface-primary);
            color: var(--theme-text-primary);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px var(--theme-shadow-color);
            border-left: 5px solid;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateX(100%);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.toast-error { border-left-color: var(--theme-accent-red); }
        .toast.toast-success { border-left-color: var(--theme-accent-green); }
        .toast.toast-warning { border-left-color: var(--theme-accent-yellow); }


        #telaDashboardPanel { background-color: var(--theme-bg-secondary); color: var(--theme-text-primary); }
        #telaDashboardPanel h2, #telaDashboardPanel h3 { color: var(--theme-text-primary); border-bottom-color: var(--theme-border-secondary); }
        #telaDashboardPanel h3 { margin-top: 30px; margin-bottom: 15px; font-size: 1.1em; }

        .dashboard-kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 10px;
        }
        .dashboard-kpi {
            background-color: var(--theme-surface-primary);
            backdrop-filter: blur(10px) saturate(150%); -webkit-backdrop-filter: blur(10px) saturate(150%);
            border: 1px solid var(--theme-border-primary); border-radius: var(--theme-card-border-radius);
            padding: 8px 10px;
            box-shadow: 0 4px 12px var(--theme-shadow-color), inset 0 0 0 1px rgba(255,255,255,0.07);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            color: var(--theme-text-primary); position: relative; overflow: hidden;
            display: flex;
            align-items: center;
            min-height: 60px;
        }
        .dashboard-kpi::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: var(--theme-card-border-radius); padding: 1.5px;
            background: linear-gradient(135deg, transparent, transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude;
            transition: background 0.4s ease; z-index: 0;
        }
        .dashboard-kpi:hover {
            transform: translateY(-2px) scale(1.005);
            border-color: var(--theme-accent-blue);
            box-shadow: 0 6px 15px var(--theme-shadow-color),
                          inset 0 0 0 1.5px var(--theme-accent-blue), var(--theme-glow-blue);
        }
        .dashboard-kpi:hover::before { background: linear-gradient(135deg, var(--theme-accent-blue), var(--theme-accent-orange)); }
        .dashboard-kpi p { margin: 0; position: relative; z-index: 1; }
        .dashboard-kpi .kpi-icon-container {
            font-size: 1.1em;
            margin-right: 5px;
            color: var(--theme-accent-blue);
            line-height: 1; flex-shrink: 0; width: 18px;
            text-align: center;
        }
        .dashboard-kpi .kpi-content { flex-grow: 1; min-width: 0; }
        .dashboard-kpi .kpi-label {
            display: block; font-size: 0.6em;
            color: var(--theme-text-secondary);
            margin-bottom: 1px;
            white-space: normal; line-height: 1.1;
            height: auto;
            overflow: hidden;
        }
        .dashboard-kpi strong {
            display: block; font-size: 1.3em;
            font-weight: 700; color: var(--theme-text-primary);
            line-height: 1.1;
            text-shadow: 0 0 4px var(--theme-shadow-color); word-wrap: break-word;
        }
        .dashboard-kpi strong.blue-highlight { color: var(--theme-accent-blue); text-shadow: 0 0 8px var(--theme-glow-blue); }
        .dashboard-kpi strong.orange-highlight { color: var(--theme-accent-orange); text-shadow: 0 0 8px var(--theme-glow-orange); }
        .dashboard-kpi strong.profit-positive { color: var(--theme-accent-green); text-shadow: 0 0 8px var(--theme-glow-green); }
        .dashboard-kpi strong.profit-negative { color: var(--theme-accent-red); text-shadow: 0 0 8px var(--theme-glow-red); }

        .prominent-profit-indicator {
            background-color: var(--theme-surface-primary);
            border: 1px solid var(--theme-border-primary);
            border-radius: var(--theme-card-border-radius);
            padding: 15px 20px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 6px 18px var(--theme-shadow-color);
        }
        .prominent-profit-indicator .kpi-label {
            font-size: 1em;
            color: var(--theme-text-secondary);
            margin-bottom: 5px;
        }
        .prominent-profit-indicator strong {
            font-size: 2.8em;
            font-weight: bold;
        }
        .prominent-profit-indicator strong.profit-positive { color: var(--theme-accent-green); text-shadow: 0 0 10px var(--theme-glow-green); }
        .prominent-profit-indicator strong.profit-negative { color: var(--theme-accent-red); text-shadow: 0 0 10px var(--theme-glow-red); }


        .cost-distribution-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .cost-dist-item {
            background-color: transparent;
            padding: 8px 0;
            border: none; box-shadow: none;
            color: var(--theme-text-primary);
            display: flex; flex-direction: column;
            gap: 4px;
        }
        .cost-dist-info {
            margin-bottom: 0;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
        }
        .cost-dist-label {
            color: var(--theme-text-secondary);
            margin-right: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 1;
        }
        .cost-dist-value {
            text-align: right;
            flex-shrink: 0;
        }
        .cost-dist-value strong { color: var(--theme-accent-blue); font-weight: 600; }
        .cost-dist-bar-container {
            height: 8px;
            background-color: var(--input-bg);
            border-radius: 4px; overflow: hidden; position: relative;
            border: 1px solid var(--theme-border-secondary);
        }
        .cost-dist-bar {
            height: 100%; border-radius: 4px;
            background: linear-gradient(90deg, var(--theme-accent-blue), var(--theme-accent-blue-darker));
            transition: width 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            position: relative; overflow: hidden;
        }
        .cost-dist-bar::after {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: scanLine 3s linear infinite; opacity: 0.6;
        }
        @keyframes scanLine { 0% { left: -100%; } 50% { left: 100%; } 100% { left: 100%; } }
        #barDistImpFed.cost-dist-bar { background: linear-gradient(90deg, var(--theme-accent-orange), var(--theme-accent-orange-darker)); }

        .results-summary-section {}
        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 10px;
            font-size: 0.9em;
        }
        .results-summary h4 {
            grid-column: 1 / -1;
            margin-top: 15px;
            margin-bottom: 5px;
            font-size: 0.95em;
            color: var(--theme-accent-blue);
            border-bottom: 1px solid var(--theme-border-secondary);
            padding-bottom: 5px;
        }
        .summary-item {
            background-color: var(--theme-surface-primary); padding: 10px 12px; border-radius: 8px;
            border: 1px solid var(--theme-border-secondary); box-shadow: 0 2px 8px var(--theme-shadow-color);
            transition: background-color 0.3s ease, transform 0.2s ease;
            border-bottom: none; display: flex; justify-content: space-between;
        }
        .summary-item:hover { background-color: var(--theme-surface-hover); transform: scale(1.015); }
        .summary-item strong { color: var(--theme-text-secondary); font-weight: 500; }
        .summary-item span { color: var(--theme-accent-blue); font-weight: 600; }
        #resultsSummary hr {
            grid-column: 1 / -1;
            border: none;
            border-top: 1px solid var(--theme-border-secondary);
            margin: 10px 0;
        }
        .summary-item.total-geral {
            grid-column: 1 / -1;
            background-color: var(--theme-accent-orange-darker) !important;
            border-color: var(--theme-accent-orange) !important;
            box-shadow: 0 4px 15px var(--theme-shadow-color), var(--theme-glow-orange) !important;
        }
        .summary-item.total-geral strong, .summary-item.total-geral span {
            color: var(--theme-text-primary) !important; font-size: 1.1em !important; font-weight: 700 !important;
        }

        #telaEntradaPanel .data-section,
        #telaResultadosPanel #resultsContainer {
            background-color: var(--theme-surface-primary);
            backdrop-filter: blur(8px) saturate(140%); -webkit-backdrop-filter: blur(8px) saturate(140%);
            border: 1px solid var(--theme-border-primary); border-radius: var(--theme-card-border-radius);
            padding: var(--theme-element-padding); box-shadow: 0 8px 24px var(--theme-shadow-color);
            color: var(--theme-text-primary);
        }
        #telaEntradaPanel .data-section h2,
        #telaResultadosPanel #resultsContainer h2 { color: var(--theme-text-primary); border-bottom-color: var(--theme-border-secondary); }
        #telaEntradaPanel .data-section p.currency-note { color: var(--theme-text-secondary); font-size: 0.9em; margin-bottom: 15px; }

        .table-wrapper { border: 1px solid var(--theme-border-secondary); border-radius: 8px; overflow: auto; }
        
        #itemInputTable, #itemResultTable {
            width: 100%; border-collapse: separate; border-spacing: 0;
            font-size: 13px; color: var(--theme-text-primary);
        }
        #itemInputTable th, #itemResultTable th {
            background-color: var(--table-header-bg); color: var(--table-header-text);
            font-weight: 600; white-space: nowrap; padding: 12px 10px; text-align: left;
            border-bottom: 2px solid var(--theme-accent-blue);
            border-right: 1px solid var(--theme-border-primary);
        }
        #itemInputTable th:last-child, #itemResultTable th:last-child { border-right: none; }
        #itemInputTable td, #itemResultTable td {
            border: none; border-bottom: 1px solid var(--theme-border-secondary);
            padding: 8px 10px; vertical-align: middle;
        }
        #itemInputTable tbody tr:hover td, #itemResultTable tbody tr:hover td { background-color: var(--table-row-hover-bg); }
        #itemInputTable tbody tr:last-child td, #itemResultTable tbody tr:last-child td { border-bottom: none; }
        
        #itemInputTable tr.dragging {
            opacity: 0.5;
            background: var(--theme-accent-blue);
        }

        .drag-handle {
            cursor: grab;
            width: 20px;
            text-align: center;
            color: var(--theme-text-secondary);
        }

        #itemInputTable td input[type="text"], #itemInputTable td input[type="number"] {
            width: 100%; padding: 8px 10px; font-size: 13px;
            color: var(--input-text); background-color: var(--input-bg);
            border: 1px solid var(--input-border); border-radius: 6px; box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }
        #itemInputTable td input[type="text"]:focus, #itemInputTable td input[type="number"]:focus {
            border-color: var(--input-focus-border);
            box-shadow: 0 0 8px var(--theme-glow-blue);
            background-color: var(--input-focus-bg); outline: none;
        }
        
        #itemInputTable th:nth-child(3), #itemInputTable td:nth-child(3) { min-width: 180px; }
        #itemInputTable td:nth-child(3) input[type="text"] { width: 100%; }

        #itemInputTable th:nth-child(4), #itemInputTable td:nth-child(4) { min-width: 100px; }
        #itemInputTable td:nth-child(4) input[type="text"] { width: 100%; }

        #itemInputTable th:nth-child(5), #itemInputTable td:nth-child(5) { min-width: 90px; }
        #itemInputTable td:nth-child(5) input[type="text"] { width: 100%; }

        #itemInputTable td:nth-child(6) input[type="number"],
        #itemInputTable td:nth-child(9) input[type="number"],
        #itemInputTable td:nth-child(10) input[type="number"],
        #itemInputTable td:nth-child(11) input[type="number"],
        #itemInputTable td:nth-child(12) input[type="number"],
        #itemInputTable td:nth-child(13) input[type="number"]
        {
            min-width: 80px;
        }

        .item-table-input input[type="number"] { text-align: right; }
        .results-table td { white-space: nowrap; }
        .results-table td:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(3)):not(:nth-child(4)):not(:nth-child(5)):not(:nth-child(6)):not(:nth-child(7)) {
            text-align: right;
        }

        .action-buttons { margin-top: 25px; margin-bottom: 20px; text-align: center; }
        button.main-calculate-button, button.pdf-button, button.clear-button, button.whatsapp-button, button.csv-button {
            color: white; padding: 12px 20px; font-size: 16px; font-weight: bold;
            display: inline-block; width: auto; margin: 5px 10px; border: none;
            border-radius: 8px; cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }
        button.main-calculate-button { background-color: var(--theme-accent-blue); box-shadow: 0 2px 5px var(--theme-shadow-color); }
        button.main-calculate-button:hover {
            background-color: var(--theme-accent-blue-darker);
            transform: translateY(-2px); box-shadow: 0 4px 10px var(--theme-shadow-color), var(--theme-glow-blue);
        }
        button.pdf-button { background-color: var(--theme-accent-green); box-shadow: 0 2px 5px var(--theme-shadow-color); }
        button.pdf-button:hover {
            background-color: #27ae60;
            transform: translateY(-2px); box-shadow: 0 4px 10px var(--theme-shadow-color), var(--theme-glow-green);
        }
        button.clear-button { background-color: var(--theme-accent-red); box-shadow: 0 2px 5px var(--theme-shadow-color); }
        button.clear-button:hover {
            background-color: #c0392b;
            transform: translateY(-2px); box-shadow: 0 4px 10px var(--theme-shadow-color), var(--theme-glow-red);
        }
        button.whatsapp-button { background-color: #25D366; box-shadow: 0 2px 5px var(--theme-shadow-color); }
        button.whatsapp-button:hover {
            background-color: #1DA851;
            transform: translateY(-2px); box-shadow: 0 4px 10px var(--theme-shadow-color), 0 0 8px rgba(37, 211, 102, 0.4);
        }
        button.csv-button { background-color: var(--theme-accent-orange); box-shadow: 0 2px 5px var(--theme-shadow-color); }
        button.csv-button:hover {
            background-color: var(--theme-accent-orange-darker);
            transform: translateY(-2px); box-shadow: 0 4px 10px var(--theme-shadow-color), var(--theme-glow-orange);
        }
        
        .total-geral { font-weight: bold; font-size: 16px !important; color: var(--theme-accent-orange) !important; }
        .app-footer {
            font-size: 12px; color: var(--theme-text-secondary); opacity: 0.8; margin-top: 20px; text-align: center;
            padding: 10px 0; border-top: 1px solid var(--theme-border-secondary);
        }
        .currency-note {font-size: 12px; color: var(--theme-text-secondary); opacity: 0.8; margin-bottom: 10px;}
        
        .profit-high { background-color: rgba(var(--theme-accent-green-rgb), 0.15) !important; color: var(--theme-accent-green) !important; border-left: 3px solid var(--theme-accent-green); }
        .profit-medium { background-color: rgba(var(--theme-accent-yellow-rgb), 0.15) !important; color: var(--theme-accent-yellow) !important; border-left: 3px solid var(--theme-accent-yellow); }
        .profit-low { background-color: rgba(var(--theme-accent-light-orange-rgb), 0.15) !important; color: var(--theme-accent-light-orange) !important; border-left: 3px solid var(--theme-accent-light-orange); }
        .profit-loss { background-color: rgba(var(--theme-accent-red-rgb), 0.1) !important; color: var(--theme-accent-red) !important; border-left: 3px solid var(--theme-accent-red); }

        body.theme-dark .profit-high { background-color: rgba(var(--theme-accent-green-rgb), 0.25) !important; }
        body.theme-dark .profit-medium { background-color: rgba(var(--theme-accent-yellow-rgb), 0.25) !important; color: var(--theme-accent-yellow) !important; }
        body.theme-dark .profit-low { background-color: rgba(var(--theme-accent-light-orange-rgb), 0.25) !important; color: var(--theme-accent-light-orange) !important; }
        body.theme-dark .profit-loss { background-color: rgba(var(--theme-accent-red-rgb), 0.25) !important; }
        
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

        .top-items-section, .cost-components-section { margin-top: 30px; }
        .top-items-section h3, .cost-components-section h3 { margin-top: 0; margin-bottom: 20px; font-size: 1.1em; color: var(--theme-text-primary); border-bottom: 1px solid var(--theme-border-secondary); padding-bottom: 10px; }
        
        .top-items-grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 25px; }
        .top-items-list { list-style: none; padding: 0; margin: 0; }
        .top-items-list li { display: flex; align-items: center; margin-bottom: 15px; font-size: 0.95em; }
        .top-items-list .item-name { flex-basis: 35%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px; color: var(--theme-text-secondary); }
        .top-items-list .item-bar-container { flex-grow: 1; height: 20px; background-color: var(--input-bg); border-radius: 4px; border: 1px solid var(--theme-border-secondary); overflow: hidden; margin-right: 10px; position: relative; }
        .top-items-list .item-bar { height: 100%; border-radius: 4px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: flex-end; padding-right: 5px; box-sizing: border-box; }
        .top-items-list .item-bar.profit-high { background: linear-gradient(90deg, var(--theme-accent-green), #1ca580); }
        .top-items-list .item-bar.profit-medium { background: linear-gradient(90deg, var(--theme-accent-yellow), #e6ac00); color: #333; }
        .top-items-list .item-bar.profit-low { background: linear-gradient(90deg, var(--theme-accent-light-orange), #d9660b); }
        .top-items-list .item-bar.profit-loss { background: linear-gradient(90deg, var(--theme-accent-red), #b02a37); }
        .top-items-list .item-bar:not(.profit-high):not(.profit-medium):not(.profit-low):not(.profit-loss) { background: linear-gradient(90deg, var(--theme-accent-blue), var(--theme-accent-blue-darker)); }
        .top-items-list .item-value { flex-basis: 15%; text-align: right; font-weight: bold; color: var(--theme-text-primary); }

        .cost-components-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .cost-component-item { background-color: var(--theme-surface-primary); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--theme-border-secondary); box-shadow: 0 2px 6px var(--theme-shadow-color); }
        .cost-component-item .component-label { display: block; font-size: 0.9em; color: var(--theme-text-secondary); margin-bottom: 8px; }
        .cost-component-item strong { font-size: 1.8em; font-weight: 700; }
        #compPercProduto { color: var(--theme-accent-green); }
        #compPercImpostos { color: var(--theme-accent-red); }
        #compPercOutros { color: var(--theme-accent-orange); }

        .section-separator { border: none; height: auto; background-color: var(--theme-separator-bg-color); width: calc(100% + (2 * var(--theme-element-padding))); margin-left: calc(-1 * var(--theme-element-padding)); margin-right: calc(-1 * var(--theme-element-padding)); margin-top: 30px; margin-bottom: 25px; border-radius: 0; display: flex; align-items: center; justify-content: flex-start; font-size: 0.9em; font-weight: 500; color: var(--theme-separator-text-color); text-transform: none; letter-spacing: 0.2px; padding: 8px var(--theme-element-padding); box-sizing: border-box; }
        .section-separator-infoOrg::before       { content: "Informações Organizacionais"; }
        .section-separator-detComLog::before    { content: "Detalhes Comerciais e Logísticos"; }
        .section-separator-regTribCred::before    { content: "Regime Tributário e Créditos"; }
        .section-separator-custosGlobais::before { content: "Custos Globais (Rateados entre os itens)"; }

        /* Estilos para o Modal de Configurações */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; /* Começa oculto */ justify-content: center; align-items: center; z-index: 1050; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background-color: var(--theme-bg-secondary); padding: 30px; border-radius: var(--theme-card-border-radius); box-shadow: 0 10px 30px var(--theme-shadow-color); width: 90%; max-width: 600px; border: 1px solid var(--theme-border-primary); position: relative; animation: slideInModal 0.3s ease-out; }
        @keyframes slideInModal { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-content h2 { margin-top: 0; color: var(--theme-accent-blue); border-bottom: 1px solid var(--theme-border-secondary); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-close-btn { position: absolute; top: 15px; right: 15px; background: transparent; border: none; font-size: 1.8em; color: var(--theme-text-secondary); cursor: pointer; padding: 5px; line-height: 1; }
        .modal-close-btn:hover { color: var(--theme-accent-red); }
        .modal-section { margin-bottom: 25px; }
        .modal-section h3 { font-size: 1.1em; color: var(--theme-text-primary); margin-bottom: 12px; border-bottom: 1px dashed var(--theme-border-secondary); padding-bottom: 8px; }
        .modal-actions { text-align: right; margin-top: 30px; }
        .modal-actions button { padding: 10px 18px; font-size: 1em; margin-left: 10px; }
        .profit-color-indicator { display: inline-block; width: 14px; height: 14px; border-radius: 3px; margin-right: 6px; vertical-align: middle; border: 1px solid var(--theme-border-secondary); }
        .profit-color-indicator.green { background-color: var(--theme-accent-green); }
        .profit-color-indicator.yellow { background-color: var(--theme-accent-yellow); }
        .profit-color-indicator.orange { background-color: var(--theme-accent-light-orange); }

        .chart-container { width: 100%; max-width: 450px; margin: 20px auto; padding: 15px; background-color: var(--theme-surface-primary); border-radius: var(--theme-card-border-radius); box-shadow: 0 4px 12px var(--theme-shadow-color); }
        body.theme-dark .chart-container { background-color: var(--theme-bg-secondary); }
        
        /* Modal para compartilhar imagem */
        #shareImageModal { display: none; position: fixed; z-index: 1060; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; }
        #shareImageModalContent { background-color: var(--theme-bg-secondary); margin: auto; padding: 20px; border: 1px solid var(--theme-border-primary); border-radius: var(--theme-card-border-radius); width: 80%; max-width: 500px; text-align: center; box-shadow: 0 5px 15px var(--theme-shadow-color); }
        #shareImageModalContent img { max-width: 100%; height: auto; margin-bottom: 15px; border: 1px solid var(--theme-border-secondary); border-radius: 6px; }
        #shareImageModalContent p { font-size: 0.9em; color: var(--theme-text-secondary); margin-bottom: 15px; }
        #shareImageModalContent button, #shareImageModalContent a.button { padding: 10px 15px; margin: 5px; border-radius: 6px; text-decoration: none; cursor: pointer; font-weight: 500; }
        #shareImageModalContent button.close-modal-btn { background-color: var(--theme-accent-red); color: white; border: none; }
        #shareImageModalContent a.whatsapp-link-btn { background-color: var(--theme-accent-green); color: white; border: none; }

        /* Tooltip Styles */
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .tooltip-icon {
            margin-left: 4px;
            color: var(--theme-text-secondary);
            cursor: help;
            font-size: 0.9em;
        }
        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: var(--theme-bg-secondary);
            color: var(--theme-text-primary);
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1010;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid var(--theme-border-primary);
            box-shadow: 0 2px 8px var(--theme-shadow-color);
            font-size: 0.85em;
            font-weight: 400;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--theme-border-primary) transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

    </style>
</head>
<body>
    <!-- NOVO: Container para as notificações (toasts) -->
    <div id="toast-container"></div>

    <header class="app-header">
        <div class="logo-container">
            <img src="https://placehold.co/100x30/FFFFFF/000000?text=VEXOS&font=Inter" alt="Logo VEXOS" id="appLogo"
                 onerror="this.onerror=null; this.src='https://placehold.co/100x30/E9ECEF/495057?text=Logo+Vexos+01.png&font=Inter';">
        </div>
        <h1><span data-translate-key="mainTitle">Ferramenta de Calculo de Importação</span> <span id="saveStatus"></span><span id="appVersion" style="font-size: 0.5em; color: var(--theme-text-secondary);"></span></h1>
        <div class="header-buttons">
            <button id="settingsBtn" aria-label="Abrir Configurações">
                <i class="fas fa-cog" aria-hidden="true"></i>
                <span class="sr-only">Abrir Configurações</span>
            </button>
            <button id="themeToggleBtn" aria-label="Alternar Tema">
                <i class="fas fa-moon" aria-hidden="true"></i>
                <span class="sr-only">Alternar para tema escuro/claro</span>
            </button>
        </div>
    </header>

    <main class="container" id="appContainer">
        <nav role="tablist" aria-label="Navegação da Calculadora">
            <button type="button" id="tabEntradaBtn" role="tab" aria-controls="telaEntradaPanel" aria-selected="true" onclick="showScreen('telaEntradaPanel')">
                <i class="fas fa-keyboard" aria-hidden="true"></i> <span class="tab-text" data-translate-key="tabEntrada">1. Entrada de Dados</span>
            </button>
            <button type="button" id="tabResultadosBtn" role="tab" aria-controls="telaResultadosPanel" aria-selected="false" onclick="showScreen('telaResultadosPanel')">
                <i class="fas fa-table-list" aria-hidden="true"></i> <span class="tab-text" data-translate-key="tabResultados">2. Resultados Detalhados</span>
            </button>
            <button type="button" id="tabDashboardBtn" role="tab" aria-controls="telaDashboardPanel" aria-selected="false" onclick="showScreen('telaDashboardPanel')">
                <i class="fas fa-chart-pie" aria-hidden="true"></i> <span class="tab-text" data-translate-key="tabDashboard">3. Dashboard e Resumo</span>
            </button>
        </nav>

        <section id="telaEntradaPanel" role="tabpanel" aria-labelledby="tabEntradaBtn">
            <section class="data-section global-inputs" aria-labelledby="headingDadosGlobais">
                <h2 id="headingDadosGlobais" data-translate-key="headingDadosGlobais">Dados Globais do Embarque</h2>
                
                <div class="section-separator section-separator-infoOrg" data-translate-key="sepInfoOrganizacionais"></div>
                <section aria-labelledby="headingInfoOrganizacionais">
                    <div class="grid-container">
                        <div class="grid-item"><label for="nomeUsuario" data-translate-key="labelNomeUsuario">Nome do Usuário:</label><input type="text" id="nomeUsuario" placeholder="Seu nome"><span class="error-message" id="nomeUsuarioError">Campo obrigatório</span><small class="field-description" data-translate-key="descNomeUsuario">Nome do responsável pelo cálculo.</small></div>
                        <div class="grid-item"><label for="nomeFornecedor" data-translate-key="labelNomeFornecedor">Nome do Fornecedor:</label><input type="text" id="nomeFornecedor" placeholder="Nome do Fornecedor Internacional"><span class="error-message" id="nomeFornecedorError">Campo obrigatório</span><small class="field-description" data-translate-key="descNomeFornecedor">Fornecedor dos produtos.</small></div>
                        <div class="grid-item"><label for="refInterna" data-translate-key="labelRefInterna">Referência Interna / Ordem Compra:</label><input type="text" id="refInterna" placeholder="Seu código/nome de controle"><span class="error-message" id="refInternaError">Campo obrigatório</span><small class="field-description" data-translate-key="descRefInterna">Código/nome para seu controle interno ou OC.</small></div>
                        <div class="grid-item"><label for="numeroPI" data-translate-key="labelNumeroPI">Número da PI (Proforma):</label><input type="text" id="numeroPI" placeholder="Nº da Proforma Invoice"><span class="error-message" id="numeroPIError">Campo obrigatório</span><small class="field-description" data-translate-key="descNumeroPI">Número da Fatura Proforma.</small></div>
                        <div class="grid-item"><label for="diProcesso" data-translate-key="labelDiProcesso">Número da DI/Processo:</label><input type="text" id="diProcesso" placeholder="Nº DI ou Processo"><span class="error-message" id="diProcessoError">Campo obrigatório</span><small class="field-description" data-translate-key="descDiProcesso">Identificador da DI ou do processo.</small></div>
                        <div class="grid-item"><label for="dataCalculo" data-translate-key="labelDataCalculo">Data do Cálculo/Embarque:</label><input type="date" id="dataCalculo"><span class="error-message" id="dataCalculoError">Campo obrigatório</span><small class="field-description" data-translate-key="descDataCalculo">Data relevante para este cálculo.</small></div>
                    </div>
                </section>
                <div class="section-separator section-separator-detComLog" data-translate-key="sepDetalhesComerciais"></div>

                <section aria-labelledby="headingDetalhesComerciais">
                    <div class="grid-container">
                        <div class="grid-item">
                            <label for="moedaEstrangeira" data-translate-key="labelMoedaEstrangeira">Moeda Estrangeira Ativa:</label>
                            <input type="text" id="moedaEstrangeira" value="USD" oninput="updateCotacaoButtonLabel()">
                            <small class="field-description" data-translate-key="descMoedaEstrangeira">Ex: USD, EUR, CNY. Define a moeda para os custos e cotação.</small>
                        </div>
                        <div class="grid-item">
                            <label for="taxaCambio" data-translate-key="labelTaxaCambio">Taxa de Câmbio (BRL por 1 Unid. Moeda Ativa):</label>
                            <input type="number" id="taxaCambio" step="0.0001" placeholder="Ex: 5.20">
                            <span class="error-message" id="taxaCambioError">Campo obrigatório</span>
                            <small class="field-description" data-translate-key="descTaxaCambio">Insira manualmente ou use os botões abaixo.</small>
                            <div class="currency-buttons-group">
                                <button type="button" onclick="fetchCotacaoMoeda('USD')"><span class="button-text">USD-BRL</span><span class="spinner"></span></button>
                                <button type="button" onclick="fetchCotacaoMoeda('EUR')"><span class="button-text">EUR-BRL</span><span class="spinner"></span></button>
                                <button type="button" onclick="fetchCotacaoMoeda('CNY')"><span class="button-text">CNY-BRL</span><span class="spinner"></span></button>
                            </div>
                            <output id="cotacaoInfo" aria-live="polite"></output>
                        </div>
                        <div class="grid-item">
                            <label for="incoterm" data-translate-key="labelIncoterm">INCOTERM:</label>
                            <select id="incoterm"><option value="">Selecione</option><option value="EXW">EXW</option><option value="FCA">FCA</option><option value="FAS">FAS</option><option value="FOB">FOB</option><option value="CPT" selected>CPT</option><option value="CFR">CFR</option><option value="CIP">CIP</option><option value="CIF">CIF</option><option value="DAP">DAP</option><option value="DPU">DPU</option><option value="DDP">DDP</option></select>
                            <small class="field-description" data-translate-key="descIncoterm">Ex: FOB, CIF. Define responsabilidades.</small>
                        </div>
                         <div class="grid-item">
                            <label for="modalidadeTransporte" data-translate-key="labelModalidadeTransporte">Modalidade de Transporte:</label>
                             <select id="modalidadeTransporte"><option value="">Selecione</option><option value="Maritimo">Marítimo</option><option value="Aereo" selected>Aéreo</option><option value="Rodoviario">Rodoviário</option><option value="Ferroviario">Ferroviário</option><option value="Outro">Outro</option></select>
                            <small class="field-description" data-translate-key="descModalidadeTransporte">Ex: Marítimo, Aéreo.</small>
                        </div>
                    </div>
                </section>
                <div class="section-separator section-separator-regTribCred" data-translate-key="sepRegimeTributario"></div>

                <section aria-labelledby="headingRegimeTributario">
                    <div class="grid-container">
                        <div class="grid-item"><label for="regimeTributario"><span data-translate-key="labelRegimeTributario">Regime Tributário Federal:</span><span class="tooltip-container"><i class="fas fa-question-circle tooltip-icon"></i><span class="tooltip-text" data-translate-key="tooltipRegimeTributario">Define o regime de tributação da empresa, impactando os créditos fiscais. Lucro Real permite mais créditos, enquanto Simples Nacional não permite.</span></span></label><select id="regimeTributario" onchange="handleRegimeChange()"><option value="Lucro Real" selected>Lucro Real</option><option value="Lucro Presumido">Lucro Presumido</option><option value="Simples Nacional">Simples Nacional</option></select></div>
                        <div class="grid-item"><label for="percCreditoPIS"><span data-translate-key="labelPercCreditoPIS">% Crédito PIS:</span><span class="tooltip-container"><i class="fas fa-question-circle tooltip-icon"></i><span class="tooltip-text" data-translate-key="tooltipCreditoPIS">Percentual de crédito de PIS a ser aproveitado. Geralmente 100% para Lucro Real e 0% para outros.</span></span></label><input type="number" id="percCreditoPIS" step="0.01" value="100.00"></div>
                        <div class="grid-item"><label for="percCreditoCOFINS"><span data-translate-key="labelPercCreditoCOFINS">% Crédito COFINS:</span><span class="tooltip-container"><i class="fas fa-question-circle tooltip-icon"></i><span class="tooltip-text" data-translate-key="tooltipCreditoCOFINS">Percentual de crédito de COFINS a ser aproveitado. Geralmente 100% para Lucro Real e 0% para outros.</span></span></label><input type="number" id="percCreditoCOFINS" step="0.01" value="100.00"></div>
                        <div class="grid-item"><label for="percCreditoIPI"><span data-translate-key="labelPercCreditoIPI">% Crédito IPI:</span><span class="tooltip-container"><i class="fas fa-question-circle tooltip-icon"></i><span class="tooltip-text" data-translate-key="tooltipCreditoIPI">Percentual de crédito de IPI. Geralmente 100% para indústrias no Lucro Real e 0% para os demais.</span></span></label><input type="number" id="percCreditoIPI" step="0.01" value="100.00"></div>
                        <div class="grid-item"><label for="percCreditoICMS"><span data-translate-key="labelPercCreditoICMS">% Crédito ICMS:</span><span class="tooltip-container"><i class="fas fa-question-circle tooltip-icon"></i><span class="tooltip-text" data-translate-key="tooltipCreditoICMS">Percentual de crédito de ICMS. Varia conforme o estado e benefícios fiscais (TTD).</span></span></label><input type="number" id="percCreditoICMS" step="0.01" value="100"></div>
                    </div>
                </section>
                <div class="section-separator section-separator-custosGlobais" data-translate-key="sepCustosGlobais"></div>

                <section aria-labelledby="headingCustosGlobais">
                    <div class="grid-container">
                        <div class="grid-item">
                            <label for="totalFreteME" data-translate-key="labelTotalFreteME">Frete Int. TOTAL ($):</label>
                            <input type="number" id="totalFreteME" step="0.01" placeholder="0.00">
                            <span class="error-message" id="totalFreteMEError">Campo obrigatório</span>
                            <small class="field-description" data-translate-key="descTotalFreteME">Frete principal em Moeda Estrangeira.</small>
                        </div>
                        <div class="grid-item"><label for="totalSeguroME" data-translate-key="labelTotalSeguroME">Seguro Int. TOTAL ($):</label><input type="number" id="totalSeguroME" step="0.01" placeholder="0.00"><small class="field-description" data-translate-key="descTotalSeguroME">Seguro da carga em Moeda Estrangeira.</small></div>
                        <div class="grid-item"><label for="totalOutrasDespesasME" data-translate-key="labelTotalOutrasDespesasME">Outras Desp. Origem TOTAIS ($):</label><input type="number" id="totalOutrasDespesasME" step="0.01" placeholder="0.00"><small class="field-description" data-translate-key="descTotalOutrasDespesasME">Ex: THC origem, docs, frete interno origem.</small></div>
                        <div class="grid-item">
                            <label for="taxaSiscomexBRL" data-translate-key="labelTaxaSiscomexBRL">Taxa Siscomex TOTAL (BRL):</label>
                            <input type="number" id="taxaSiscomexBRL" step="0.01" placeholder="0.00">
                            <span class="error-message" id="taxaSiscomexBRLError">Campo obrigatório</span>
                            <small class="field-description" data-translate-key="descTaxaSiscomexBRL">Taxa de uso do Siscomex.</small>
                        </div>
                        <div class="grid-item"><label for="despesasAduaneirasBRL" data-translate-key="labelDespesasAduaneirasBRL">Desp. Aduaneiras TOTAIS (BRL):</label><input type="number" id="despesasAduaneirasBRL" step="0.01" placeholder="0.00"><small class="field-description" data-translate-key="descDespesasAduaneirasBRL">Ex: Despachante, Armazenagem, LI.</small></div>
                        <div class="grid-item"><label for="freteNacionalBRL" data-translate-key="labelFreteNacionalBRL">Frete Nacional TOTAL (BRL):</label><input type="number" id="freteNacionalBRL" step="0.01" placeholder="0.00"><small class="field-description" data-translate-key="descFreteNacionalBRL">Transporte no Brasil até destino final.</small></div>
                        <div class="grid-item"><label for="aliquotaAFRMM"><span data-translate-key="labelAliquotaAFRMM">Alíquota AFRMM Global (%):</span><span class="tooltip-container"><i class="fas fa-question-circle tooltip-icon"></i><span class="tooltip-text" data-translate-key="tooltipAFRMM">Adicional ao Frete para a Renovação da Marinha Mercante. Padrão 8% para transporte marítimo. Zerar para outros modais.</span></span></label><input type="number" id="aliquotaAFRMM" step="0.01" placeholder="0.00"></div>
                    </div>
                </section>
                <section aria-labelledby="headingObservacoesGerais" style="margin-top: 20px;">
                    <h3 id="headingObservacoesGerais" data-translate-key="headingObservacoesGerais">Observações Gerais</h3>
                    <div class="grid-item" style="grid-column: 1 / -1;">
                        <textarea id="observacoesGerais" placeholder="Insira aqui quaisquer notas ou comentários relevantes sobre este cálculo..." aria-describedby="observacoesGeraisDesc"></textarea>
                        <small class="field-description" id="observacoesGeraisDesc" data-translate-key="descObservacoesGerais">Este campo é para suas anotações e não afeta os cálculos.</small>
                    </div>
                </section>
            </section>

            <section class="item-inputs" aria-labelledby="headingItensEmbarque">
                <h2 id="headingItensEmbarque" data-translate-key="headingItensEmbarque">Itens do Embarque</h2>
                <p class="currency-note" data-translate-key="noteItensEmbarque">Insira as alíquotas para cada item (ex: 10 para 10%). Peso é informativo. "Pr. Venda Unit. R$ Brasil" é o preço unitário de venda.</p>
                <div class="table-wrapper">
                    <table id="itemInputTable" class="item-table-input" aria-labelledby="headingItensEmbarque">
                        <thead>
                            <tr>
                                <th style="width: 20px;"></th>
                                <th scope="col">#</th>
                                <th scope="col" data-translate-key="thDescricao">Descrição</th>
                                <th scope="col" data-translate-key="thCodInterno">Cód. Interno</th>
                                <th scope="col" data-translate-key="thNCM">NCM</th>
                                <th scope="col" data-translate-key="thQtd">Qtd.</th>
                                <th scope="col" data-translate-key="thPrecoCustoUnitME">Pr. Custo Unit. $</th>
                                <th scope="col" data-translate-key="thPesoUnitKG">Peso Unit. KG</th>
                                <th scope="col" data-translate-key="thII">II (%)</th>
                                <th scope="col" data-translate-key="thIPI">IPI (%)</th>
                                <th scope="col" data-translate-key="thPIS">PIS (%)</th>
                                <th scope="col" data-translate-key="thCOFINS">COFINS (%)</th>
                                <th scope="col" data-translate-key="thICMS">ICMS (%)</th>
                                <th scope="col" data-translate-key="thPrecoVendaUnitBR">Pr. Venda Unit. R$ Brasil</th>
                                <th scope="col" data-translate-key="thPrecoCustoTotalME">Pr. Custo Total $</th>
                                <th scope="col" data-translate-key="thPesoTotalKG">Peso Total KG</th>
                                <th scope="col" data-translate-key="thAcoes" style="min-width: 140px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div style="text-align: right; margin-top: 15px;">
                    <button type="button" id="adicionarItemBtn" class="main-calculate-button" style="font-size: 14px; padding: 8px 15px; background-color: var(--theme-accent-green);">
                        <i class="fas fa-plus"></i> <span data-translate-key="btnAdicionarItem">Adicionar Novo Item</span>
                    </button>
                </div>
            </section>
            
            <div class="action-buttons">
                <button class="main-calculate-button" onclick="calcularCustosMultiItem()" data-translate-key="btnCalcular">Calcular Custos, Lucro e Indicadores</button>
                <button type="button" class="clear-button" onclick="limparTodosOsCampos(true)" data-translate-key="btnLimparCampos">Limpar Todos os Campos</button>
            </div>
        </section>

        <section id="telaResultadosPanel" role="tabpanel" aria-labelledby="tabResultadosBtn" hidden>
            <section id="resultsContainer" class="dashboard-section" aria-labelledby="headingResultadosDetalhados" aria-live="polite" aria-atomic="true">
                <h2 id="headingResultadosDetalhados" data-translate-key="headingResultadosDetalhados">Resultados Detalhados por Item</h2>
                <div class="table-wrapper">
                    <table id="itemResultTable" class="results-table" aria-labelledby="headingResultadosDetalhados">
                        <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col" data-translate-key="resThCodInterno">Cód. Interno</th>
                                <th scope="col" data-translate-key="resThDescricao">Descrição</th>
                                <th scope="col" data-translate-key="resThNCM">NCM</th>
                                <th scope="col" data-translate-key="resThQtd">Qtd</th>
                                <th scope="col" data-translate-key="resThPesoUnitKG">Peso Unit. KG</th>
                                <th scope="col" data-translate-key="resThPesoTotalKG">Peso Total KG</th>
                                <th scope="col" data-translate-key="resThPercRateioPesoUnit">% Rateio Peso Unit.</th>
                                <th scope="col" data-translate-key="resThFretePesoUnit">Frete por Peso Unit. (R$)</th>
                                <th scope="col" data-translate-key="resThPrecoCustoUnitME">Pr. Custo Unit. $</th>
                                <th scope="col" data-translate-key="resThPrecoCustoTotalME">Pr. Custo Total $</th>
                                <th scope="col" data-translate-key="resThFOBUnit">FOB Unit. (R$)</th>
                                <th scope="col" data-translate-key="resThFOBTotal">FOB Total (R$)</th>
                                <th scope="col" data-translate-key="resThFOBPerc">FOB %</th>
                                <th scope="col" data-translate-key="resThSeguroRateado">Seguro Rateado (R$)</th>
                                <th scope="col" data-translate-key="resThOutrasDespRateadas">Outras Desp. Rateadas (R$)</th>
                                <th scope="col" data-translate-key="resThCIFTotal">CIF Total (R$)</th>
                                <th scope="col" data-translate-key="resThIIR">II R$</th>
                                <th scope="col" data-translate-key="resThValorTotalNF">Valor Total NF (R$)</th>
                                <th scope="col" data-translate-key="resThValorUnitarioNF">Valor Unitário NF (R$)</th>
                                <th scope="col" data-translate-key="resThIPIPago">IPI Pago R$</th>
                                <th scope="col" data-translate-key="resThIPICredito">IPI Crédito R$</th>
                                <th scope="col" data-translate-key="resThIPICusto">IPI Custo R$</th>
                                <th scope="col" data-translate-key="resThTXSISC">TX.SISC. (R$)</th>
                                <th scope="col" data-translate-key="resThPISPago">PIS Pago R$</th>
                                <th scope="col" data-translate-key="resThPISCredito">PIS Crédito R$</th>
                                <th scope="col" data-translate-key="resThPISCusto">PIS Custo R$</th>
                                <th scope="col" data-translate-key="resThCOFINSPago">COFINS Pago R$</th>
                                <th scope="col" data-translate-key="resThCOFINSCredito">COFINS Crédito R$</th>
                                <th scope="col" data-translate-key="resThCOFINSCusto">COFINS Custo R$</th>
                                <th scope="col" data-translate-key="resThBaseCalcICMS">Base Calc. ICMS R$</th>
                                <th scope="col" data-translate-key="resThICMSPago">ICMS Pago R$</th>
                                <th scope="col" data-translate-key="resThICMSCredito">ICMS Crédito R$</th>
                                <th scope="col" data-translate-key="resThICMSCusto">ICMS Custo R$</th>
                                <th scope="col" data-translate-key="resThAFRMM">AFRMM R$</th>
                                <th scope="col" data-translate-key="resThDespAdu">Desp. Adu R$</th>
                                <th scope="col" data-translate-key="resThFreteNac">Frete Nac R$</th>
                                <th scope="col" data-translate-key="resThCustoTotalComImpostos">Custo Total Com Impostos</th>
                                <th scope="col" data-translate-key="resThCustoUnitComImpostos">CUSTO UNIT Com Impostos</th>
                                <th scope="col" data-translate-key="resThSomaImpostosQueCreditam">Soma Impostos Que Creditam (R$)</th>
                                <th scope="col" data-translate-key="resThSomaImpostosComCreditos">Soma Impostos Com Creditos (R$)</th>
                                <th scope="col" data-translate-key="resThTotalImpEfetivos">Total Imp. Efetivos</th>
                                <th scope="col" data-translate-key="resThCustoUnitLiquido">CUSTO UNIT. R$ (Líquido)</th>
                                <th scope="col" data-translate-key="resThCustoTotalLinhaLiquido">CUSTO TOTAL LINHA R$ (Líquido)</th>
                                <th scope="col" data-translate-key="resThPrecoVendaUnitBR">PREÇO VENDA UNIT. R$ Brasil</th>
                                <th scope="col" data-translate-key="resThPrecoVendaTotalBR">PREÇO VENDA Total. R$ Brasil</th>
                                <th scope="col" data-translate-key="resThLucroUnit">LUCRO UNIT. (R$)</th>
                                <th scope="col" data-translate-key="resThLucroTotalLinha">LUCRO TOTAL LINHA (R$)</th>
                                <th scope="col" data-translate-key="resThMargemLucroUnit">MARGEM LUCRO UNIT. %</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </section>

        <section id="telaDashboardPanel" role="tabpanel" aria-labelledby="tabDashboardBtn" hidden>
            <section id="dashboardContainer" class="dashboard-section" aria-labelledby="headingIndicadoresChave" aria-live="polite" aria-atomic="true">
                <h2 id="headingIndicadoresChave" data-translate-key="headingIndicadoresChave">Indicadores Chave do Embarque</h2>
                
                <div id="dashboardScreenshotArea">
                    <div id="prominentProfitCard" class="prominent-profit-indicator" style="display: none;">
                        <span class="kpi-label" data-translate-key="labelLucroTotalPedidoPerc">Lucro Total Pedido (%):</span>
                        <strong id="dbProminentLucroTotalPedidoPerc" role="status" aria-live="polite"></strong>
                    </div>

                    <div class="dashboard-kpi-grid">
                        <article class="dashboard-kpi">
                            <div class="kpi-icon-container"><i class="fas fa-file-invoice-dollar" aria-hidden="true"></i></div>
                            <div class="kpi-content">
                                <span class="kpi-label" data-translate-key="labelValorPedidoME">Valor Pedido (ME):</span>
                                <strong id="dbValorPedidoME"></strong>
                            </div>
                        </article>
                        <article class="dashboard-kpi">
                            <div class="kpi-icon-container"><i class="fas fa-dollar-sign" aria-hidden="true"></i></div>
                            <div class="kpi-content">
                                <span class="kpi-label" data-translate-key="labelCustoTotalEmbarque">Custo Total Embarque (R$):</span>
                                <strong id="dbTotalCustoImp"></strong>
                            </div>
                        </article>
                        <article class="dashboard-kpi">
                            <div class="kpi-icon-container"><i class="fas fa-cash-register" aria-hidden="true"></i></div>
                            <div class="kpi-content">
                                <span class="kpi-label" data-translate-key="labelReceitaTotalBrasil">Receita Total Brasil (R$):</span>
                                <strong id="dbReceitaTotalBrasil"></strong>
                            </div>
                        </article>
                        <article class="dashboard-kpi">
                            <div class="kpi-icon-container"><i class="fas fa-chart-line" aria-hidden="true"></i></div>
                            <div class="kpi-content">
                                <span class="kpi-label" data-translate-key="labelLucroTotalPedidoRS">Lucro Total Pedido (R$):</span>
                                <strong id="dbLucroTotalPedidoRS"></strong>
                            </div>
                        </article>
                        <article class="dashboard-kpi">
                            <div class="kpi-icon-container"><i class="fas fa-percent" aria-hidden="true"></i></div>
                            <div class="kpi-content">
                                <span class="kpi-label" data-translate-key="labelLucroTotalPedidoPerc">Lucro Total Pedido (%):</span>
                                <strong id="dbLucroTotalPedidoPerc"></strong>
                            </div>
                        </article>
                    </div>
                    <div class="dashboard-kpi-grid" style="margin-top: 15px;">
                        <article class="dashboard-kpi">
                            <div class="kpi-icon-container"><i class="fas fa-ship" aria-hidden="true"></i></div>
                            <div class="kpi-content">
                                <span class="kpi-label" data-translate-key="labelValorFOBTotal">Valor FOB Total (R$):</span>
                                <strong id="dbTotalFOB_BRL"></strong>
                            </div>
                        </article>
                        <article class="dashboard-kpi">
                            <div class="kpi-icon-container"><i class="fas fa-truck-loading" aria-hidden="true"></i></div>
                            <div class="kpi-content">
                                <span class="kpi-label" data-translate-key="labelFreteIntlTotal">Frete Intl. Total (R$):</span>
                                <strong id="dbFreteTotalBRL"></strong>
                            </div>
                        </article>
                        <article class="dashboard-kpi">
                            <div class="kpi-icon-container"><i class="fas fa-percentage" aria-hidden="true"></i></div>
                            <div class="kpi-content">
                                <span class="kpi-label" data-translate-key="labelFreteIntlFOB">Frete Intl. / FOB (%):</span>
                                <strong id="dbPercFreteSobreFOB"></strong>
                            </div>
                        </article>
                         <article class="dashboard-kpi">
                             <div class="kpi-icon-container"><i class="fas fa-receipt" aria-hidden="true"></i></div>
                            <div class="kpi-content">
                                <span class="kpi-label" data-translate-key="labelTotalImpostosBruto">Total Impostos Pagos (Bruto R$):</span>
                                <strong id="dbTotalImpostosBruto"></strong>
                            </div>
                        </article>
                        <article class="dashboard-kpi">
                             <div class="kpi-icon-container"><i class="fas fa-file-invoice-dollar" aria-hidden="true"></i></div>
                            <div class="kpi-content">
                                <span class="kpi-label" data-translate-key="labelTotalImpostosEfetivos">Total Impostos Efetivos (R$):</span>
                                <strong id="dbTotalImpostosEfetivos"></strong>
                            </div>
                        </article>
                    </div>
                </div>
                <div class="action-buttons" style="margin-top: 20px;">
                     <button type="button" class="pdf-button" onclick="gerarPDF()" data-translate-key="btnGerarPDF">
                        <i class="fas fa-file-pdf"></i> Gerar PDF
                    </button>
                    <button type="button" class="csv-button" onclick="exportTableToCSV('resultados_importacao.csv')" data-translate-key="btnExportarCSV">
                        <i class="fas fa-file-csv"></i> Exportar CSV
                    </button>
                    <button type="button" class="whatsapp-button" onclick="shareDashboardViaWhatsApp()" data-translate-key="btnShareWhatsApp">
                        <i class="fab fa-whatsapp"></i> Compartilhar Dashboard
                    </button>
                </div>

                <section aria-labelledby="headingDistribuicaoCusto" class="cost-distribution-section">
                    <h3 id="headingDistribuicaoCusto" data-translate-key="headingDistribuicaoCusto">Distribuição Percentual Estimada do Custo Total Geral (Líquido de Créditos):</h3>
                    <div class="grid-container cost-distribution-grid">
                        <div class="cost-dist-item"><div class="cost-dist-info"><span class="cost-dist-label" data-translate-key="labelDistProduto">% Custo Produto (FOB):</span><span class="cost-dist-value"><strong id="dbDistProduto"></strong></span></div><div class="cost-dist-bar-container"><div id="barDistProduto" class="cost-dist-bar"></div></div></div>
                        <div class="cost-dist-item"><div class="cost-dist-info"><span class="cost-dist-label" data-translate-key="labelDistFreteSegInt">% Frete/Seguro Int.:</span><span class="cost-dist-value"><strong id="dbDistFreteSegInt"></strong></span></div><div class="cost-dist-bar-container"><div id="barDistFreteSegInt" class="cost-dist-bar"></div></div></div>
                        <div class="cost-dist-item"><div class="cost-dist-info"><span class="cost-dist-label" data-translate-key="labelDistImpFed">% Imp. Fed. + AFRMM/Sisc.:</span><span class="cost-dist-value"><strong id="dbDistImpFed"></strong></span></div><div class="cost-dist-bar-container"><div id="barDistImpFed" class="cost-dist-bar"></div></div></div>
                        <div class="cost-dist-item"><div class="cost-dist-info"><span class="cost-dist-label" data-translate-key="labelDistICMS">% ICMS (Efetivo):</span><span class="cost-dist-value"><strong id="dbDistICMS"></strong></span></div><div class="cost-dist-bar-container"><div id="barDistICMS" class="cost-dist-bar"></div></div></div>
                        <div class="cost-dist-item"><div class="cost-dist-info"><span class="cost-dist-label" data-translate-key="labelDistDespNac">% Desp. Nacionais:</span><span class="cost-dist-value"><strong id="dbDistDespNac"></strong></span></div><div class="cost-dist-bar-container"><div id="barDistDespNac" class="cost-dist-bar"></div></div></div>
                    </div>
                </section>

                <section aria-labelledby="headingGraficoCustos" class="chart-section">
                    <h3 id="headingGraficoCustos" data-translate-key="headingGraficoCustos">Composição do Custo Total Geral (Gráfico)</h3>
                    <div class="chart-container">
                        <canvas id="custoTotalPizzaChart"></canvas>
                    </div>
                </section>

                <div class="top-items-grid-container">
                    <section aria-labelledby="headingTopLucrativos" class="top-items-section">
                        <h3 id="headingTopLucrativos" data-translate-key="headingTopLucrativos">Top 10 Itens Mais Lucrativos (Margem %)</h3>
                        <ul id="topLucrativosList" class="top-items-list">
                        </ul>
                    </section>
                     <section aria-labelledby="headingTopMenosLucrativos" class="top-items-section">
                        <h3 id="headingTopMenosLucrativos" data-translate-key="headingTopMenosLucrativos">Top 10 Itens Menos Lucrativos (Margem %)</h3>
                        <ul id="topMenosLucrativosList" class="top-items-list">
                            </ul>
                    </section>
                </div>

                <section aria-labelledby="headingComponentesCusto" class="cost-components-section">
                    <h3 id="headingComponentesCusto" data-translate-key="headingComponentesCusto">Principais Componentes do Custo Total (%)</h3>
                    <div id="principaisComponentesCusto" class="grid-container cost-components-grid">
                        <div class="cost-component-item">
                            <span class="component-label" data-translate-key="labelCompPercProduto">Custo do Produto (FOB):</span>
                            <strong id="compPercProduto">0.00%</strong>
                        </div>
                        <div class="cost-component-item">
                            <span class="component-label" data-translate-key="labelCompPercImpostos">Total Impostos Efetivos:</span>
                            <strong id="compPercImpostos">0.00%</strong>
                        </div>
                        <div class="cost-component-item">
                            <span class="component-label" data-translate-key="labelCompPercOutros">Demais Custos Operacionais:</span>
                            <strong id="compPercOutros">0.00%</strong>
                        </div>
                    </div>
                </section>
            </section>

            <section class="results-summary-section" aria-labelledby="headingResumoGeral" aria-live="polite" aria-atomic="true">
                <h2 id="headingResumoGeral" data-translate-key="headingResumoGeral">Resumo Geral do Embarque (BRL)</h2>
                <div id="resultsSummary" class="results-summary">
                </div>
            </section>
        </section>

        <footer class="app-footer">
             <p data-translate-key="footerDisclaimer">Os cálculos de crédito são estimativas e dependem da correta aplicação da legislação e do regime tributário. Consulte seu contador.</p>
             <p id="footerInfo"></p>
        </footer>
    </main>

    <!-- Modals -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeSettingsModalBtn" class="modal-close-btn" aria-label="Fechar Configurações">&times;</button>
            <h2 data-translate-key="modalConfigTitle">Configurações</h2>
            
            <section class="modal-section" aria-labelledby="headingIdiomaModal">
                <h3 id="headingIdiomaModal" data-translate-key="modalIdiomaTitle">Idioma</h3>
                <div class="grid-item">
                    <label for="idiomaSelect" data-translate-key="modalIdiomaLabel">Selecionar Idioma:</label>
                    <select id="idiomaSelect" aria-describedby="idiomaDesc">
                        <option value="pt-BR" selected>Português (Brasil)</option>
                        <option value="en-US">Inglês (English)</option>
                    </select>
                    <small class="field-description" id="idiomaDesc" data-translate-key="modalIdiomaDesc">Define o idioma da interface (funcionalidade futura).</small>
                </div>
            </section>

            <section class="modal-section" aria-labelledby="headingLimitesLucroModal">
                <h3 id="headingLimitesLucroModal" data-translate-key="modalLucroTitle">Configurações de Margem de Lucro (%)</h3>
                 <div class="grid-container">
                    <div class="grid-item">
                        <label for="modalLucroAltoMin"><span class="profit-color-indicator green"></span><span data-translate-key="modalLucroAltoLabel">Mín. Lucro Alto (Verde):</span></label>
                        <input type="number" id="modalLucroAltoMin" step="1" value="40" placeholder="Ex: 40">
                        <small class="field-description" data-translate-key="modalLucroAltoDesc">Margem mínima para cor verde (lucro alto).</small>
                    </div>
                    <div class="grid-item">
                        <label for="modalLucroMedioMin"><span class="profit-color-indicator yellow"></span><span data-translate-key="modalLucroMedioLabel">Mín. Lucro Médio (Amarelo):</span></label>
                        <input type="number" id="modalLucroMedioMin" step="1" value="30" placeholder="Ex: 30">
                        <small class="field-description" data-translate-key="modalLucroMedioDesc">Margem mínima para cor amarela (lucro médio).</small>
                    </div>
                    <div class="grid-item">
                        <label for="modalLucroBaixoMin"><span class="profit-color-indicator orange"></span><span data-translate-key="modalLucroBaixoLabel">Mín. Lucro Baixo (Laranja):</span></label>
                        <input type="number" id="modalLucroBaixoMin" step="1" value="20" placeholder="Ex: 20">
                        <small class="field-description" data-translate-key="modalLucroBaixoDesc">Margem mínima para cor laranja (lucro baixo). Abaixo disso será vermelho.</small>
                    </div>
                </div>
            </section>

            <div class="modal-actions">
                <button type="button" id="saveSettingsBtn" class="main-calculate-button" data-translate-key="modalBtnSalvar">Salvar e Fechar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para compartilhar imagem -->
    <div id="shareImageModal" class="modal-overlay">
        <div id="shareImageModalContent">
            <h3 data-translate-key="shareModalTitle">Compartilhar Dashboard</h3>
            <p data-translate-key="shareModalInstructions">
                1. Clique com o botão direito na imagem abaixo e selecione "Copiar Imagem".<br>
                2. Cole na sua conversa do WhatsApp.<br>
                (Ou salve a imagem e anexe no WhatsApp)
            </p>
            <img id="dashboardScreenshot" src="" alt="Captura de Tela do Dashboard">
            <a href="https://wa.me/?text=Veja%20o%20dashboard%20da%20importação:" target="_blank" class="button whatsapp-link-btn" data-translate-key="shareModalOpenWhatsApp">
                <i class="fab fa-whatsapp"></i> Abrir WhatsApp
            </a>
            <button type="button" id="closeShareModalBtn" class="button close-modal-btn" data-translate-key="shareModalClose">Fechar</button>
        </div>
    </div>

<script>
// IIFE para evitar poluir o escopo global
(function() {
    const IMPOSTOS_PADRAO = { aliqII: "12.60", aliqIPI: "9.75", aliqPIS: "2.10", aliqCOFINS: "10.65", aliqICMS: "17" };

    let custoTotalChartInstance = null;
    let saveTimeout;
    let latestCalculationResults = null;
    let draggedRow = null;

    function geId(id) { return document.getElementById(id); }

    // --- SISTEMA DE NOTIFICAÇÃO ---
    function showToast(message, type = 'error') {
        const container = geId('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        const icon = document.createElement('i');
        const icons = {
            error: 'fas fa-times-circle',
            success: 'fas fa-check-circle',
            warning: 'fas fa-exclamation-triangle'
        };
        icon.className = icons[type] || icons.warning;
        
        const text = document.createElement('span');
        text.textContent = message;

        toast.appendChild(icon);
        toast.appendChild(text);
        container.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => {
                toast.remove();
            });
        }, 4000);
    }

    // --- FUNÇÕES UTILITÁRIAS ---
    function TxtToNum(elementIdOrValue, isElement = true) {
        let valStr;
        if (isElement) {
            const elem = geId(elementIdOrValue);
            if (!elem) { console.warn(`Elemento com ID '${elementIdOrValue}' não encontrado em TxtToNum.`); return 0; }
            if (elem.type === 'date') { return elem.value; }
            valStr = String(elem.value);
        } else {
            valStr = String(elementIdOrValue);
        }
        valStr = valStr.replace(/\s/g, '').replace(',', '.');
        const num = parseFloat(valStr);
        return isNaN(num) ? 0 : num;
    }

    function formatBRL(value) { return (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
    
    function formatCurrency(value, currencyCode = "USD", locale = 'pt-BR') {
        if (currencyCode === "BRL") return formatBRL(value);
        let symbol = currencyCode;
        if (currencyCode === "USD") symbol = "$"; else if (currencyCode === "EUR") symbol = "€"; else if (currencyCode === "CNY") symbol = "¥";
        try {
            return (value || 0).toLocaleString(locale, { style: 'currency', currency: currencyCode, minimumFractionDigits: 2, maximumFractionDigits: 2 });
        } catch (e) { return `${symbol} ${(value || 0).toFixed(2)}`; }
    }
    
    // --- FUNÇÕES DE UI/UX ---
    function updateCotacaoButtonLabel() {
        const moedaInput = geId('moedaEstrangeira');
        const moeda = moedaInput ? (moedaInput.value.toUpperCase() || "USD") : "USD";
        let currencySymbol = moeda;
        if (moeda === "USD") currencySymbol = "$";
        else if (moeda === "EUR") currencySymbol = "€";
        else if (moeda === "CNY") currencySymbol = "¥";
        
        const freteLabelElem = document.querySelector('label[for="totalFreteME"]');
        if(freteLabelElem) freteLabelElem.innerText = `Frete Int. TOTAL (${currencySymbol}):`;
        
        const seguroLabelElem = document.querySelector('label[for="totalSeguroME"]');
        if(seguroLabelElem) seguroLabelElem.innerText = `Seguro Int. TOTAL (${currencySymbol}):`;
        
        const outrasDespLabelElem = document.querySelector('label[for="totalOutrasDespesasME"]');
        if(outrasDespLabelElem) outrasDespLabelElem.innerText = `Outras Desp. Origem TOTAIS (${currencySymbol}):`;

        const itemInputTableHead = geId('itemInputTable')?.querySelector('thead');
        if (itemInputTableHead) {
            const thCustoUnit = itemInputTableHead.querySelector('th:nth-child(7)');
            if(thCustoUnit) thCustoUnit.innerText = `Pr. Custo Unit. ${currencySymbol}`;
            const thCustoTotal = itemInputTableHead.querySelector('th:nth-child(15)');
            if(thCustoTotal) thCustoTotal.innerText = `Pr. Custo Total ${currencySymbol}`;
        }
        const itemResultTableHead = geId('itemResultTable')?.querySelector('thead');
        if(itemResultTableHead) {
            const ths = itemResultTableHead.querySelectorAll('th');
            if(ths.length > 10) {
                 if(ths[9]) ths[9].innerText = `Pr. Custo Unit. ${currencySymbol}`;
                 if(ths[10]) ths[10].innerText = `Pr. Custo Total ${currencySymbol}`;
            }
        }
    }

    async function fetchCotacaoMoeda(targetMoeda) {
        const moedaEstrangeiraInput = geId('moedaEstrangeira');
        const infoSpan = geId('cotacaoInfo');
        const taxaCambioInput = geId('taxaCambio');
        const button = event.currentTarget;

        button.classList.add('button-loading');
        button.disabled = true;

        infoSpan.textContent = "Buscando cotação...";
        infoSpan.classList.remove('error');

        const startTime = Date.now();

        try {
            const response = await fetch(`https://economia.awesomeapi.com.br/json/last/${targetMoeda}-BRL`);
            if (!response.ok) { throw new Error(`API: ${response.statusText} (${response.status})`); }
            const data = await response.json();
            const cotacaoKey = `${targetMoeda}BRL`;

            if (data[cotacaoKey] && data[cotacaoKey].bid) {
                const cotacao = parseFloat(data[cotacaoKey].bid);
                taxaCambioInput.value = cotacao.toFixed(4);
                if(moedaEstrangeiraInput) moedaEstrangeiraInput.value = targetMoeda;
                updateCotacaoButtonLabel();
                const dataHoraCotacao = new Date(parseInt(data[cotacaoKey].timestamp) * 1000);
                infoSpan.textContent = `Cotação (${data[cotacaoKey].name.split('/')[0]}): ${cotacao.toFixed(4)} em ${dataHoraCotacao.toLocaleDateString('pt-BR')} ${dataHoraCotacao.toLocaleTimeString('pt-BR')}`;
                infoSpan.classList.remove('error');
                saveState(); // Salva o estado após busca bem-sucedida
            } else { throw new Error(`Cotação ${targetMoeda}-BRL não encontrada.`); }
        } catch (error) {
            console.error("Erro na cotação:", error);
            infoSpan.textContent = `Erro ao buscar ${targetMoeda}: ${error.message}`;
            infoSpan.classList.add('error');
        } finally {
            const duration = Date.now() - startTime;
            const minDisplayTime = 500; // 0.5 segundos
            setTimeout(() => {
                button.classList.remove('button-loading');
                button.disabled = false;
            }, Math.max(0, minDisplayTime - duration));
        }
    }

    // --- FUNÇÕES DA TABELA DINÂMICA ---
    function createItemInputRow(index, itemData = null) {
        const tbody = geId('itemInputTable').getElementsByTagName('tbody')[0];
        const row = tbody.insertRow();
        row.draggable = true;
        
        const defaultRowData = {
              desc: "", codInterno: "", ncm: "", qtd: "", precoCustoUnitME: "", pesoUnitKG: "",
              aliqII: "", aliqIPI: "", aliqPIS: "", aliqCOFINS: "", aliqICMS: "", valVendaUnitBR: ""
        };
        const data = itemData || defaultRowData;

        row.innerHTML = `
            <td class="drag-handle" title="Arraste para reordenar"><i class="fas fa-grip-vertical"></i></td>
            <td>${index + 1}</td>
            <td><label class="sr-only" for="descItem${index}">Descrição do Item ${index + 1}</label><input type="text" id="descItem${index}" value="${data.desc}" placeholder="Descrição do Produto"></td>
            <td><label class="sr-only" for="codInternoItem${index}">Código Interno do Item ${index + 1}</label><input type="text" id="codInternoItem${index}" value="${data.codInterno}" placeholder="Cód."></td>
            <td><label class="sr-only" for="ncmItem${index}">NCM do Item ${index + 1}</label><input type="text" id="ncmItem${index}" value="${data.ncm}" placeholder="NCM"></td>
            <td class="grid-item">
                <label class="sr-only" for="qtdItem${index}">Quantidade do Item ${index + 1}</label>
                <input type="number" id="qtdItem${index}" value="${data.qtd}" min="0" step="any" placeholder="0" oninput="updateItemCalculatedFields(${index})">
                <span class="error-message" id="qtdItem${index}Error">Obrigatório</span>
            </td>
            <td class="grid-item">
                <label class="sr-only" for="precoCustoUnitMEItem${index}">Preço Custo Unit. $ do Item ${index + 1}</label>
                <input type="number" id="precoCustoUnitMEItem${index}" value="${data.precoCustoUnitME}" min="0" step="any" placeholder="0.00" oninput="updateItemCalculatedFields(${index})">
                <span class="error-message" id="precoCustoUnitMEItem${index}Error">Obrigatório</span>
            </td>
            <td><label class="sr-only" for="pesoUnitKGItem${index}">Peso Unit. KG do Item ${index + 1}</label><input type="number" id="pesoUnitKGItem${index}" value="${data.pesoUnitKG}" min="0" step="any" placeholder="0.000" oninput="updateItemCalculatedFields(${index})"></td>
            <td class="grid-item"><label class="sr-only" for="aliqIIItem${index}">Alíquota II (%) do Item ${index + 1}</label><input type="number" id="aliqIIItem${index}" value="${data.aliqII}" min="0" step="any" placeholder="II%"></td>
            <td class="grid-item"><label class="sr-only" for="aliqIPIItem${index}">Alíquota IPI (%) do Item ${index + 1}</label><input type="number" id="aliqIPIItem${index}" value="${data.aliqIPI}" min="0" step="any" placeholder="IPI%"></td>
            <td class="grid-item"><label class="sr-only" for="aliqPISItem${index}">Alíquota PIS (%) do Item ${index + 1}</label><input type="number" id="aliqPISItem${index}" value="${data.aliqPIS}" min="0" step="any" placeholder="PIS%"></td>
            <td class="grid-item"><label class="sr-only" for="aliqCOFINSItem${index}">Alíquota COFINS (%) do Item ${index + 1}</label><input type="number" id="aliqCOFINSItem${index}" value="${data.aliqCOFINS}" min="0" step="any" placeholder="COFINS%"></td>
            <td class="grid-item"><label class="sr-only" for="aliqICMSItem${index}">Alíquota ICMS (%) do Item ${index + 1}</label><input type="number" id="aliqICMSItem${index}" value="${data.aliqICMS}" min="0" step="any" placeholder="ICMS%"></td>
            <td><label class="sr-only" for="valVendaUnitBRItem${index}">Preço Venda Unit. R$ Brasil do Item ${index + 1}</label><input type="number" id="valVendaUnitBRItem${index}" value="${data.valVendaUnitBR}" min="0" step="any" placeholder="0.00"></td>
            <td><label class="sr-only" for="precoCustoTotalMEItem${index}">Preço Custo Total $ do Item ${index + 1}</label><input type="number" id="precoCustoTotalMEItem${index}" step="any" placeholder="0.00" readonly></td>
            <td><label class="sr-only" for="pesoTotalKGItem${index}">Peso Total KG do Item ${index + 1}</label><input type="number" id="pesoTotalKGItem${index}" step="any" placeholder="0.000" readonly></td>
            <td>
                <button type="button" class="clear-button" onclick="removerLinhaItem(this)" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;" aria-label="Remover Item"><i class="fas fa-trash-alt"></i></button>
                <button type="button" class="pdf-button" onclick="carregarImpostosPadrao(this)" style="padding: 5px 10px; font-size: 12px;" aria-label="Carregar Impostos Padrão"><i class="fas fa-bolt"></i> Padrão</button>
            </td>
        `;
        updateItemCalculatedFields(index);
    }

    function adicionarLinhaItem() {
        const tbody = geId('itemInputTable').getElementsByTagName('tbody')[0];
        const newIndex = tbody.rows.length;
        createItemInputRow(newIndex);
        saveState();
    }
    
    function removerLinhaItem(button) {
        const row = button.closest('tr');
        if (row.parentElement.rows.length > 1) {
            row.remove();
            renumerarLinhas();
            saveState();
        } else {
            showToast("Não é possível remover a última linha.", 'warning');
        }
    }
    
    function carregarImpostosPadrao(button) {
        const row = button.closest('tr');
        const index = Array.from(row.parentNode.children).indexOf(row);
        geId(`aliqIIItem${index}`).value = IMPOSTOS_PADRAO.aliqII;
        geId(`aliqIPIItem${index}`).value = IMPOSTOS_PADRAO.aliqIPI;
        geId(`aliqPISItem${index}`).value = IMPOSTOS_PADRAO.aliqPIS;
        geId(`aliqCOFINSItem${index}`).value = IMPOSTOS_PADRAO.aliqCOFINS;
        geId(`aliqICMSItem${index}`).value = IMPOSTOS_PADRAO.aliqICMS;
        saveState();
    }
    
    function renumerarLinhas() {
        const tbody = geId('itemInputTable').getElementsByTagName('tbody')[0];
        const rows = tbody.rows;
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            row.cells[1].textContent = i + 1; // Cell 0 is now the drag handle
            
            row.querySelectorAll('input, label, span.error-message').forEach(elem => {
                if (elem.id) {
                    const idBase = elem.id.replace(/\d+$/, '');
                    elem.id = idBase + i;
                }
                if (elem.htmlFor) {
                    const forBase = elem.htmlFor.replace(/\d+$/, '');
                    elem.htmlFor = forBase + i;
                }
            });
            
            row.querySelectorAll('input[oninput*="updateItemCalculatedFields"]').forEach(input => {
               input.setAttribute('oninput', `updateItemCalculatedFields(${i})`);
            });
        }
    }
    
    function updateItemCalculatedFields(index) {
        const qtdElem = geId(`qtdItem${index}`);
        const valUnitMEElem = geId(`precoCustoUnitMEItem${index}`);
        const pesoUnitKGElem = geId(`pesoUnitKGItem${index}`);
        if (!qtdElem || !valUnitMEElem || !pesoUnitKGElem) { return; }
        const qtd = TxtToNum(qtdElem.value, false);
        const valUnitME = TxtToNum(valUnitMEElem.value, false);
        const pesoUnitKG = TxtToNum(pesoUnitKGElem.value, false);
        const precoCustoTotalMEElem = geId(`precoCustoTotalMEItem${index}`);
        if (precoCustoTotalMEElem) { precoCustoTotalMEElem.value = (qtd * valUnitME).toFixed(2); }
        const pesoTotalKGElem = geId(`pesoTotalKGItem${index}`);
        if (pesoTotalKGElem) { pesoTotalKGElem.value = (qtd * pesoUnitKG).toFixed(3); }
    }

    function handleRegimeChange() {
        const regime = geId('regimeTributario')?.value;
        const percCredPISInput = geId('percCreditoPIS');
        const percCredCOFINSInput = geId('percCreditoCOFINS');
        const percCredIPIInput = geId('percCreditoIPI');
        const percCredICMSInput = geId('percCreditoICMS');

        if(!percCredPISInput || !percCredCOFINSInput || !percCredIPIInput || !percCredICMSInput) {
            console.warn("Um ou mais campos de crédito não foram encontrados em handleRegimeChange.");
            return;
        }
        
        let pisCred = 0, cofinsCred = 0, ipiCred = 0, icmsCred = 100;
        let pisDisabled = true, cofinsDisabled = true, ipiDisabled = true, icmsDisabled = false;

        if (regime === "Lucro Real") {
            pisCred = 100.00;
            cofinsCred = 100.00;
            ipiCred = 100.00;
            icmsCred = 100.00;
            pisDisabled = false; cofinsDisabled = false; ipiDisabled = false; icmsDisabled = false;
        } else if (regime === "Lucro Presumido") {
            pisCred = 0; cofinsCred = 0; ipiCred = 0;
            icmsCred = 100;
            pisDisabled = true; cofinsDisabled = true; ipiDisabled = true; icmsDisabled = false;
        } else if (regime === "Simples Nacional") {
            pisCred = 0; cofinsCred = 0; ipiCred = 0; icmsCred = 0;
            pisDisabled = true; cofinsDisabled = true; ipiDisabled = true; icmsDisabled = true;
        }
        
        percCredPISInput.value = pisCred.toFixed(2); percCredPISInput.disabled = pisDisabled;
        percCredCOFINSInput.value = cofinsCred.toFixed(2); percCredCOFINSInput.disabled = cofinsDisabled;
        percCredIPIInput.value = ipiCred.toFixed(2); percCredIPIInput.disabled = ipiDisabled;
        percCredICMSInput.value = icmsCred.toFixed(2); percCredICMSInput.disabled = icmsDisabled;
    }
    
    function showScreen(screenIdToShow) {
        const screens = document.querySelectorAll('section[role="tabpanel"]');
        const tabs = document.querySelectorAll('button[role="tab"]');

        screens.forEach(screen => {
            const isActive = screen.id === screenIdToShow;
            screen.classList.toggle('active', isActive);
            screen.hidden = !isActive;
        });

        tabs.forEach(tab => {
            const isActive = tab.getAttribute('aria-controls') === screenIdToShow;
            tab.classList.toggle('active', isActive);
            tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
            tab.setAttribute('tabindex', isActive ? '0' : '-1');
        });
    }

    // --- PERSISTÊNCIA DE DADOS ---
    function saveState() {
        try {
            const data = {
                global: {},
                items: [],
                lang: geId('idiomaSelect').value
            };

            const globalFields = ['nomeUsuario', 'nomeFornecedor', 'refInterna', 'numeroPI', 'diProcesso', 'dataCalculo', 'moedaEstrangeira', 'taxaCambio', 'incoterm', 'modalidadeTransporte', 'regimeTributario', 'percCreditoPIS', 'percCreditoCOFINS', 'percCreditoIPI', 'percCreditoICMS', 'totalFreteME', 'totalSeguroME', 'totalOutrasDespesasME', 'taxaSiscomexBRL', 'despesasAduaneirasBRL', 'freteNacionalBRL', 'aliquotaAFRMM', 'observacoesGerais'];
            globalFields.forEach(id => {
                const elem = geId(id);
                if (elem) {
                    data.global[id] = elem.value;
                }
            });

            const itemRows = geId('itemInputTable').getElementsByTagName('tbody')[0].rows;
            for (let i = 0; i < itemRows.length; i++) {
                const itemData = {};
                const itemFields = ['desc', 'codInterno', 'ncm', 'qtd', 'precoCustoUnitME', 'pesoUnitKG', 'aliqII', 'aliqIPI', 'aliqPIS', 'aliqCOFINS', 'aliqICMS', 'valVendaUnitBR'];
                itemFields.forEach(field => {
                    const elem = geId(`${field}Item${i}`);
                    if (elem) {
                        itemData[field] = elem.value;
                    }
                });
                data.items.push(itemData);
            }

            localStorage.setItem('importCalculatorData', JSON.stringify(data));
            
            const statusElem = geId('saveStatus');
            if (statusElem) {
                statusElem.textContent = 'Salvando...';
                statusElem.style.opacity = '1';
                if (saveTimeout) clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    statusElem.textContent = 'Salvo ✓';
                    setTimeout(() => { statusElem.style.opacity = '0'; }, 2000);
                }, 800);
            }
        } catch (e) {
            console.error("Erro ao salvar o estado:", e);
            showToast("Erro ao salvar dados no navegador.", 'error');
        }
    }

    function loadState() {
        try {
            const savedData = localStorage.getItem('importCalculatorData');
            if (!savedData) {
                limparTodosOsCampos(false); 
                return;
            }

            const data = JSON.parse(savedData);
            
            if (data.lang) {
                geId('idiomaSelect').value = data.lang;
                applyTranslations(data.lang);
            }

            if (data.global) {
                for (const id in data.global) {
                    const elem = geId(id);
                    if (elem) {
                        elem.value = data.global[id];
                    }
                }
            }

            const tbody = geId('itemInputTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            if (data.items && data.items.length > 0) {
                data.items.forEach((item, index) => {
                    createItemInputRow(index, item);
                });
            } else {
                 createItemInputRow(0); 
            }
            
            handleRegimeChange();
            updateCotacaoButtonLabel();
            
            console.log("Estado carregado do localStorage.");
        } catch (e) {
            console.error("Erro ao carregar o estado:", e);
            limparTodosOsCampos(true); 
        }
    }

    // --- VALIDAÇÃO DE FORMULÁRIO ---
    function validateForm() {
        let isValid = true;
        clearValidations();
    
        const checkField = (elemId, isNumeric = true) => {
            const elem = geId(elemId);
            const errorMsgId = `${elemId}Error`;
            const errorElem = geId(errorMsgId);
    
            let isInvalid = false;
            if (isNumeric) {
                const value = elem.value.trim();
                if (value === '' || isNaN(parseFloat(value.replace(',', '.'))) || parseFloat(value.replace(',', '.')) < 0) {
                    isInvalid = true;
                }
            } else {
                if (elem.value.trim() === '') {
                    isInvalid = true;
                }
            }
    
            if (isInvalid) {
                elem.classList.add('invalid-field');
                if (errorElem) {
                    errorElem.style.display = 'block';
                }
                isValid = false;
            }
        };
    
        ['nomeUsuario', 'nomeFornecedor', 'refInterna', 'numeroPI', 'diProcesso', 'dataCalculo'].forEach(id => checkField(id, false));
        ['taxaCambio', 'totalFreteME', 'taxaSiscomexBRL'].forEach(id => checkField(id, true));
    
        const itemRows = geId('itemInputTable').getElementsByTagName('tbody')[0].rows;
        let hasAtLeastOneItem = false;
        for (let i = 0; i < itemRows.length; i++) {
            const qtd = geId(`qtdItem${i}`).value.trim();
            const preco = geId(`precoCustoUnitMEItem${i}`).value.trim();
            if (qtd || preco) {
                 hasAtLeastOneItem = true;
                ['qtd', 'precoCustoUnitME'].forEach(field => {
                    checkField(`${field}Item${i}`, true);
                });
            }
        }
        
        if (!hasAtLeastOneItem) {
            isValid = false;
            showToast("Adicione pelo menos um item com quantidade e preço para calcular.", "warning");
        }
    
        return isValid;
    }

    function clearValidations() {
        document.querySelectorAll('.invalid-field').forEach(el => el.classList.remove('invalid-field'));
        document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
    }

    // --- INICIALIZAÇÃO ---
    window.onload = function() {
        loadState();
        
        geId('appContainer').addEventListener('input', saveState);
        geId('adicionarItemBtn').addEventListener('click', adicionarLinhaItem);
        geId('idiomaSelect').addEventListener('change', (e) => applyTranslations(e.target.value));

        
        updateCotacaoButtonLabel();
        handleRegimeChange();
        setupDragAndDrop();
        
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsModalBtn = document.getElementById('closeSettingsModalBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const body = document.body;
        const themeIcon = themeToggleBtn ? themeToggleBtn.querySelector('i') : null;
        const themeSrText = themeToggleBtn ? themeToggleBtn.querySelector('.sr-only') : null;

        function applyTheme(theme, manual = false) {
            if (theme === 'theme-dark') {
                body.classList.add('theme-dark');
                if (themeIcon) themeIcon.className = 'fas fa-sun';
                if (themeSrText) themeSrText.textContent = "Alternar para tema claro";
                if (themeToggleBtn) themeToggleBtn.setAttribute('aria-label', 'Alternar para tema claro');
            } else {
                body.classList.remove('theme-dark');
                if (themeIcon) themeIcon.className = 'fas fa-moon';
                if (themeSrText) themeSrText.textContent = "Alternar para tema escuro";
                if (themeToggleBtn) themeToggleBtn.setAttribute('aria-label', 'Alternar para tema escuro');
            }
            localStorage.setItem('theme', theme);
            if(manual) localStorage.setItem('theme_manually_set', 'true');
        }

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('theme-dark');
            } else {
                applyTheme('theme-light');
            }
        }

        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', () => {
                let newTheme = body.classList.contains('theme-dark') ? 'theme-light' : 'theme-dark';
                applyTheme(newTheme, true);
            });
        }
        
        if (settingsBtn && settingsModal && closeSettingsModalBtn && saveSettingsBtn) {
            settingsBtn.addEventListener('click', () => {
                settingsModal.classList.add('active');
            });
            closeSettingsModalBtn.addEventListener('click', () => {
                settingsModal.classList.remove('active');
            });
            saveSettingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('active');
            });
            settingsModal.addEventListener('click', (event) => {
                if (event.target === settingsModal) {
                    settingsModal.classList.remove('active');
                }
            });
        }

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (!localStorage.getItem('theme_manually_set')) {
                const newColorScheme = event.matches ? "theme-dark" : "theme-light";
                applyTheme(newColorScheme);
            }
        });
        
        const appVersionElem = geId('appVersion');
        if (appVersionElem) {
            const titleText = document.title;
            const versionMatch = titleText.match(/v\d+\.\d+(\.\d+)?/);
            if (versionMatch) {
                appVersionElem.textContent = versionMatch[0];
            }
        }
        const footerInfoElem = geId('footerInfo');
        if(footerInfoElem) footerInfoElem.textContent = `Criado por Diego Karloh | ${appVersionElem ? appVersionElem.textContent : 'Ferramenta de Calculo de Importação'}`;

        showScreen('telaEntradaPanel');
    };

    function getLucroCellStyle(lucroPercentual, lucroAltoMin, lucroMedioMin, lucroBaixoMin) {
        let styleClass = '';
        if (lucroPercentual !== null && isFinite(lucroPercentual)) {
            if (lucroPercentual >= lucroAltoMin) {
                styleClass = 'profit-high';
            } else if (lucroPercentual >= lucroMedioMin) {
                styleClass = 'profit-medium';
            } else if (lucroPercentual >= lucroBaixoMin) {
                styleClass = 'profit-low';
            } else {
                styleClass = 'profit-loss';
            }
        }
        return `class="${styleClass}"`;
    }

    // --- LÓGICA DE CÁLCULO PRINCIPAL ---
    function calcularCustosMultiItem() {
        if (!validateForm()) {
            showToast("Por favor, corrija os campos obrigatórios em vermelho.", 'error');
            return;
        }

        try {
            const lucroAltoMin = TxtToNum('modalLucroAltoMin') || 40;
            const lucroMedioMin = TxtToNum('modalLucroMedioMin') || 30;
            const lucroBaixoMin = TxtToNum('modalLucroBaixoMin') || 20;

            const regimeTributario = geId('regimeTributario').value;
            let percCreditoPIS_dec = TxtToNum('percCreditoPIS') / 100;
            let percCreditoCOFINS_dec = TxtToNum('percCreditoCOFINS') / 100;
            let percCreditoIPI_dec = TxtToNum('percCreditoIPI') / 100;
            let percCreditoICMS_dec = TxtToNum('percCreditoICMS') / 100;

            if (geId('percCreditoPIS').disabled) percCreditoPIS_dec = 0;
            if (geId('percCreditoCOFINS').disabled) percCreditoCOFINS_dec = 0;
            if (geId('percCreditoIPI').disabled) percCreditoIPI_dec = 0;
            if (geId('percCreditoICMS').disabled) percCreditoICMS_dec = 0;

            const moedaEstrangeiraElem = geId('moedaEstrangeira');
            const moedaLabel = moedaEstrangeiraElem ? (moedaEstrangeiraElem.value.toUpperCase() || "USD") : "USD";
            
            const taxaCambio = TxtToNum('taxaCambio');
            const totalFreteME_global = TxtToNum('totalFreteME');
            const totalSeguroME_global = TxtToNum('totalSeguroME');
            const totalOutrasDespesasME_global = TxtToNum('totalOutrasDespesasME');
            const taxaSiscomexBRL_global = TxtToNum('taxaSiscomexBRL');
            const despesasAduaneirasBRL_global = TxtToNum('despesasAduaneirasBRL');
            const freteNacionalBRL_global = TxtToNum('freteNacionalBRL');
            const aliqAFRMM_global_dec = TxtToNum('aliquotaAFRMM') / 100;

            let items = [];
            let valorFOBTotalME = 0;
            let pesoTotalEmbarqueKG = 0;
            let valorTotalVendaBrasil = 0;
            let somaTotalPesosUnitariosKG = 0;

            const itemRows = geId('itemInputTable').getElementsByTagName('tbody')[0].rows;
            for (let i = 0; i < itemRows.length; i++) {
                const qtd = TxtToNum(`qtdItem${i}`);
                const precoCustoUnitME = TxtToNum(`precoCustoUnitMEItem${i}`);

                if (precoCustoUnitME > 0 || qtd > 0) {
                    const desc = geId(`descItem${i}`).value || `Item ${i+1}`;
                    const codInterno = geId(`codInternoItem${i}`).value;
                    const ncm = geId(`ncmItem${i}`).value;
                    const pesoUnitKG = TxtToNum(`pesoUnitKGItem${i}`);
                    const valVendaUnitBR = TxtToNum(`valVendaUnitBRItem${i}`);
                    const precoCustoTotalME = qtd * precoCustoUnitME;
                    const pesoTotalKG = qtd * pesoUnitKG;
                    
                    const aliqII_item = TxtToNum(`aliqIIItem${i}`) / 100;
                    const aliqIPI_item = TxtToNum(`aliqIPIItem${i}`) / 100;
                    const aliqPIS_item = TxtToNum(`aliqPISItem${i}`) / 100;
                    const aliqCOFINS_item = TxtToNum(`aliqCOFINSItem${i}`) / 100;
                    const aliqICMS_item = TxtToNum(`aliqICMSItem${i}`) / 100;
                    
                    items.push({
                        index: i, descricao: desc, codInterno: codInterno, ncm: ncm, quantidade: qtd,
                        precoCustoUnitME: precoCustoUnitME, precoCustoTotalME: precoCustoTotalME,
                        pesoUnitKG: pesoUnitKG, pesoTotalKG: pesoTotalKG,
                        valorVendaUnitBR: valVendaUnitBR,
                        aliqII: aliqII_item, aliqIPI: aliqIPI_item, aliqPIS: aliqPIS_item,
                        aliqCOFINS: aliqCOFINS_item, aliqICMS: aliqICMS_item
                    });
                    valorFOBTotalME += precoCustoTotalME;
                    pesoTotalEmbarqueKG += pesoTotalKG;
                    valorTotalVendaBrasil += valVendaUnitBR * qtd;
                    somaTotalPesosUnitariosKG += pesoUnitKG;
                }
            }
            
            const valorFOBTotalEmbarqueBRL = valorFOBTotalME * taxaCambio;
            let acc = {
                fob_BRL: 0, frete_BRL: 0, seguro_BRL: 0, outrasDespME_BRL: 0, CIF_Total_BRL_acumulado: 0,
                ii_BRL: 0,
                ipi_pago_BRL: 0, ipi_creditado_BRL: 0, ipi_efetivo_BRL: 0,
                pis_pago_BRL: 0, pis_creditado_BRL: 0, pis_efetivo_BRL: 0,
                cofins_pago_BRL: 0, cofins_creditado_BRL: 0, cofins_efetivo_BRL: 0,
                baseCalcICMS_BRL_total: 0,
                icms_pago_BRL: 0, icms_creditado_BRL: 0, icms_efetivo_BRL: 0,
                afrmm_BRL: 0, siscomex_BRL: 0, despAduan_BRL: 0, freteNac_BRL: 0,
                totalCreditosFiscais_BRL: 0, totalGeral_BRL: 0,
                totalPesoKG: pesoTotalEmbarqueKG,
                totalQtdItens: 0, totalImpostosPagosBruto: 0, custoMedioPorKG: 0,
                totalImpostosEfetivosGlobal: 0,
                valorTotalNF_BRL_acumulado: 0
            };
            const freteTotalGlobalBRL = totalFreteME_global * taxaCambio;

            items.forEach(item => {
                let percParticipacaoPesoTotalLinha = (acc.totalPesoKG > 0) ? (item.pesoTotalKG / acc.totalPesoKG) : (items.length > 0 ? 1 / items.length : 0);
                
                item.fobBRL_item = item.precoCustoTotalME * taxaCambio;
                item.fobPercent = (valorFOBTotalME > 0) ? (item.precoCustoTotalME / valorFOBTotalME * 100) : 0;
                
                item.percRateioPesoUnit = (somaTotalPesosUnitariosKG > 0) ? (item.pesoUnitKG / somaTotalPesosUnitariosKG * 100) : 0;
                item.freteExibicaoPorPesoUnitarioBRL = freteTotalGlobalBRL * (item.fobPercent / 100);

                item.seguroME_item = totalSeguroME_global * (item.fobPercent / 100);
                item.outrasDespesasME_item = totalOutrasDespesasME_global * (item.fobPercent / 100);
                
                item.taxaSiscomexRateada_BRL_item = taxaSiscomexBRL_global * (item.fobPercent / 100);
                item.despesasAduaneirasBRL_item = despesasAduaneirasBRL_global * percParticipacaoPesoTotalLinha;
                item.freteNacionalBRL_item = freteNacionalBRL_global * percParticipacaoPesoTotalLinha;
                
                const seguroBRL_item = item.seguroME_item * taxaCambio;
                const outrasDespesasBRL_item = item.outrasDespesasME_item * taxaCambio;
                
                item.CIF_Total_BRL = item.fobBRL_item + item.freteExibicaoPorPesoUnitarioBRL + seguroBRL_item + outrasDespesasBRL_item;
                item.valorII = item.CIF_Total_BRL * item.aliqII;

                item.valorTotalNF_BRL = item.CIF_Total_BRL + item.valorII;
                item.valorUnitarioNF_BRL = item.quantidade > 0 ? item.valorTotalNF_BRL / item.quantidade : 0;
                item.precoVendaTotalBrasil = item.valorVendaUnitBR * item.quantidade;

                const baseIPI = item.CIF_Total_BRL + item.valorII;
                item.ipi_pago = baseIPI * item.aliqIPI;
                item.ipi_creditado = item.ipi_pago * percCreditoIPI_dec;
                item.ipi_efetivo = item.ipi_pago - item.ipi_creditado;

                item.pis_pago = item.CIF_Total_BRL * item.aliqPIS;
                item.pis_creditado = item.pis_pago * percCreditoPIS_dec;
                item.pis_efetivo = item.pis_pago - item.pis_creditado;
                
                item.cofins_pago = item.CIF_Total_BRL * item.aliqCOFINS;
                item.cofins_creditado = item.cofins_pago * percCreditoCOFINS_dec;
                item.cofins_efetivo = item.cofins_pago - item.cofins_creditado;
                
                const freteBRL_item_para_AFRMM = freteTotalGlobalBRL * (item.fobPercent / 100);
                item.valorAFRMM = freteBRL_item_para_AFRMM * aliqAFRMM_global_dec;

                item.baseCalcICMS_item = (item.CIF_Total_BRL + item.valorII + item.ipi_pago + item.pis_pago + item.cofins_pago + item.taxaSiscomexRateada_BRL_item) / (1 - item.aliqICMS);
                item.icms_pago = item.baseCalcICMS_item * item.aliqICMS;
                item.icms_creditado = item.icms_pago * percCreditoICMS_dec;
                item.icms_efetivo = item.icms_pago - item.icms_creditado;

                item.custoTotalComTodosImpostos_BRL = item.CIF_Total_BRL + item.valorII + item.ipi_pago + item.pis_pago + item.cofins_pago + item.icms_pago + item.taxaSiscomexRateada_BRL_item + item.valorAFRMM + item.despesasAduaneirasBRL_item + item.freteNacionalBRL_item;
                item.custoUnitarioComTodosImpostos_BRL = item.quantidade > 0 ? item.custoTotalComTodosImpostos_BRL / item.quantidade : 0;
                
                item.somaImpostosQueCreditam_BRL = item.ipi_pago + item.pis_pago + item.cofins_pago + item.icms_pago;
                item.somaImpostosComCreditos_BRL = item.valorII + item.ipi_efetivo + item.pis_efetivo + item.cofins_efetivo + item.icms_efetivo + item.taxaSiscomexRateada_BRL_item + item.valorAFRMM;
                
                item.totalImpostosEspecificosItem = item.valorII + item.ipi_efetivo + item.pis_efetivo + item.cofins_efetivo + item.icms_efetivo;
                item.totalCreditosItem = item.pis_creditado + item.cofins_creditado + item.ipi_creditado + item.icms_creditado;
                
                item.custoTotalLinha = item.CIF_Total_BRL + item.valorII + item.ipi_efetivo + item.pis_efetivo + item.cofins_efetivo + item.valorAFRMM + item.taxaSiscomexRateada_BRL_item + item.despesasAduaneirasBRL_item + item.icms_efetivo + item.freteNacionalBRL_item;
                item.custoUnitarioItem = item.quantidade > 0 ? item.custoTotalLinha / item.quantidade : 0;
                
                if (item.valorVendaUnitBR > 0 && item.custoUnitarioItem > 0) {
                    item.lucroPercentualUnitario = ((item.valorVendaUnitBR - item.custoUnitarioItem) / item.custoUnitarioItem) * 100;
                } else if (item.valorVendaUnitBR > 0 && item.custoUnitarioItem <= 0) {
                    item.lucroPercentualUnitario = Infinity;
                } else { item.lucroPercentualUnitario = null; }
                
                acc.fob_BRL += item.fobBRL_item;
                acc.frete_BRL += item.freteExibicaoPorPesoUnitarioBRL;
                acc.seguro_BRL += seguroBRL_item;
                acc.outrasDespME_BRL += outrasDespesasBRL_item;
                acc.CIF_Total_BRL_acumulado += item.CIF_Total_BRL;
                acc.ii_BRL += item.valorII;
                acc.ipi_pago_BRL += item.ipi_pago; acc.ipi_creditado_BRL += item.ipi_creditado; acc.ipi_efetivo_BRL += item.ipi_efetivo;
                acc.pis_pago_BRL += item.pis_pago; acc.pis_creditado_BRL += item.pis_creditado; acc.pis_efetivo_BRL += item.pis_efetivo;
                acc.cofins_pago_BRL += item.cofins_pago; acc.cofins_creditado_BRL += item.cofins_creditado; acc.cofins_efetivo_BRL += item.cofins_efetivo;
                acc.baseCalcICMS_BRL_total += item.baseCalcICMS_item;
                acc.icms_pago_BRL += item.icms_pago; acc.icms_creditado_BRL += item.icms_creditado; acc.icms_efetivo_BRL += item.icms_efetivo;
                acc.afrmm_BRL += item.valorAFRMM;
                acc.totalCreditosFiscais_BRL += item.totalCreditosItem;
                acc.totalQtdItens += item.quantidade;
                acc.valorTotalNF_BRL_acumulado += item.valorTotalNF_BRL;
                acc.siscomex_BRL += item.taxaSiscomexRateada_BRL_item;
            });
            
            latestCalculationResults = { items, acc, moedaLabel, lucroAltoMin, lucroMedioMin, lucroBaixoMin, valorTotalVendaBrasil, valorFOBTotalME, taxaCambio };

            renderResultsTable(latestCalculationResults);
            renderSummary(latestCalculationResults);
            renderDashboard(latestCalculationResults);

            showToast("Cálculo realizado com sucesso!", "success");
            showScreen('telaDashboardPanel');
            renderizarGraficoCustos(
                [acc.fob_BRL, (acc.frete_BRL + acc.seguro_BRL + acc.outrasDespME_BRL), acc.ii_BRL, (acc.ipi_efetivo_BRL + acc.pis_efetivo_BRL + acc.cofins_efetivo_BRL), acc.icms_efetivo_BRL, (acc.afrmm_BRL + acc.siscomex_BRL), (despesasAduaneirasBRL_global + freteNacionalBRL_global)],
                ['FOB', 'Frete/Seg. Intl.', 'II', 'IPI/PIS/COFINS Efet.', 'ICMS Efet.', 'Taxas (AFRMM/Sisc.)', 'Desp. Nacionais']
            );

        } catch (e) {
            console.error("Erro detalhado em calcularCustosMultiItem:", e, e.stack);
            showToast("Erro crítico ao calcular. Verifique os valores.", 'error');
        }
    }

    function limparTodosOsCampos(clearStorage = true) {
        const lang = geId('idiomaSelect').value;
        const confirmMsg = translations[lang].confirmLimparCampos;

        if (clearStorage && !confirm(confirmMsg)) {
            return; // O usuário cancelou
        }
        
        if(clearStorage){
             localStorage.removeItem('importCalculatorData');
            const statusElem = geId('saveStatus');
            if(statusElem) statusElem.style.opacity = '0';
            console.log("Dados salvos foram removidos.");
        }


        clearValidations();
        const globalInputs = ['nomeUsuario', 'nomeFornecedor', 'refInterna', 'numeroPI', 'diProcesso',
                              'moedaEstrangeira', 'taxaCambio', 'totalFreteME', 'totalSeguroME',
                              'totalOutrasDespesasME', 'taxaSiscomexBRL', 'despesasAduaneirasBRL',
                              'freteNacionalBRL', 'aliquotaAFRMM', 'observacoesGerais'];
        globalInputs.forEach(id => {
            const elem = geId(id);
            if (elem) {
                if (elem.type === 'number' || elem.type === 'text' || elem.tagName.toLowerCase() === 'textarea') elem.value = '';
                if (id === 'moedaEstrangeira') elem.value = 'USD';
                if (id === 'taxaCambio') elem.value = '';
            }
        });
        geId('dataCalculo').valueAsDate = new Date();
        geId('incoterm').value = 'CPT';
        geId('modalidadeTransporte').value = 'Aereo';
        geId('regimeTributario').value = 'Lucro Real';
        handleRegimeChange();
        updateCotacaoButtonLabel();
        geId('cotacaoInfo').textContent = '';

        const tbody = geId('itemInputTable').getElementsByTagName('tbody')[0];
        if (tbody) tbody.innerHTML = '';
        createItemInputRow(0);

        const resultTbody = geId('itemResultTable')?.getElementsByTagName('tbody')[0];
        if (resultTbody) resultTbody.innerHTML = '';
        const summaryDiv = geId('resultsSummary');
        if (summaryDiv) summaryDiv.innerHTML = '';
        if (custoTotalChartInstance) {
            custoTotalChartInstance.destroy();
            custoTotalChartInstance = null;
        }
        
        showScreen('telaEntradaPanel');
        console.log("Todos os campos foram limpos para um novo cálculo.");
    }
    
    // --- Funções de renderização ---
    function renderResultsTable(results) {
        const { items, acc, moedaLabel, lucroAltoMin, lucroMedioMin, lucroBaixoMin, taxaCambio } = results;
        const resultTbody = geId('itemResultTable')?.getElementsByTagName('tbody')[0];
        if (!resultTbody) { console.error("tbody não encontrado para itemResultTable"); return; }
        resultTbody.innerHTML = '';
    
        // Adicionar totais globais no cálculo
        acc.despAduan_BRL = TxtToNum('despesasAduaneirasBRL');
        acc.freteNac_BRL = TxtToNum('freteNacionalBRL');
        
        acc.totalImpostosPagosBruto = acc.ii_BRL + acc.ipi_pago_BRL + acc.pis_pago_BRL + acc.cofins_pago_BRL + acc.icms_pago_BRL + acc.afrmm_BRL + acc.siscomex_BRL;
        
        acc.totalImpostosEfetivosGlobal = acc.ii_BRL + acc.ipi_efetivo_BRL + acc.pis_efetivo_BRL + acc.cofins_efetivo_BRL + acc.icms_efetivo_BRL + acc.afrmm_BRL + acc.siscomex_BRL;
        
        acc.totalGeral_BRL = acc.CIF_Total_BRL_acumulado + acc.totalImpostosEfetivosGlobal + acc.despAduan_BRL + acc.freteNac_BRL;
        acc.custoMedioPorKG = acc.totalPesoKG > 0 ? acc.totalGeral_BRL / acc.totalPesoKG : 0;
        
        items.forEach(item => {
            const row = resultTbody.insertRow();
            let lucroCellStyle = getLucroCellStyle(item.lucroPercentualUnitario, lucroAltoMin, lucroMedioMin, lucroBaixoMin);
            
            let lucroDisplay = 'N/A';
            if (item.lucroPercentualUnitario !== null) {
                if (!isFinite(item.lucroPercentualUnitario)) { lucroDisplay = (item.lucroPercentualUnitario > 0 ? "+Inf" : "-Inf") + "%" }
                else { lucroDisplay = item.lucroPercentualUnitario.toFixed(2) + '%'; }
            }
            
            const totalImpostosEfetivosItemComII = item.valorII + item.ipi_efetivo + item.pis_efetivo + item.cofins_efetivo + item.icms_efetivo;
            const fobUnitarioBRL = item.precoCustoUnitME * taxaCambio;
            const seguroRateadoBRL = item.seguroME_item * taxaCambio;
            const outrasDespesasRateadasBRL = item.outrasDespesasME_item * taxaCambio;
            const lucroUnitarioRS = item.valorVendaUnitBR - item.custoUnitarioItem;
            const lucroTotalLinhaRS = lucroUnitarioRS * item.quantidade;
            const participacaoPesoUnitItem = item.percRateioPesoUnit.toFixed(2) + '%';

            row.innerHTML = `
                <td>${item.index + 1}</td> <td>${item.codInterno || ''}</td> <td>${item.descricao || ''}</td> <td>${item.ncm || ''}</td>
                <td>${item.quantidade || 0}</td> <td>${(item.pesoUnitKG || 0).toFixed(3)}</td> <td>${(item.pesoTotalKG || 0).toFixed(3)}</td>
                <td>${participacaoPesoUnitItem}</td> <td>${formatBRL(item.freteExibicaoPorPesoUnitarioBRL)}</td>
                <td>${formatCurrency(item.precoCustoUnitME, moedaLabel)}</td> <td>${formatCurrency(item.precoCustoTotalME, moedaLabel)}</td>
                <td>${formatBRL(fobUnitarioBRL)}</td> <td>${formatBRL(item.fobBRL_item)}</td> <td>${item.fobPercent.toFixed(2).replace('.',',')}%</td>
                <td>${formatBRL(seguroRateadoBRL)}</td> <td>${formatBRL(outrasDespesasRateadasBRL)}</td> <td>${formatBRL(item.CIF_Total_BRL)}</td>
                <td>${formatBRL(item.valorII)}</td> <td>${formatBRL(item.valorTotalNF_BRL)}</td> <td>${formatBRL(item.valorUnitarioNF_BRL)}</td>
                <td>${formatBRL(item.ipi_pago)}</td> <td>${formatBRL(item.ipi_creditado)}</td> <td>${formatBRL(item.ipi_efetivo)}</td>
                <td>${formatBRL(item.taxaSiscomexRateada_BRL_item)}</td> <td>${formatBRL(item.pis_pago)}</td> <td>${formatBRL(item.pis_creditado)}</td>
                <td>${formatBRL(item.pis_efetivo)}</td> <td>${formatBRL(item.cofins_pago)}</td> <td>${formatBRL(item.cofins_creditado)}</td>
                <td>${formatBRL(item.cofins_efetivo)}</td> <td>${formatBRL(item.baseCalcICMS_item)}</td> <td>${formatBRL(item.icms_pago)}</td>
                <td>${formatBRL(item.icms_creditado)}</td> <td>${formatBRL(item.icms_efetivo)}</td> <td>${formatBRL(item.valorAFRMM)}</td>
                <td>${formatBRL(item.despesasAduaneirasBRL_item)}</td> <td>${formatBRL(item.freteNacionalBRL_item)}</td>
                <td>${formatBRL(item.custoTotalComTodosImpostos_BRL)}</td> <td>${formatBRL(item.custoUnitarioComTodosImpostos_BRL)}</td>
                <td>${formatBRL(item.somaImpostosQueCreditam_BRL)}</td> <td>${formatBRL(item.somaImpostosComCreditos_BRL)}</td>
                <td>${formatBRL(totalImpostosEfetivosItemComII)}</td> <td>${formatBRL(item.custoUnitarioItem)}</td>
                <td>${formatBRL(item.custoTotalLinha)}</td> <td>${formatBRL(item.valorVendaUnitBR)}</td> <td>${formatBRL(item.precoVendaTotalBrasil)}</td>
                <td>${formatBRL(lucroUnitarioRS)}</td> <td>${formatBRL(lucroTotalLinhaRS)}</td> <td ${lucroCellStyle}>${lucroDisplay}</td>
            `;
        });
    }

    function renderSummary(results) {
        const { acc } = results;
        const summaryDiv = geId('resultsSummary');
        if (summaryDiv) {
            summaryDiv.innerHTML = `
                <h4 data-translate-key="summaryValoresIniciais">Valores Iniciais e CIF</h4>
                <div class="summary-item"><strong data-translate-key="summaryFOBTotal">Valor FOB Total (BRL):</strong> <span>${formatBRL(acc.fob_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryFreteIntlTotal">Frete Internacional Total (BRL):</strong> <span>${formatBRL(acc.frete_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summarySeguroIntlTotal">Seguro Internacional Total (BRL):</strong> <span>${formatBRL(acc.seguro_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryOutrasDespOrigem">Outras Desp. Origem Total (BRL):</strong> <span>${formatBRL(acc.outrasDespME_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryCIFTotal">CIF Total (BRL):</strong> <span>${formatBRL(acc.CIF_Total_BRL_acumulado)}</span></div>
                <hr>
                <h4 data-translate-key="summaryImpostosPagos">Impostos Pagos (Bruto)</h4>
                <div class="summary-item"><strong data-translate-key="summaryTotalII">Total II (Pago):</strong> <span>${formatBRL(acc.ii_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryTotalIPI">Total IPI (Pago):</strong> <span>${formatBRL(acc.ipi_pago_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryTotalPIS">Total PIS (Pago):</strong> <span>${formatBRL(acc.pis_pago_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryTotalCOFINS">Total COFINS (Pago):</strong> <span>${formatBRL(acc.cofins_pago_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryTotalICMS">Total ICMS (Pago):</strong> <span>${formatBRL(acc.icms_pago_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryTotalAFRMM">Total AFRMM (Pago):</strong> <span>${formatBRL(acc.afrmm_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryTotalSiscomex">Total Taxa Siscomex:</strong> <span>${formatBRL(acc.siscomex_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryTotalImpostosBruto">Total Impostos Pagos (Bruto):</strong> <span>${formatBRL(acc.totalImpostosPagosBruto)}</span></div>
                 <hr>
                <h4 data-translate-key="summaryCreditosCustosOp">Créditos e Custos Operacionais</h4>
                <div class="summary-item"><strong data-translate-key="summaryTotalCreditos">Total Créditos Fiscais Estimados:</strong> <span style="color: var(--theme-accent-green);">${formatBRL(acc.totalCreditosFiscais_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryTotalDespAdu">Total Desp. Aduaneiras:</strong> <span>${formatBRL(acc.despAduan_BRL)}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryTotalFreteNac">Total Frete Nacional:</strong> <span>${formatBRL(acc.freteNac_BRL)}</span></div>
                <hr>
                <h4 data-translate-key="summaryTotaisEmbarque">Totais do Embarque</h4>
                <div class="summary-item"><strong data-translate-key="summaryTotalQtdItens">Total Quantidade de Itens:</strong> <span>${acc.totalQtdItens.toLocaleString('pt-BR')}</span></div>
                <div class="summary-item"><strong data-translate-key="summaryTotalPesoEmbarque">Total Peso do Embarque (KG):</strong> <span>${acc.totalPesoKG.toFixed(3).replace('.',',')} KG</span></div>
                <div class="summary-item"><strong data-translate-key="summaryCustoMedioKG">Custo Médio por KG (R$):</strong> <span>${formatBRL(acc.custoMedioPorKG)}</span></div>
                <hr>
                <div class="summary-item total-geral"><strong data-translate-key="summaryCustoTotalGeral">CUSTO TOTAL GERAL (LÍQUIDO DE CRÉDITOS) (BRL):</strong> <span>${formatBRL(acc.totalGeral_BRL)}</span></div>
            `;
        }
    }

    function renderDashboard(results) {
        const { acc, items, moedaLabel, valorFOBTotalME, valorTotalVendaBrasil, lucroAltoMin, lucroMedioMin, lucroBaixoMin } = results;
        const lucroTotalPedidoRS = valorTotalVendaBrasil - acc.totalGeral_BRL;
        const lucroTotalPedidoPerc = (acc.totalGeral_BRL > 0) ? (lucroTotalPedidoRS / acc.totalGeral_BRL) * 100 : (valorTotalVendaBrasil > 0 ? Infinity : 0);
        const percFreteSobreFOB = acc.fob_BRL > 0 ? (acc.frete_BRL / acc.fob_BRL) * 100 : 0;
        
        const totalCustoProduto = acc.fob_BRL;
        const totalImpostosEfetivos = acc.totalImpostosEfetivosGlobal;
        const totalOutrosCustos = acc.totalGeral_BRL - totalCustoProduto - totalImpostosEfetivos;
        
        const percCustoProduto = (acc.totalGeral_BRL > 0) ? (totalCustoProduto / acc.totalGeral_BRL) * 100 : 0;
        const percImpostos = (acc.totalGeral_BRL > 0) ? (totalImpostosEfetivos / acc.totalGeral_BRL) * 100 : 0;
        const percOutros = (acc.totalGeral_BRL > 0) ? (totalOutrosCustos / acc.totalGeral_BRL) * 100 : 0;

        function setInnerTextDashboard(id, value, isCurrency = false, currencyCodeForME = 'USD', highlightClass = '') {
            const elem = geId(id);
            if (elem) {
                if (id === 'dbValorPedidoME') {
                    elem.textContent = formatCurrency(value, currencyCodeForME);
                } else {
                    elem.textContent = isCurrency ? formatBRL(value) : value;
                }
                // Reset classes. Remove specific highlights before adding a new one.
                elem.classList.remove('profit-positive', 'profit-negative', 'blue-highlight', 'orange-highlight');
                if (highlightClass) elem.classList.add(highlightClass);
            }
        }
        
        const prominentProfitCard = geId('prominentProfitCard');
        const dbProminentLucroTotalPedidoPerc = geId('dbProminentLucroTotalPedidoPerc');
        if (prominentProfitCard && dbProminentLucroTotalPedidoPerc) {
            if (isFinite(lucroTotalPedidoPerc)) {
                dbProminentLucroTotalPedidoPerc.textContent = lucroTotalPedidoPerc.toFixed(2).replace('.',',') + '%';
                prominentProfitCard.style.display = 'block';
                dbProminentLucroTotalPedidoPerc.classList.remove('profit-positive', 'profit-negative');
                dbProminentLucroTotalPedidoPerc.classList.add(lucroTotalPedidoPerc >= 0 ? 'profit-positive' : 'profit-negative');
            } else {
                prominentProfitCard.style.display = 'none';
            }
        }
        
        setInnerTextDashboard('dbValorPedidoME', valorFOBTotalME, true, moedaLabel, 'blue-highlight');
        setInnerTextDashboard('dbTotalCustoImp', acc.totalGeral_BRL, true, '', 'orange-highlight');
        setInnerTextDashboard('dbReceitaTotalBrasil', valorTotalVendaBrasil, true);
        setInnerTextDashboard('dbLucroTotalPedidoRS', lucroTotalPedidoRS, true, '', lucroTotalPedidoRS >= 0 ? 'profit-positive' : 'profit-negative');
        setInnerTextDashboard('dbLucroTotalPedidoPerc', isFinite(lucroTotalPedidoPerc) ? lucroTotalPedidoPerc.toFixed(2).replace('.',',') + '%' : 'N/A', false, '', lucroTotalPedidoPerc >= 0 ? 'profit-positive' : 'profit-negative');
        
        setInnerTextDashboard('dbTotalFOB_BRL', acc.fob_BRL, true);
        setInnerTextDashboard('dbFreteTotalBRL', acc.frete_BRL, true);
        setInnerTextDashboard('dbPercFreteSobreFOB', percFreteSobreFOB.toFixed(2).replace('.',',') + '%');
        setInnerTextDashboard('dbTotalImpostosBruto', acc.totalImpostosPagosBruto, true);
        setInnerTextDashboard('dbTotalImpostosEfetivos', acc.totalImpostosEfetivosGlobal, true);

        // Renderizar as barras de distribuição
        const distTotal = acc.totalGeral_BRL > 0 ? acc.totalGeral_BRL : 1;
        const distProdutoPerc = ((acc.fob_BRL) / distTotal) * 100;
        const distFreteSegPerc = ((acc.frete_BRL + acc.seguro_BRL + acc.outrasDespME_BRL) / distTotal) * 100;
        const distImpFedPerc = ((acc.ii_BRL + acc.ipi_efetivo_BRL + acc.pis_efetivo_BRL + acc.cofins_efetivo_BRL + acc.afrmm_BRL + acc.siscomex_BRL) / distTotal) * 100;
        const distICMSPerc = (acc.icms_efetivo_BRL / distTotal) * 100;
        const distDespNacPerc = ((acc.despAduan_BRL + acc.freteNac_BRL) / distTotal) * 100;
        
        geId('dbDistProduto').textContent = distProdutoPerc.toFixed(1) + '%';
        geId('barDistProduto').style.width = distProdutoPerc + '%';
        geId('dbDistFreteSegInt').textContent = distFreteSegPerc.toFixed(1) + '%';
        geId('barDistFreteSegInt').style.width = distFreteSegPerc + '%';
        geId('dbDistImpFed').textContent = distImpFedPerc.toFixed(1) + '%';
        geId('barDistImpFed').style.width = distImpFedPerc + '%';
        geId('dbDistICMS').textContent = distICMSPerc.toFixed(1) + '%';
        geId('barDistICMS').style.width = distICMSPerc + '%';
        geId('dbDistDespNac').textContent = distDespNacPerc.toFixed(1) + '%';
        geId('barDistDespNac').style.width = distDespNacPerc + '%';

        geId('compPercProduto').textContent = percCustoProduto.toFixed(2).replace('.',',') + '%';
        geId('compPercImpostos').textContent = percImpostos.toFixed(2).replace('.',',') + '%';
        geId('compPercOutros').textContent = percOutros.toFixed(2).replace('.',',') + '%';

        const renderList = (listId, sortedItems, maxItems = 10) => {
            const listElement = geId(listId);
            if (!listElement) return;
            listElement.innerHTML = '';
            if (sortedItems.length > 0) {
                const maxAbsValue = Math.max(...sortedItems.map(item => Math.abs(item.lucroPercentualUnitario)));
                sortedItems.slice(0, maxItems).forEach(item => {
                    const li = document.createElement('li');
                    const barWidth = maxAbsValue > 0 ? (Math.abs(item.lucroPercentualUnitario) / maxAbsValue) * 100 : 0;
                    const displayLucro = item.lucroPercentualUnitario.toFixed(2).replace('.',',') + '%';
                    const profitBarClass = getLucroCellStyle(item.lucroPercentualUnitario, lucroAltoMin, lucroMedioMin, lucroBaixoMin).replace('class="','').replace('"','');
                    li.innerHTML = `<span class="item-name" title="${item.descricao || item.codInterno || 'Item'}">${item.descricao || item.codInterno || `Item ${item.index + 1}`}</span><div class="item-bar-container"><div class="item-bar ${profitBarClass}" style="width: ${barWidth}%;"></div></div><span class="item-value">${displayLucro}</span>`;
                    listElement.appendChild(li);
                });
            } else {
                listElement.innerHTML = '<li>Nenhum item com lucro calculável para exibir.</li>';
            }
        };

        const itemsComLucroValido = items.filter(item => item.lucroPercentualUnitario !== null && isFinite(item.lucroPercentualUnitario) && item.quantidade > 0);
        renderList('topLucrativosList', [...itemsComLucroValido].sort((a, b) => b.lucroPercentualUnitario - a.lucroPercentualUnitario));
        renderList('topMenosLucrativosList', [...itemsComLucroValido].sort((a, b) => a.lucroPercentualUnitario - b.lucroPercentualUnitario));
    }

    function renderizarGraficoCustos(data, labels) {
        const ctx = geId('custoTotalPizzaChart')?.getContext('2d');
        if (!ctx) return;
    
        const isDarkMode = document.body.classList.contains('theme-dark');
        const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
        const textColor = isDarkMode ? '#e8e8f0' : '#495057';
    
        const backgroundColors = [
            'rgba(32, 201, 151, 0.7)',  // Verde
            'rgba(0, 123, 255, 0.7)',   // Azul
            'rgba(253, 126, 20, 0.7)',  // Laranja
            'rgba(220, 53, 69, 0.7)',   // Vermelho
            'rgba(255, 193, 7, 0.7)',   // Amarelo
            'rgba(23, 162, 184, 0.7)',  // Ciano
            'rgba(108, 117, 125, 0.7)'  // Cinza
        ];
        const borderColors = backgroundColors.map(color => color.replace('0.7', '1'));
    
        if (custoTotalChartInstance) {
            custoTotalChartInstance.destroy();
        }
    
        custoTotalChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Composição do Custo Total',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: textColor,
                            font: {
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += formatBRL(context.parsed);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // --- FUNÇÕES DE EXPORTAÇÃO E COMPARTILHAMENTO ---
    function gerarPDF() {
        if (!latestCalculationResults) {
            showToast('Calcule primeiro para gerar o PDF.', 'warning');
            return;
        }
        showToast('Iniciando geração do PDF...', 'success');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'p',
            unit: 'mm',
            format: 'a4'
        });

        const { items, acc, valorTotalVendaBrasil } = latestCalculationResults;
        const nomeUsuario = geId('nomeUsuario').value || 'N/A';
        const nomeFornecedor = geId('nomeFornecedor').value || 'N/A';
        const dataCalculo = geId('dataCalculo').value ? new Date(geId('dataCalculo').value).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'N/A';
        const refInterna = geId('refInterna').value || 'N/A';
        const diProcesso = geId('diProcesso').value || 'N/A';
        const appVersion = geId('appVersion')?.textContent || '';

        // Colors from CSS variables
        const primaryColor = '#007bff';
        const textColor = '#212529';
        const secondaryTextColor = '#495057';
        const greenColor = '#20c997';
        const redColor = '#dc3545';
        const pageHeight = doc.internal.pageSize.getHeight();
        const pageWidth = doc.internal.pageSize.getWidth();
        let finalY = 0;

        // --- HEADER and FOOTER ---
        const pageHeader = (data) => {
            doc.setFontSize(16);
            doc.setTextColor(primaryColor);
            doc.setFont(undefined, 'bold');
            doc.text('Relatório de Custo de Importação', pageWidth / 2, 15, { align: 'center' });
            doc.setFont(undefined, 'normal');
        };

        const pageFooter = (data) => {
            const pageCount = doc.internal.getNumberOfPages();
            doc.setFontSize(8);
            doc.setTextColor(secondaryTextColor);
            const footerText = `Gerado por: ${nomeUsuario} | Ferramenta de Importação ${appVersion} | Página ${data.pageNumber} de ${pageCount}`;
            doc.text(footerText, pageWidth / 2, pageHeight - 10, { align: 'center' });
        };
        
        // --- PAGE 1: SUMMARY ---
        // Basic Info
        doc.setFontSize(9);
        doc.setTextColor(secondaryTextColor);
        doc.text(`Fornecedor: ${nomeFornecedor}`, 14, 28);
        doc.text(`Referência: ${refInterna}`, 14, 33);
        doc.text(`DI/Processo: ${diProcesso}`, 14, 38);
        doc.text(`Data do Cálculo: ${dataCalculo}`, pageWidth - 14, 28, { align: 'right' });
        
        // Financial Summary
        doc.setFontSize(12);
        doc.setTextColor(primaryColor);
        doc.setFont(undefined, 'bold');
        doc.text('Resumo Financeiro (BRL)', 14, 50);
        doc.setFont(undefined, 'normal');
        
        const lucroTotalRS = valorTotalVendaBrasil - acc.totalGeral_BRL;
        const lucroCor = lucroTotalRS >= 0 ? greenColor : redColor;

        doc.autoTable({
            startY: 54,
            theme: 'plain',
            body: [
                ['Custo Total Geral (Líquido):', formatBRL(acc.totalGeral_BRL)],
                ['Receita Total Estimada:', formatBRL(valorTotalVendaBrasil)],
                [{ content: 'Lucro Total Estimado:', styles: { fontStyle: 'bold' } }, { content: formatBRL(lucroTotalRS), styles: { fontStyle: 'bold', textColor: lucroCor } }]
            ],
            styles: { fontSize: 10, cellPadding: 2 },
            columnStyles: {
                0: { cellWidth: 50, fontStyle: 'bold', textColor: textColor },
                1: { cellWidth: 'auto', halign: 'right' }
            }
        });
        finalY = doc.lastAutoTable.finalY + 10;

        // KPI Summary
        doc.setFontSize(12);
        doc.setTextColor(primaryColor);
        doc.setFont(undefined, 'bold');
        doc.text('Principais Indicadores (BRL)', 14, finalY);
        doc.setFont(undefined, 'normal');

        doc.autoTable({
            startY: finalY + 4,
            theme: 'grid',
            head: [['Indicador', 'Valor', 'Indicador', 'Valor']],
            body: [
                ['Valor FOB', formatBRL(acc.fob_BRL), 'Total Impostos Pagos (Bruto)', formatBRL(acc.totalImpostosPagosBruto)],
                ['Frete + Seguro Intl.', formatBRL(acc.frete_BRL + acc.seguro_BRL), 'Total Impostos Efetivos', formatBRL(acc.totalImpostosEfetivosGlobal)],
                ['Despesas Nacionais', formatBRL(acc.despAduan_BRL + acc.freteNac_BRL), 'Total Créditos Fiscais', formatBRL(acc.totalCreditosFiscais_BRL)],
            ],
            headStyles: { fillColor: primaryColor, textColor: '#ffffff' },
            styles: { fontSize: 9, cellPadding: 2 },
            alternateRowStyles: { fillColor: '#f8f9fa' }
        });
        finalY = doc.lastAutoTable.finalY;

        // --- PAGE 2+: ITEM LIST ---
        doc.addPage();

        doc.setFontSize(12);
        doc.setTextColor(primaryColor);
        doc.setFont(undefined, 'bold');
        doc.text('Resultados Detalhados por Item', 14, 20);
        doc.setFont(undefined, 'normal');
        
        const tableBody = items.map((item, index) => {
            const lucroUnitarioRS = item.valorVendaUnitBR - item.custoUnitarioItem;
            return [
                index + 1,
                item.codInterno || '-',
                item.descricao,
                item.quantidade,
                formatBRL(item.custoUnitarioItem),
                formatBRL(item.valorVendaUnitBR),
                formatBRL(lucroUnitarioRS),
                `${(item.lucroPercentualUnitario || 0).toFixed(2)}%`
            ]
        });

        doc.autoTable({
            startY: 24,
            head: [['#', 'Cód.', 'Descrição', 'Qtd', 'Custo Unit. Liq.', 'Venda Unit.', 'Lucro Unit.', 'Margem %']],
            body: tableBody,
            theme: 'grid',
            headStyles: { fillColor: primaryColor, textColor: '#ffffff', fontSize: 9 },
            foot: [['Total', '', '', acc.totalQtdItens.toLocaleString('pt-BR'), '', '', formatBRL(lucroTotalRS), '']],
            footStyles: { fillColor: '#e9ecef', textColor: textColor, fontStyle: 'bold' },
            styles: { fontSize: 8, cellPadding: 1.5, overflow: 'linebreak' },
            columnStyles: {
                0: { halign: 'center', cellWidth: 8 },
                1: { cellWidth: 15 },
                2: { cellWidth: 50 },
                3: { halign: 'right' },
                4: { halign: 'right' },
                5: { halign: 'right' },
                6: { halign: 'right' },
                7: { halign: 'right' }
            },
            didDrawPage: function(data) {
                pageHeader(data);
                pageFooter(data);
            },
            didParseCell: function(data) {
                if (data.column.index === 7 && data.section === 'body') {
                    const lucroPerc = parseFloat(data.cell.raw.toString().replace('%',''));
                    if (lucroPerc < (TxtToNum('modalLucroBaixoMin') || 20)) {
                        data.cell.styles.textColor = redColor;
                    }
                }
            }
        });

        // Add header and footer to the first page manually
        pageHeader({pageNumber: 1});
        pageFooter({pageNumber: 1});

        doc.save(`Relatorio_Importacao_${refInterna.replace(/[\s/]/g, '_')}.pdf`);
    }

    function exportTableToCSV(filename) {
        if (!latestCalculationResults) {
            showToast('Calcule primeiro para exportar.', 'warning');
            return;
        }

        const { items } = latestCalculationResults;
        const delimiter = ';'; // Use semicolon for Brazilian Excel

        const headers = [
            '#', 'Cód. Interno', 'Descrição', 'NCM', 'Qtd',
            'Custo Unit. ME', 'Custo Total ME',
            'Custo Unit. Líquido (BRL)', 'Custo Total Linha (BRL)',
            'Preço Venda Unit. (BRL)', 'Preço Venda Total (BRL)',
            'Lucro Unit. (BRL)', 'Lucro Total Linha (BRL)', 'Margem Lucro (%)',
            'II (BRL)', 'IPI Efetivo (BRL)', 'PIS Efetivo (BRL)', 'COFINS Efetivo (BRL)', 'ICMS Efetivo (BRL)',
            'AFRMM (BRL)', 'Outras Despesas (BRL)'
        ];

        const formatCSVCell = (value) => {
            let output = (value === null || value === undefined) ? '' : String(value);
            // For numbers, replace decimal point with comma for Brazilian locale
            if (typeof value === 'number') {
                output = value.toFixed(2).replace('.', ',');
            }
            // Escape quotes by doubling them and wrap the whole cell in quotes if it contains delimiter, newline or quotes
            if (output.includes('"') || output.includes(delimiter) || output.includes('\n')) {
                output = `"${output.replace(/"/g, '""')}"`;
            }
            return output;
        };

        const rows = items.map((item, index) => {
            const lucroUnitarioRS = item.valorVendaUnitBR - item.custoUnitarioItem;
            const lucroTotalLinhaRS = lucroUnitarioRS * item.quantidade;
            const outrasDespesasRateadas = (item.despesasAduaneirasBRL_item || 0) + (item.freteNacionalBRL_item || 0);

            return [
                index + 1,
                item.codInterno,
                item.descricao,
                item.ncm,
                item.quantidade,
                item.precoCustoUnitME,
                item.precoCustoTotalME,
                item.custoUnitarioItem,
                item.custoTotalLinha,
                item.valorVendaUnitBR,
                item.precoVendaTotalBrasil,
                lucroUnitarioRS,
                lucroTotalLinhaRS,
                item.lucroPercentualUnitario,
                item.valorII,
                item.ipi_efetivo,
                item.pis_efetivo,
                item.cofins_efetivo,
                item.icms_efetivo,
                item.valorAFRMM,
                outrasDespesasRateadas
            ].map(formatCSVCell).join(delimiter);
        });

        const csvContent = [headers.join(delimiter), ...rows].join('\r\n');
        
        // Add BOM for UTF-8 compatibility
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");

        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        showToast('CSV exportado com sucesso!', 'success');
    }


    function shareDashboardViaWhatsApp() {
        if (!latestCalculationResults) {
            showToast('Calcule primeiro para compartilhar.', 'warning');
            return;
        }
    
        const modal = geId('shareImageModal');
        const screenshotImg = geId('dashboardScreenshot');
        const areaToCapture = geId('dashboardScreenshotArea');
        
        showToast('Gerando imagem do dashboard...', 'success');
    
        html2canvas(areaToCapture, {
            backgroundColor: document.body.classList.contains('theme-dark') ? '#1c1c1c' : '#ffffff',
            scale: 2 // Aumenta a resolução
        }).then(canvas => {
            screenshotImg.src = canvas.toDataURL('image/png');
            modal.style.display = 'flex';
        }).catch(err => {
            console.error('Erro ao gerar a imagem:', err);
            showToast('Falha ao gerar a imagem do dashboard.', 'error');
        });
    }

    geId('closeShareModalBtn')?.addEventListener('click', () => {
        geId('shareImageModal').style.display = 'none';
    });
    geId('shareImageModal')?.addEventListener('click', (event) => {
         if (event.target === geId('shareImageModal')) {
            geId('shareImageModal').style.display = 'none';
         }
    });

    // --- DRAG AND DROP ---
    function setupDragAndDrop() {
        const tbody = geId('itemInputTable').getElementsByTagName('tbody')[0];

        tbody.addEventListener('dragstart', (e) => {
            draggedRow = e.target.closest('tr');
            if(draggedRow){
                setTimeout(() => {
                    draggedRow.classList.add('dragging');
                }, 0);
            }
        });

        tbody.addEventListener('dragend', (e) => {
            if(draggedRow) {
                draggedRow.classList.remove('dragging');
                draggedRow = null;
            }
        });

        tbody.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(tbody, e.clientY);
            if (draggedRow) {
                if (afterElement == null) {
                    tbody.appendChild(draggedRow);
                } else {
                    tbody.insertBefore(draggedRow, afterElement);
                }
            }
        });
        
        tbody.addEventListener('drop', (e) => {
             e.preventDefault();
             if(draggedRow){
                renumerarLinhas();
                saveState();
             }
        });
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('tr:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }


    // --- TRANSLATION ---
    const translations = {
        "pt-BR": {
            mainTitle: "Ferramenta de Calculo de Importação",
            tabEntrada: "1. Entrada de Dados",
            tabResultados: "2. Resultados Detalhados",
            tabDashboard: "3. Dashboard e Resumo",
            headingDadosGlobais: "Dados Globais do Embarque",
            sepInfoOrganizacionais: "Informações Organizacionais",
            labelNomeUsuario: "Nome do Usuário:",
            descNomeUsuario: "Nome do responsável pelo cálculo.",
            labelNomeFornecedor: "Nome do Fornecedor:",
            descNomeFornecedor: "Fornecedor dos produtos.",
            labelRefInterna: "Referência Interna / Ordem Compra:",
            descRefInterna: "Código/nome para seu controle interno ou OC.",
            labelNumeroPI: "Número da PI (Proforma):",
            descNumeroPI: "Número da Fatura Proforma.",
            labelDiProcesso: "Número da DI/Processo:",
            descDiProcesso: "Identificador da DI ou do processo.",
            labelDataCalculo: "Data do Cálculo/Embarque:",
            descDataCalculo: "Data relevante para este cálculo.",
            sepDetalhesComerciais: "Detalhes Comerciais e Logísticos",
            labelMoedaEstrangeira: "Moeda Estrangeira Ativa:",
            descMoedaEstrangeira: "Ex: USD, EUR, CNY. Define a moeda para os custos e cotação.",
            labelTaxaCambio: "Taxa de Câmbio (BRL por 1 Unid. Moeda Ativa):",
            descTaxaCambio: "Insira manualmente ou use os botões abaixo.",
            labelIncoterm: "INCOTERM:",
            descIncoterm: "Ex: FOB, CIF. Define responsabilidades.",
            labelModalidadeTransporte: "Modalidade de Transporte:",
            descModalidadeTransporte: "Ex: Marítimo, Aéreo.",
            sepRegimeTributario: "Regime Tributário e Créditos",
            labelRegimeTributario: "Regime Tributário Federal:",
            tooltipRegimeTributario: "Define o regime de tributação da empresa, impactando os créditos fiscais. Lucro Real permite mais créditos, enquanto Simples Nacional não permite.",
            labelPercCreditoPIS: "% Crédito PIS:",
            tooltipCreditoPIS: "Percentual de crédito de PIS a ser aproveitado. Geralmente 100% para Lucro Real e 0% para outros.",
            labelPercCreditoCOFINS: "% Crédito COFINS:",
            tooltipCreditoCOFINS: "Percentual de crédito de COFINS a ser aproveitado. Geralmente 100% para Lucro Real e 0% para outros.",
            labelPercCreditoIPI: "% Crédito IPI:",
            tooltipCreditoIPI: "Percentual de crédito de IPI. Geralmente 100% para indústrias no Lucro Real e 0% para os demais.",
            labelPercCreditoICMS: "% Crédito ICMS:",
            tooltipCreditoICMS: "Percentual de crédito de ICMS. Varia conforme o estado e benefícios fiscais (TTD).",
            sepCustosGlobais: "Custos Globais (Rateados entre os itens)",
            labelTotalFreteME: "Frete Int. TOTAL ($):",
            descTotalFreteME: "Frete principal em Moeda Estrangeira.",
            labelTotalSeguroME: "Seguro Int. TOTAL ($):",
            descTotalSeguroME: "Seguro da carga em Moeda Estrangeira.",
            labelTotalOutrasDespesasME: "Outras Desp. Origem TOTAIS ($):",
            descTotalOutrasDespesasME: "Ex: THC origem, docs, frete interno origem.",
            labelTaxaSiscomexBRL: "Taxa Siscomex TOTAL (BRL):",
            descTaxaSiscomexBRL: "Taxa de uso do Siscomex.",
            labelDespesasAduaneirasBRL: "Desp. Aduaneiras TOTAIS (BRL):",
            descDespesasAduaneirasBRL: "Ex: Despachante, Armazenagem, LI.",
            labelFreteNacionalBRL: "Frete Nacional TOTAL (BRL):",
            descFreteNacionalBRL: "Transporte no Brasil até destino final.",
            labelAliquotaAFRMM: "Alíquota AFRMM Global (%):",
            tooltipAFRMM: "Adicional ao Frete para a Renovação da Marinha Mercante. Padrão 8% para transporte marítimo. Zerar para outros modais.",
            headingObservacoesGerais: "Observações Gerais",
            descObservacoesGerais: "Este campo é para suas anotações e não afeta os cálculos.",
            headingItensEmbarque: "Itens do Embarque",
            noteItensEmbarque: `Insira as alíquotas para cada item (ex: 10 para 10%). Peso é informativo. "Pr. Venda Unit. R$ Brasil" é o preço unitário de venda.`,
            btnAdicionarItem: "Adicionar Novo Item",
            btnCalcular: "Calcular Custos, Lucro e Indicadores",
            btnLimparCampos: "Limpar Todos os Campos",
            confirmLimparCampos: "Tem certeza que deseja limpar todos os campos? Esta ação não pode ser desfeita.",
            modalConfigTitle: "Configurações",
            modalIdiomaTitle: "Idioma",
            modalIdiomaLabel: "Selecionar Idioma:",
            modalIdiomaDesc: "Define o idioma da interface.",
            modalLucroTitle: "Configurações de Margem de Lucro (%)",
            modalLucroAltoLabel: "Mín. Lucro Alto (Verde):",
            modalLucroAltoDesc: "Margem mínima para cor verde (lucro alto).",
            modalLucroMedioLabel: "Mín. Lucro Médio (Amarelo):",
            modalLucroMedioDesc: "Margem mínima para cor amarela (lucro médio).",
            modalLucroBaixoLabel: "Mín. Lucro Baixo (Laranja):",
            modalLucroBaixoDesc: "Margem mínima para cor laranja (lucro baixo). Abaixo disso será vermelho.",
            modalBtnSalvar: "Salvar e Fechar",
            btnGerarPDF: "Gerar PDF",
            btnExportarCSV: "Exportar CSV"
        },
        "en-US": {
            mainTitle: "Import Cost Calculator",
            tabEntrada: "1. Data Entry",
            tabResultados: "2. Detailed Results",
            tabDashboard: "3. Dashboard & Summary",
            headingDadosGlobais: "Global Shipment Data",
            sepInfoOrganizacionais: "Organizational Information",
            labelNomeUsuario: "User Name:",
            descNomeUsuario: "Name of the person responsible for the calculation.",
            labelNomeFornecedor: "Supplier Name:",
            descNomeFornecedor: "Supplier of the products.",
            labelRefInterna: "Internal Ref. / PO Number:",
            descRefInterna: "Your internal control code/name or PO.",
            labelNumeroPI: "Proforma Invoice (PI) Number:",
            descNumeroPI: "Number of the Proforma Invoice.",
            labelDiProcesso: "DI/Process Number:",
            descDiProcesso: "Identifier of the DI or process.",
            labelDataCalculo: "Calculation/Shipment Date:",
            descDataCalculo: "Relevant date for this calculation.",
            sepDetalhesComerciais: "Commercial and Logistics Details",
            labelMoedaEstrangeira: "Active Foreign Currency:",
            descMoedaEstrangeira: "e.g., USD, EUR, CNY. Defines the currency for costs and exchange rate.",
            labelTaxaCambio: "Exchange Rate (BRL per 1 Unit of Active Currency):",
            descTaxaCambio: "Enter manually or use the buttons below.",
            labelIncoterm: "INCOTERM:",
            descIncoterm: "e.g., FOB, CIF. Defines responsibilities.",
            labelModalidadeTransporte: "Transport Mode:",
            descModalidadeTransporte: "e.g., Maritime, Air.",
            sepRegimeTributario: "Tax Regime and Credits",
            labelRegimeTributario: "Federal Tax Regime:",
            tooltipRegimeTributario: "Defines the company's tax regime, impacting tax credits. 'Lucro Real' allows more credits, while 'Simples Nacional' does not.",
            labelPercCreditoPIS: "% PIS Credit:",
            tooltipCreditoPIS: "Percentage of PIS credit to be used. Usually 100% for 'Lucro Real' and 0% for others.",
            labelPercCreditoCOFINS: "% COFINS Credit:",
            tooltipCreditoCOFINS: "Percentage of COFINS credit to be used. Usually 100% for 'Lucro Real' and 0% for others.",
            labelPercCreditoIPI: "% IPI Credit:",
            tooltipCreditoIPI: "Percentage of IPI credit. Usually 100% for industries under 'Lucro Real' and 0% for others.",
            labelPercCreditoICMS: "% ICMS Credit:",
            tooltipCreditoICMS: "Percentage of ICMS credit. Varies by state and tax benefits (TTD).",
            sepCustosGlobais: "Global Costs (Prorated among items)",
            labelTotalFreteME: "TOTAL Int. Freight ($):",
            descTotalFreteME: "Main freight in Foreign Currency.",
            labelTotalSeguroME: "TOTAL Int. Insurance ($):",
            descTotalSeguroME: "Cargo insurance in Foreign Currency.",
            labelTotalOutrasDespesasME: "TOTAL Other Origin Expenses ($):",
            descTotalOutrasDespesasME: "e.g., THC at origin, docs, domestic freight at origin.",
            labelTaxaSiscomexBRL: "TOTAL Siscomex Fee (BRL):",
            descTaxaSiscomexBRL: "Fee for using the Siscomex system.",
            labelDespesasAduaneirasBRL: "TOTAL Customs Expenses (BRL):",
            descDespesasAduaneirasBRL: "e.g., Customs broker, Storage, LI.",
            labelFreteNacionalBRL: "TOTAL Domestic Freight (BRL):",
            descFreteNacionalBRL: "Transport in Brazil to the final destination.",
            labelAliquotaAFRMM: "Global AFRMM Rate (%):",
            tooltipAFRMM: "Additional Freight for the Renewal of the Merchant Marine. Standard is 8% for maritime transport. Set to zero for other modes.",
            headingObservacoesGerais: "General Remarks",
            descObservacoesGerais: "This field is for your notes and does not affect calculations.",
            headingItensEmbarque: "Shipment Items",
            noteItensEmbarque: `Enter the rates for each item (e.g., 10 for 10%). Weight is for informational purposes. "Pr. Venda Unit. R$ Brasil" is the unit sale price.`,
            btnAdicionarItem: "Add New Item",
            btnCalcular: "Calculate Costs, Profit, and KPIs",
            btnLimparCampos: "Clear All Fields",
            confirmLimparCampos: "Are you sure you want to clear all fields? This action cannot be undone.",
            modalConfigTitle: "Settings",
            modalIdiomaTitle: "Language",
            modalIdiomaLabel: "Select Language:",
            modalIdiomaDesc: "Defines the interface language.",
            modalLucroTitle: "Profit Margin Settings (%)",
            modalLucroAltoLabel: "Min. High Profit (Green):",
            modalLucroAltoDesc: "Minimum margin for green color (high profit).",
            modalLucroMedioLabel: "Min. Medium Profit (Yellow):",
            modalLucroMedioDesc: "Minimum margin for yellow color (medium profit).",
            modalLucroBaixoLabel: "Min. Low Profit (Orange):",
            modalLucroBaixoDesc: "Minimum margin for orange color (low profit). Below this will be red.",
            modalBtnSalvar: "Save and Close",
            btnGerarPDF: "Generate PDF",
            btnExportarCSV: "Export CSV"
        }
    };

    function applyTranslations(lang) {
        if (!translations[lang]) return;
        
        document.querySelectorAll('[data-translate-key]').forEach(elem => {
            const key = elem.getAttribute('data-translate-key');
            if (translations[lang][key]) {
                // Handle different element types
                if (elem.tagName === 'INPUT' || elem.tagName === 'TEXTAREA') {
                    if (elem.placeholder) {
                        elem.placeholder = translations[lang][key];
                    }
                } else if (elem.classList.contains('tooltip-text')){
                     elem.textContent = translations[lang][key];
                } 
                else {
                    // This handles most text elements like span, h1, h2, button, p, etc.
                    const targetSpan = elem.querySelector('.tab-text') || elem;
                    // Check if the element contains a tooltip, to avoid overwriting it
                    const childNodes = Array.from(targetSpan.childNodes);
                    const textNode = childNodes.find(node => node.nodeType === Node.TEXT_NODE);
                    
                    if (textNode) {
                         textNode.nodeValue = translations[lang][key] + ' ';
                    } else if (targetSpan.children.length === 0 || !targetSpan.querySelector('.tooltip-container')) {
                        targetSpan.textContent = translations[lang][key];
                    } else {
                        // If it's a label with a tooltip, find the first text node to update
                        const firstNode = targetSpan.childNodes[0];
                        if (firstNode && firstNode.nodeType === Node.TEXT_NODE) {
                            firstNode.nodeValue = translations[lang][key];
                        }
                    }
                }
            }
        });

        document.documentElement.lang = lang;
        saveState();
    }


    // --- Tornar funções globalmente acessíveis ---
    window.calcularCustosMultiItem = calcularCustosMultiItem;
    window.gerarPDF = gerarPDF;
    window.exportTableToCSV = exportTableToCSV;
    window.limparTodosOsCampos = limparTodosOsCampos;
    window.showScreen = showScreen;
    window.updateCotacaoButtonLabel = updateCotacaoButtonLabel;
    window.fetchCotacaoMoeda = fetchCotacaoMoeda;
    window.handleRegimeChange = handleRegimeChange;
    window.updateItemCalculatedFields = updateItemCalculatedFields;
    window.shareDashboardViaWhatsApp = shareDashboardViaWhatsApp;
    window.removerLinhaItem = removerLinhaItem;
    window.carregarImpostosPadrao = carregarImpostosPadrao;
    window.renderizarGraficoCustos = renderizarGraficoCustos;
    window.applyTranslations = applyTranslations;

})();
</script>
</body>
</html>
